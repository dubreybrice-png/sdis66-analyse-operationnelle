<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
      :root {
        --bg-color: #f4f6f8;
        --text-color: #333;
        --card-bg: white;
        --header-bg: #1565c0;
        --border-color: #ddd;
        --table-header-bg: #eee;
        --table-header-text: #333;
        --input-bg: white;
        --input-text: #333;
        --section-bg: #f9f9f9;
        --zone-border: #1565c0;
      }

      body.dark-mode {
        --bg-color: #121212;
        --text-color: #e0e0e0;
        --card-bg: #1e1e1e;
        --header-bg: #0d47a1;
        --border-color: #333;
        --table-header-bg: #333;
        --table-header-text: #e0e0e0;
        --input-bg: #2c2c2c;
        --input-text: #e0e0e0;
        --section-bg: #252525;
        --zone-border: #42a5f5;
      }
      
      body { 
        font-family: 'Roboto', sans-serif; 
        background-color: var(--bg-color); 
        color: var(--text-color); 
        margin: 0; 
        padding: 0; 
        transition: background-color 0.3s; 
      }
      
      .top-header { 
        background-color: var(--header-bg); 
        color: white; 
        padding: 10px 20px; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
      }
      
      .header-actions { 
        display:flex; 
        gap:15px; 
        align-items:center; 
      }
      
      .header-btn {
        background: rgba(255,255,255,0.1); 
        color: white; 
        border: 1px solid rgba(255,255,255,0.5); 
        padding: 8px 15px; 
        border-radius: 4px; 
        cursor: pointer; 
        font-weight: 500; 
        font-size: 0.9rem; 
        transition: 0.2s; 
        display: flex; 
        align-items: center; 
        gap: 8px;
      }
      
      .header-btn:hover { 
        background: rgba(255,255,255,0.25); 
        border-color:white; 
      }

      #global-loader { 
        display: flex; 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(255,255,255,0.95); 
        z-index: 2000; 
        justify-content: center; 
        align-items: center; 
        flex-direction: column; 
        color:#1565c0;
      }
      
      .spinner { 
        border: 8px solid #f3f3f3; 
        border-top: 8px solid #1565c0; 
        border-radius: 50%; 
        width: 50px; 
        height: 50px; 
        animation: spin 1s linear infinite; 
        margin-bottom: 15px; 
      }
      
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      
      #error-box { 
        display: none; 
        background-color: #ffebee; 
        color: #c62828; 
        border: 1px solid #c62828; 
        padding: 20px; 
        border-radius: 8px; 
        margin-top: 20px; 
        max-width: 90%; 
        text-align: center; 
        font-size: 0.9rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      }

      .stats-bar { 
        background-color: #263238; 
        color: white; 
        padding: 12px 20px; 
        display: flex; 
        flex-wrap: wrap; 
        align-items: center; 
        justify-content: space-between; 
        font-size: 0.9rem; 
      }
      
      .container { padding: 20px; }
      
      .cat-header { 
        background-color: #546e7a; 
        color: white; 
        padding: 10px 15px; 
        font-weight: bold; 
        text-transform: uppercase; 
        border-radius: 4px 4px 0 0; 
        margin-top:20px; 
      }
      
      .grid-container { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
        gap: 15px; 
        background-color: var(--card-bg); 
        padding: 15px; 
        border: 1px solid var(--border-color); 
        border-top: none; 
        border-radius: 0 0 4px 4px; 
      }
      
      .card { 
        border-radius: 8px; 
        padding: 15px; 
        cursor: pointer; 
        color: white; 
        min-height: 110px; 
        display: flex; 
        flex-direction: column; 
        justify-content: space-between; 
        transition: transform 0.2s; 
        position: relative; 
        overflow: hidden; 
      }
      .card:hover { transform: translateY(-3px); }
      
      .card.status-red { background: linear-gradient(135deg, #f44336 0%, #e53935 100%); }
      .card.status-orange { background: linear-gradient(135deg, #ff9800 0%, #fb8c00 100%); }
      .card.status-green { background: linear-gradient(135deg, #4caf50 0%, #43a047 100%); }
      .card.status-purple { 
        background-color: #e1bee7; 
        color: #4a148c; 
        border: 2px solid #7b1fa2;
        text-decoration: line-through;
      }
      .card.status-purple::after {
        content: "‚ö†Ô∏è P√âRIM√â";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-15deg);
        font-size: 1.5rem;
        font-weight: 900;
        color: #4a148c;
        opacity: 0.3;
        z-index: 1;
      }
      .card.status-hs { 
        display: none !important;
      }
      
      .card-title { font-weight: 700; font-size: 1.1rem; z-index: 2; position:relative; }
      .card-info { font-size: 0.85rem; opacity: 0.95; z-index: 2; position:relative; }
      .card-extra { 
        font-size: 0.75rem; 
        text-align: right; 
        margin-top: 5px; 
        font-weight: bold; 
        color: inherit; 
        z-index: 2; 
        position: relative; 
        border-top: 1px solid rgba(0,0,0,0.1); 
        padding-top:5px;
      }
      
      .qr-icon { 
        position: absolute; 
        top: 5px; 
        right: 5px; 
        background: white; 
        padding: 4px; 
        border-radius: 4px; 
        width: 28px; 
        height: 28px; 
        z-index: 100; 
        cursor: pointer; 
        opacity: 0.9; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
        transition: transform 0.2s; 
      }
      .qr-icon:hover { transform: scale(1.1); opacity: 1; }

      .check-zone {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: 2px solid #1976d2;
        border-radius: 8px;
        margin-bottom: 20px;
        overflow: hidden;
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
      }
      
      .check-zone-header {
        background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
        color: white;
        padding: 12px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .zone-title {
        font-weight: bold;
        font-size: 1.1rem;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        flex: 1 1 auto;
        min-width: 0;
      }
      
      .zone-pos {
        font-size: 0.9rem;
        background: rgba(255,255,255,0.3);
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 500;
      }
      
      .check-zone-content {
        padding: 10px 15px;
        background: white;
      }
      
      .form-row { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 10px 0; 
        border-bottom: 1px solid #e0e0e0; 
      }
      .form-row:last-child { border-bottom: none; }
      .form-row label { 
        flex: 1; 
        font-weight: 500; 
        font-size: 0.95rem; 
      }

      #admin-view { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; color: var(--text-color); }
      
      .admin-nav { 
        display: flex; gap: 10px; margin-bottom: 20px; 
        border-bottom: 2px solid var(--border-color); 
        padding-bottom: 10px; flex-wrap:wrap;
      }
      
      .nav-btn { 
        padding: 10px 20px; background: #eee; 
        border: none; border-radius: 4px; 
        cursor: pointer; font-weight: bold; 
        color: #555; transition: 0.2s; 
      }
      .nav-btn:hover { background: #ddd; }
      .nav-btn.active { background: #1565c0; color: white; }
      
      .admin-tab { display: none; animation: fadeIn 0.3s; }
      .admin-tab.active { display: block; }
      
      .admin-card { 
        background: var(--card-bg); 
        padding: 20px; border-radius: 8px; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        margin-bottom: 20px; 
        border: 1px solid var(--border-color); 
      }
      
      .admin-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; color: #1565c0; }
      
      .admin-btn { 
        background: #1565c0; color: white; 
        border: none; padding: 8px 15px; 
        border-radius: 4px; cursor: pointer; font-size:0.9rem;
      }
      .admin-btn.secondary { background: #78909c; }
      .admin-btn.success { background: #43a047; }
      .admin-btn.danger { background: #d32f2f; }
      
      .inv-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; color: var(--text-color); }
      .inv-table th { text-align: left; background: var(--table-header-bg); padding: 10px; border-bottom: 2px solid #ddd; color: var(--table-header-text); }
      .inv-table td { padding: 8px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
      
      input, select, textarea { 
        background-color: var(--input-bg); 
        color: var(--input-text); 
        border: 1px solid var(--border-color); 
        padding: 5px; border-radius: 4px; 
      }
      
      .cat-row { 
        display: flex; 
        align-items: center; 
        gap: 10px; 
        padding: 10px; 
        background: #f5f5f5; 
        border-radius: 4px; 
        margin-bottom: 8px; 
      }

      .section-block { 
        background: #f1f3f4; 
        border: 1px solid #ddd; 
        border-radius: 8px; 
        margin-bottom: 20px; 
        overflow: hidden; 
        color:#333; 
      }
      .section-header { 
        background: #e0e0e0; 
        padding: 10px; 
        display: flex; 
        align-items: center; 
        gap: 15px; 
        border-bottom:1px solid #ccc;
      }
      .section-header-inputs {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        gap: 5px;
      }
      .sec-name { font-weight: bold; font-size: 1rem; padding: 5px; }
      .sec-pos { font-size: 0.9rem; color: #555; padding: 5px; }
      
      .items-list-header {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 30px;
        gap: 5px;
        padding: 8px;
        background: #d0d0d0;
        font-weight: bold;
        font-size: 0.85rem;
        border-bottom: 1px solid #ccc;
      }
      
      .item-row { 
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 30px;
        gap: 5px;
        align-items: center; 
        background: white; 
        border-bottom: 1px solid #eee; 
        padding: 8px;
      }
      
      .i-name { padding: 5px; }
      .i-type { padding: 5px; }
      .i-def { padding: 5px; }

      .modal-overlay { 
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; 
      }
      .modal { 
        background: var(--card-bg); color: var(--text-color); 
        border-radius: 8px; width: 95%; max-width: 650px; max-height: 90vh; 
        display: flex; flex-direction: column; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      }
      .modal-header { 
        padding: 15px; background: #f8f9fa; 
        border-bottom: 1px solid #eee; 
        display: flex; justify-content: space-between; color:#333; align-items: center; 
      }
      .modal-body { padding: 20px; overflow-y: auto; }
      .modal-footer { padding: 15px; border-top: 1px solid #eee; text-align: right; background: #f8f9fa; }
      
      .switch { position: relative; display: inline-block; width: 60px; height: 28px; vertical-align:middle; margin-right:10px; }
      .switch input { opacity: 0; width: 0; height: 0; }
      .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
      .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
      input:checked + .slider { background-color: #1565c0; }
      input:checked + .slider:before { transform: translateX(32px); }
      
      .stat-bar-container { width: 100%; background: #eee; height: 20px; border-radius: 10px; overflow: hidden; margin: 5px 0; }
      .stat-bar-fill { height: 100%; line-height: 20px; color: white; text-align: center; font-size: 0.75rem; }
      
      .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 8px;
        border-bottom: 1px solid #eee;
      }
      .detail-row:nth-child(even) { background: #f9f9f9; }
      .detail-label { font-weight: bold; color: #1565c0; flex: 1; }
      .detail-value { color: #333; flex: 1; text-align: right; }
    </style>
  </head>
  <body>

    <div id="global-loader">
      <div class="spinner"></div>
      <div style="font-weight:bold;">Chargement...</div>
      
      <div id="error-box">
        <h3 style="margin-top:0;">‚ö†Ô∏è Probl√®me de chargement</h3>
        <p>Le script ne r√©pond pas. Cela arrive souvent sur Chrome.</p>
        <p style="font-size:0.9rem;">Solutions :</p>
        <ul style="text-align:left; font-size:0.9rem;">
          <li>Videz le cache du navigateur</li>
          <li>Essayez en Navigation Priv√©e</li>
          <li>V√©rifiez que vous n'√™tes pas connect√© √† plusieurs comptes Google</li>
        </ul>
        <button class="header-btn" style="background:#d32f2f; margin-top:10px; width:100%; justify-content:center;" onclick="forceReload()">üîÑ Forcer le rechargement</button>
        <div id="tech-error" style="margin-top:15px; font-family:monospace; font-size:0.8em; color:#333; background:#fff; padding:5px; border:1px solid #ccc;"></div>
      </div>
    </div>

    <div class="top-header">
      <div class="header-actions">
        <h1>V√©rifications</h1>
      </div>
      <div class="header-actions">
        <button id="theme-toggle" class="header-btn" onclick="toggleDarkMode()">üåô Mode Nuit</button>
        <button onclick="toggleAdmin()" class="header-btn">‚öôÔ∏è Admin</button>
      </div>
    </div>

    <div id="dashboard-view">
      <div class="stats-bar">
        <div style="display:flex; gap:15px; flex-wrap:wrap;">
           <span style="color:#4caf50; font-weight:bold;">üü¢ V√©rif' OK</span>
           <span style="color:#ff9800; font-weight:bold;">üü† V√©rif' limite dans - 1 semaine</span>
           <span style="color:#f44336; font-weight:bold;">üî¥ Date limite v√©rif' d√©pass√©e</span>
           <span style="color:#9c27b0; font-weight:bold; display:none;" id="leg-purple">üü£ Objet P√©rim√©</span>
        </div>
      </div>
      <div id="app" class="container"></div>
    </div>

    <div id="admin-view">
      <div class="admin-nav">
        <button class="nav-btn" onclick="backToDashboard()" style="background:#ff9800; color:white;">üè† Dashboard</button>
        <button class="nav-btn active" onclick="showTab('tab-inv')">1. Inventaire</button>
        <button class="nav-btn" onclick="showTab('tab-conf')">2. Config</button>
        <button class="nav-btn" onclick="showTab('tab-content')">3. Contenu</button>
        <button class="nav-btn" onclick="showTab('tab-history')">4. Historique</button>
        <button class="nav-btn" onclick="showTab('tab-stats')">5. Stats</button>
        <button class="nav-btn" onclick="showTab('tab-mailing')">6. Mailing</button>
        <button class="nav-btn" onclick="showTab('tab-opts')">‚öôÔ∏è Options</button>
      </div>
      
      <div id="tab-inv" class="admin-tab active">
         <div class="admin-card">
           <div class="admin-title">Gestion des Sacs</div>
           <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
             <select id="new-bag-cat" style="padding:8px; border-radius:4px;"></select>
             <input id="new-bag-name" placeholder="Nom du sac" style="padding:8px; flex-grow:1;">
             <button class="admin-btn success" onclick="addBag()">+ Ajouter</button>
           </div>
           <table class="inv-table">
             <thead><tr><th>Cat√©gorie</th><th>Nom</th><th>Mails Orange</th><th>Mails Rouge</th><th>Action</th></tr></thead>
             <tbody id="inv-body"></tbody>
           </table>
           <p style="font-size:0.85rem; color:#999; margin-top:10px;">üí° S√©parez les adresses email par <b>;</b> | Les placeholders s'effacent automatiquement √† la saisie</p>
         </div>
      </div>
      
      <div id="tab-conf" class="admin-tab">
         <div class="admin-card">
           <div class="admin-title">Cat√©gories & Fr√©quences (en jours)</div>
           <div style="margin-bottom:15px; display:flex; gap:10px;">
             <input id="new-cat-name" placeholder="Nouvelle Cat√©gorie" style="flex-grow:1;">
             <button class="admin-btn success" onclick="addCat()">Cr√©er</button>
           </div>
           <div id="cat-conf"></div>
           <button class="admin-btn" onclick="saveCatConf()" style="margin-top:15px;">Enregistrer les Fr√©quences</button>
         </div>
      </div>

      <div id="tab-content" class="admin-tab">
         <div class="admin-card">
           <div class="admin-title">√âditeur de Checklists</div>
           <select id="cat-selector" onchange="renderEditor()" style="width:100%; padding:10px; margin-bottom:15px; font-size:1rem;"></select>
           
           <div id="editor-container"></div>
           
           <div style="display:flex; gap:10px; margin-top:20px;">
             <button class="admin-btn secondary" style="flex:1;" onclick="addSection()">+ Ajouter une Section</button>
             <button class="admin-btn success" style="flex:1;" onclick="saveEditor()">üíæ Sauvegarder</button>
           </div>
         </div>
      </div>

      <div id="tab-history" class="admin-tab">
         <div class="admin-card">
           <div class="admin-title">Historique des Contr√¥les</div>
           <table class="inv-table">
             <thead><tr><th>Date</th><th>Nom</th><th>V√©rificateur</th><th style="text-align:right;">Actions</th></tr></thead>
             <tbody id="hist-body"></tbody>
           </table>
         </div>
      </div>

      <div id="tab-stats" class="admin-tab">
         <div class="admin-card">
           <div class="admin-title">Statistiques</div>
           <div id="stats-container">Chargement...</div>
         </div>
      </div>

      <div id="tab-mailing" class="admin-tab">
         <div class="admin-card">
           <div class="admin-title">Configuration Alertes Mails</div>
           
           <h4>üìß Alerte Orange (√âch√©ance proche)</h4>
           <label>Sujet :</label>
           <input id="mailOrangeSub2" style="width:100%; margin-bottom:10px;" value="[ALERTE] V√©rification du mat√©riel en retard - Action requise">
           <label>Corps du message :</label>
           <textarea id="mailOrangeBody2" rows="6" style="width:100%; margin-bottom:20px;">Bonjour,

Je vous contacte pour vous informer que la v√©rification du mat√©riel "{nom}" arrive √† sa date limite.

üìÖ INFORMATIONS IMPORTANTES :
‚Ä¢ Cat√©gorie : {categorie}
‚Ä¢ Derni√®re v√©rification : {date}
‚Ä¢ √âch√©ance de v√©rification : {echeance}

‚ö†Ô∏è SITUATION : Le d√©lai de v√©rification approche. Vous disposez de tr√®s peu de temps avant que ce mat√©riel ne soit d√©clar√© P√âRIM√â.

ACTION REQUISE :
Veuillez effectuer la v√©rification d√®s que possible (dans les 7 prochains jours) et mettre √† jour le statut dans l'application.

Une nouvelle alerte plus urgente vous sera envoy√©e si la v√©rification n'est pas effectu√©e √† temps.

Merci de votre attention et de votre r√©activit√©.
Cordialement</textarea>
           
           <h4>üö® Alerte Rouge (P√©rim√©)</h4>
           <label>Sujet :</label>
           <input id="mailRedSub2" style="width:100%; margin-bottom:10px;" value="[URGENT] Mat√©riel p√©rim√© - Mise hors service imm√©diate requise">
           <label>Corps du message :</label>
           <textarea id="mailRedBody2" rows="6" style="width:100%; margin-bottom:10px;">Bonjour,

üö® ALERTE CRITIQUE : Le mat√©riel "{nom}" EST P√âRIM√â ET NE DOIT PLUS √äTRE UTILIS√â ! üö®

üìÖ INFORMATIONS CRITIQUES :
‚Ä¢ Cat√©gorie : {categorie}
‚Ä¢ Date limite de v√©rification d√©pass√©e depuis : {echeance}
‚Ä¢ Derni√®re v√©rification : {date}
‚Ä¢ STATUT ACTUEL : ‚ö†Ô∏è P√âRIM√â - NON CONFORME POUR L'UTILISATION OP√âRATIONNELLE

üõë INTERDICTION D'UTILISATION :
Ce mat√©riel ne peut ABSOLUMENT PAS √™tre utilis√© en op√©ration tant qu'il n'aura pas √©t√© rev√©rifi√© et valid√©.

‚ö° ACTIONS OBLIGATOIRES (√Ä EFFECTUER D'URGENCE) :
1. Isoler ou mettre hors service le mat√©riel imm√©diatement
2. Effectuer une v√©rification compl√®te d√®s aujourd'hui (si possible dans les 24 heures)
3. Valider la v√©rification dans l'application sans d√©lai
4. Notifier votre hi√©rarchie de cette situation de non-conformit√©

‚ùå NE PAS IGNORER : Ce mat√©riel est en situation de non-conformit√© critique.

Pour toute question ou besoin d'assistance, veuillez contacter imm√©diatement le responsable.

Merci de traiter cette demande en urgence absolue.
Cordialement</textarea>
           
           <p style="font-size:0.85rem; color:#666;">Variables : {nom}, {categorie}, {date}, {echeance}</p>
           
           <button class="admin-btn success" onclick="saveMailConfDirect()">üíæ Sauvegarder Configuration</button>
           
           <hr style="margin:30px 0;">
           
           <div class="admin-title">‚è∞ D√©clencheur Automatique</div>
           <p>Heure d'envoi quotidien des alertes :</p>
           <input type="number" id="trigger-hour" min="0" max="23" value="8" style="width:60px; padding:8px;"> h00
           <br><br>
           <button class="admin-btn" onclick="installTriggerUI()">üîî Activer Automatisation</button>
         </div>
      </div>

      <div id="tab-opts" class="admin-tab">
         <div class="admin-card">
           <div class="admin-title">Options Globales</div>
           
           <div style="margin-bottom:20px;">
             <label class="switch"><input type="checkbox" id="opt-exp"><span class="slider"></span></label>
             <b>Suivi de la P√©remption Objet</b>
             <p style="margin:5px 0 0 60px; font-size:0.85rem; color:#666;">Active le champ date de p√©remption et l'alerte violette.</p>
           </div>

           <div style="margin-bottom:20px;">
             <label class="switch"><input type="checkbox" id="opt-qr"><span class="slider"></span></label>
             <b>G√©n√©rateur QR Code</b>
             <p style="margin:5px 0 0 60px; font-size:0.85rem; color:#666;">Affiche l'ic√¥ne QR sur les cartes.</p>
           </div>

           <div style="margin-bottom:20px;">
             <label class="switch"><input type="checkbox" id="opt-verif"><span class="slider"></span></label>
             <b>Identification Obligatoire</b>
             <p style="margin:5px 0 0 60px; font-size:0.85rem; color:#666;">Force la saisie du nom du v√©rificateur.</p>
           </div>

           <button class="admin-btn success" onclick="saveOptions()">Sauvegarder les Options</button>
         </div>
      </div>
    </div>

    <div id="chkModal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h3 id="m-title" style="margin:0; color:#1565c0;">Titre</h3>
          <span onclick="closeM('chkModal')" style="cursor:pointer; font-size:1.5rem;">&times;</span>
        </div>
        <div class="modal-body" id="m-body"></div>
        <div class="modal-footer">
           <div id="extra-fields" style="text-align:left; background:#e3f2fd; padding:10px; margin-bottom:10px; border-radius:4px; display:none;">
              <b style="color:#1565c0;">‚ö†Ô∏è Info P√©remption (Prochain objet)</b><br> 
              <div style="display:flex; gap:10px; margin-top:5px;">
                <input id="next-item" placeholder="Nom de l'objet" style="flex:1;"> 
                <input type="date" id="next-date">
              </div>
           </div>
           
           <div id="verif-field" style="text-align:left; margin-bottom:15px; display:none;">
              <b>üë§ Nom du v√©rificateur :</b> 
              <input id="verif-name" style="width:100%; margin-top:5px; padding:8px;">
           </div>
           
           <button class="admin-btn success" style="width:100%; font-size:1.1rem; padding:12px;" onclick="submitCheck()">Valider le contr√¥le</button>
        </div>
      </div>
    </div>

    <div id="qrModal" class="modal-overlay" onclick="closeM('qrModal')">
       <div class="modal" style="width:320px; text-align:center;" onclick="event.stopPropagation()">
          <div class="modal-header" style="justify-content:center;">
            <h3>QR Code</h3>
          </div>
          <div class="modal-body" style="text-align:center;">
            <h4 id="qrTitle" style="margin-top:0; color:#1565c0;"></h4>
            <img id="qr-img" style="width:200px; height:200px; border:1px solid #ddd; padding:10px;">
            <p style="font-size:0.85rem; color:#666;">Scannez pour acc√©der directement.</p>
            
            <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
               <button class="admin-btn success" onclick="downloadQR()">üì• T√©l√©charger</button>
               <button class="admin-btn secondary" onclick="printQR()">üñ®Ô∏è Imprimer</button>
            </div>
          </div>
       </div>
    </div>

    <div id="histModal" class="modal-overlay" onclick="closeM('histModal')">
       <div class="modal" onclick="event.stopPropagation()">
          <div class="modal-header">
            <h3 id="hist-title" style="margin:0; color:#1565c0;">D√©tail V√©rification</h3>
            <span onclick="closeM('histModal')" style="cursor:pointer; font-size:1.5rem;">&times;</span>
          </div>
          <div class="modal-body" id="hist-detail"></div>
       </div>
    </div>

    <script>
      let D = {}; 
      let APP_URL = ""; 
      let CURR = null; 
      let IS_ADM = false;

      setTimeout(function() {
         if(document.getElementById('global-loader').style.display !== 'none') {
            document.getElementById('error-box').style.display = 'block';
         }
      }, 10000);

      window.onload = function() { 
        google.script.run.withSuccessHandler(u => { 
          APP_URL=u; 
          loadData(); 
        }).getAppUrl(); 
      };

      function forceReload() { 
        window.open(APP_URL, '_top'); 
      }

      function loadData() {
        document.querySelector('.spinner').style.display = 'block';
        document.getElementById('error-box').style.display = 'none';

        google.script.run
          .withSuccessHandler(res => {
             if (res.success) {
               D = res.data; 
               render();
               document.getElementById('global-loader').style.display = 'none';
             } else {
               document.getElementById('error-box').style.display = 'block';
               document.getElementById('tech-error').innerText = res.error;
             }
          })
          .withFailureHandler(err => {
             document.getElementById('error-box').style.display = 'block';
             document.getElementById('tech-error').innerText = err.message;
          })
          .getData();
      }

      function render() {
        document.getElementById('leg-purple').style.display = D.options.enableExpiry ? 'inline' : 'none';
        document.getElementById('opt-exp').checked = D.options.enableExpiry;
        document.getElementById('opt-qr').checked = D.options.enableQR;
        document.getElementById('opt-verif').checked = D.options.enableVerifier;

        const app = document.getElementById('app'); 
        app.innerHTML = "";
        
        D.categoriesOrder.forEach(cat => {
           if(!D.dashboard[cat]) return;
           app.innerHTML += `<div class="cat-header">${cat}</div>`;
           
           const grid = document.createElement('div'); 
           grid.className = 'grid-container';
           
           D.dashboard[cat].forEach(item => {
              if(item.state === 'HS') return;
              
              const div = document.createElement('div');
              div.className = `card status-${item.status}`;
              
              let html = `<div class="card-title">${item.name}</div>`;
              html += `<div class="card-info">Dernier: ${item.lastDate}<br>Prochain: ${item.nextDate}</div>`;
              
              if(D.options.enableExpiry && item.nextItemName) {
                 html += `<div class="card-extra">P√©remption ${item.nextItemName}: ${item.nextItemDate}</div>`;
              }
              if(D.options.enableVerifier && item.lastVerifier) {
                 html += `<div class="card-extra" style="border-top:none; color:inherit; opacity:0.8;">üë§ ${item.lastVerifier}</div>`;
              }

              div.innerHTML = html;
              
              // Cr√©er le QR icon si activ√©
              if(D.options.enableQR) {
                 const qrIcon = document.createElement('div');
                 qrIcon.className = 'qr-icon';
                 qrIcon.innerHTML = 'üì±';
                 qrIcon.onclick = function(e) {
                   e.stopPropagation();
                   e.preventDefault();
                   showQR(item.name);
                 };
                 div.appendChild(qrIcon);
              }
              
              // Clic sur la carte = ouvrir checklist
              div.onclick = function(e) {
                // Si on a cliqu√© sur ou dans le QR icon, ne rien faire
                if(e.target.closest('.qr-icon')) {
                  return;
                }
                console.log('Ouverture checklist pour:', item.name);
                openCheck(item);
              };
              
              grid.appendChild(div);
           });
           app.appendChild(grid);
        });
        
        const sel = document.getElementById('new-bag-cat'); sel.innerHTML = "";
        const sel2 = document.getElementById('cat-selector'); sel2.innerHTML = "";
        D.categoriesOrder.forEach(c => {
           sel.innerHTML += `<option>${c}</option>`;
           sel2.innerHTML += `<option>${c}</option>`;
        });

        renderAdmin();
        renderStats();
        renderEditor();
      }

      function openCheck(item) {
        CURR = item;
        document.getElementById('m-title').innerText = item.name;
        document.getElementById('chkModal').style.display = 'flex';
        
        document.getElementById('extra-fields').style.display = D.options.enableExpiry ? 'block' : 'none';
        document.getElementById('verif-field').style.display = D.options.enableVerifier ? 'block' : 'none';
        document.getElementById('next-item').value = item.nextItemName || "";
        document.getElementById('verif-name').value = "";
        
        const body = document.getElementById('m-body');
        body.innerHTML = "";
        
        const struct = D.forms[item.category];
        if(struct) {
           struct.forEach(sec => {
              let posHtml = sec.position ? `<span class="zone-pos">${sec.position}</span>` : "";
              
              let html = `<div class="check-zone">`;
              html += `<div class="check-zone-header">
                         <span class="zone-title">${sec.section}</span>
                         ${posHtml}
                       </div>`;
              html += `<div class="check-zone-content">`;
              
              sec.items.forEach(it => {
                 let field = "";
                 if(it.type == 'case') {
                   field = `<label class="switch" style="margin:0;"><input type="checkbox" data-id="${it.name}" ${it.def===true?'checked':''}><span class="slider"></span></label>`;
                 } else {
                   field = `<input data-id="${it.name}" value="${it.def}" style="width:100px; padding:8px;">`;
                 }
                 html += `<div class="form-row"><label>${it.name}</label>${field}</div>`;
              });
              
              html += `</div></div>`;
              body.innerHTML += html;
           });
        } else {
           body.innerHTML = "<p style='text-align:center; color:#666;'>Aucune checklist configur√©e pour cette cat√©gorie.</p>";
        }
      }

      function submitCheck() {
         const verif = document.getElementById('verif-name').value;
         const nItem = document.getElementById('next-item').value;
         const nDate = document.getElementById('next-date').value;

         if(D.options.enableVerifier && !verif) return alert("Le nom du v√©rificateur est obligatoire.");
         if(D.options.enableExpiry && (!nItem || !nDate)) return alert("Les informations de p√©remption sont obligatoires.");

         let data = {};
         document.querySelectorAll('#m-body input').forEach(i => {
            if(i.type == 'checkbox') {
               data[i.getAttribute('data-id')] = i.checked ? "Oui" : "Non";
            } else {
               data[i.getAttribute('data-id')] = i.value;
            }
         });

         document.getElementById('chkModal').style.display = 'none';
         document.getElementById('global-loader').style.display = 'flex';
         
         google.script.run.withSuccessHandler(loadData).saveCheck(CURR.name, data, nItem, nDate, verif);
      }

      function renderEditor() {
         const cat = document.getElementById('cat-selector').value;
         const c = document.getElementById('editor-container'); 
         c.innerHTML='';
         
         if(D.forms[cat]) {
             D.forms[cat].forEach(sec => {
                 let html = `<div class="section-block">
                   <div class="section-header">
                     <div class="section-header-inputs">
                       <input class="sec-name" value="${sec.section}" placeholder="Nom de la section">
                       <input class="sec-pos" value="${sec.position || ''}" placeholder="Position (ex: Porti√®re Droite)">
                     </div>
                     <button onclick="this.parentElement.parentElement.remove()" style="background:#d32f2f; color:white; border:none; border-radius:4px; padding:5px 10px;">Suppr</button>
                   </div>
                   <div class="items-list-header">
                     <div>Nom de l'item</div>
                     <div>Type</div>
                     <div>Valeur d√©faut</div>
                     <div></div>
                   </div>
                   <div class="items-list">`;
                 
                 sec.items.forEach(i => {
                    html += `<div class="item-row">
                      <input class="i-name" value="${i.name}" placeholder="Nom Item">
                      <select class="i-type">
                        <option value="texte" ${i.type=='texte'?'selected':''}>texte</option>
                        <option value="case" ${i.type=='case'?'selected':''}>case</option>
                      </select>
                      <input class="i-def" value="${i.def}" placeholder="Val. D√©faut">
                      <button onclick="this.parentElement.remove()" style="color:red; border:none; background:none; cursor:pointer; font-size:1.2rem;">&times;</button>
                    </div>`;
                 });
                 html += `</div><div style="padding:10px; text-align:center; border-top:1px solid #ddd;"><button class="admin-btn secondary" onclick="addItem(this)">+ Ajouter un Item</button></div></div>`;
                 c.innerHTML += html;
             });
         }
      }
      
      function saveEditor() {
         const cat = document.getElementById('cat-selector').value;
         let data = [];
         document.querySelectorAll('.section-block').forEach(blk => {
            let section = blk.querySelector('.sec-name').value;
            let position = blk.querySelector('.sec-pos').value;
            
            blk.querySelectorAll('.item-row').forEach(row => {
               data.push({
                  section: section,
                  position: position,
                  item: row.querySelector('.i-name').value,
                  type: row.querySelector('.i-type').value,
                  def: row.querySelector('.i-def').value
               });
            });
         });
         
         if(confirm("Sauvegarder les modifications pour " + cat + " ?")) {
           document.getElementById('global-loader').style.display = 'flex';
           google.script.run.withSuccessHandler(() => { alert("Sauvegard√© !"); loadData(); }).updateCategoryContent(cat, data);
         }
      }
      
      function addSection() {
         const c = document.getElementById('editor-container');
         c.innerHTML += `<div class="section-block">
           <div class="section-header">
             <div class="section-header-inputs">
               <input class="sec-name" value="Nouvelle Section" placeholder="Nom">
               <input class="sec-pos" placeholder="Position (Facultatif)">
             </div>
             <button onclick="this.parentElement.parentElement.remove()" style="background:#d32f2f; color:white; border:none; border-radius:4px; padding:5px 10px;">Suppr</button>
           </div>
           <div class="items-list-header">
             <div>Nom de l'item</div>
             <div>Type</div>
             <div>Valeur d√©faut</div>
             <div></div>
           </div>
           <div class="items-list"></div>
           <div style="padding:10px; text-align:center; border-top:1px solid #ddd;">
             <button class="admin-btn secondary" onclick="addItem(this)">+ Item</button>
           </div>
         </div>`;
      }
      
      function addItem(btn) {
         btn.parentElement.parentElement.querySelector('.items-list').innerHTML += `<div class="item-row">
           <input class="i-name" placeholder="Item">
           <select class="i-type">
             <option value="texte">texte</option>
             <option value="case">case</option>
           </select>
           <input class="i-def" placeholder="D√©faut">
           <button onclick="this.parentElement.remove()" style="color:red; border:none; background:none; cursor:pointer; font-size:1.2rem;">&times;</button>
         </div>`;
      }

      function showQR(name) {
         const url = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(APP_URL + "?bag=" + name)}`;
         document.getElementById('qrTitle').innerText = name;
         document.getElementById('qr-img').src = url;
         document.getElementById('qr-img').setAttribute('data-url', url);
         document.getElementById('qr-img').setAttribute('data-name', name);
         document.getElementById('qrModal').style.display = 'flex';
      }
      
      function downloadQR() {
         const img = document.getElementById('qr-img');
         const url = img.getAttribute('data-url');
         const name = img.getAttribute('data-name');
         
         fetch(url)
           .then(resp => resp.blob())
           .then(blob => {
             const link = document.createElement('a');
             link.href = URL.createObjectURL(blob);
             link.download = `QR_${name}.png`;
             link.click();
           })
           .catch(err => alert("Erreur t√©l√©chargement: " + err));
      }
      
      function printQR() {
         const img = document.getElementById('qr-img');
         const title = document.getElementById('qrTitle').innerText;
         const src = img.src;
         
         let win = window.open('', '', 'height=600,width=600');
         win.document.write(`<html><head><title>QR - ${title}</title></head>`);
         win.document.write(`<body style="text-align:center; font-family:sans-serif; padding-top:50px;">`);
         win.document.write(`<h1>${title}</h1>`);
         win.document.write(`<img src="${src}" width="300" onload="setTimeout(() => { window.print(); }, 500);" onerror="alert('Erreur chargement image. R√©essayez.')">`);
         win.document.write(`<p>Scannez pour v√©rifier ce sac.</p></body></html>`);
         win.document.close();
      }

      function openHistoryDetail(idx) {
         const h = D.history[idx];
         document.getElementById('hist-title').innerText = `${h.name} (${h.dateStr})`;
         
         let html = `<div style="margin-bottom:15px; padding:10px; background:#e3f2fd; border-radius:4px;">
           <b>üë§ V√©rifi√© par :</b> ${h.verifier || 'Non renseign√©'}<br>
           <b>üìÖ Date :</b> ${h.dateStr}
         </div>`;
         
         if(h.details.startsWith("{")) {
            try {
              const parts = h.details.split(" || ");
              let j = JSON.parse(parts[0]);
              
              for(let k in j) {
                html += `<div class="detail-row">
                  <span class="detail-label">${k}</span>
                  <span class="detail-value">${j[k]}</span>
                </div>`;
              }
              
              if(parts.length > 1) {
                html += `<div style="background:#fff3cd; padding:10px; margin-top:15px; border-radius:4px; border-left:4px solid #ffc107;">
                  <b>‚ö†Ô∏è ${parts[1]}</b>
                </div>`;
              }
            } catch(e) {
              html += `<p>${h.details}</p>`;
            }
         } else {
            html += `<p>${h.details}</p>`;
         }
         
         document.getElementById('hist-detail').innerHTML = html;
         document.getElementById('histModal').style.display = 'flex';
      }
      
      function closeM(id) { document.getElementById(id).style.display = 'none'; }
      
      function toggleDarkMode() { 
        document.body.classList.toggle('dark-mode'); 
        const btn = document.getElementById('theme-toggle');
        btn.innerText = document.body.classList.contains('dark-mode') ? "‚òÄÔ∏è Mode Jour" : "üåô Mode Nuit";
      }
      
      function toggleAdmin() {
         if(!IS_ADM) { 
           if(prompt("Mot de passe administrateur ?")!=="66000") { 
             alert("Mot de passe incorrect."); 
             return; 
           } 
           IS_ADM=true; 
         }
         document.getElementById('dashboard-view').style.display = 'none';
         document.getElementById('admin-view').style.display = 'block';
         document.querySelector('.top-header h1').innerText = "Administration";
      }
      
      function backToDashboard() {
        document.getElementById('admin-view').style.display = 'none';
        document.getElementById('dashboard-view').style.display = 'block';
        document.querySelector('.top-header h1').innerText = 'V√©rifications';
      }
      
      function showTab(id) {
         document.querySelectorAll('.admin-tab').forEach(e=>e.classList.remove('active'));
         document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
         document.getElementById(id).classList.add('active');
         const map = {'tab-inv':1, 'tab-conf':2, 'tab-content':3, 'tab-history':4, 'tab-stats':5, 'tab-mailing':6, 'tab-opts':7};
         document.querySelectorAll('.nav-btn')[map[id]].classList.add('active');
         if(id === 'tab-stats') renderStats();
      }
      
      function saveOptions() {
         const o = {
            enableExpiry: document.getElementById('opt-exp').checked,
            enableQR: document.getElementById('opt-qr').checked,
            enableVerifier: document.getElementById('opt-verif').checked
         };
         google.script.run.withSuccessHandler(() => { alert("Options sauvegard√©es !"); loadData(); }).saveGlobalOptions(o);
      }
      
      function saveMailConfDirect() {
         const config = {
           orangeSub: document.getElementById('mailOrangeSub2').value,
           orangeBody: document.getElementById('mailOrangeBody2').value,
           redSub: document.getElementById('mailRedSub2').value,
           redBody: document.getElementById('mailRedBody2').value
         };
         google.script.run.withSuccessHandler(() => {
           alert("Configuration mails sauvegard√©e !");
           loadData();
         }).saveMailConfig(config);
      }
      
      function installTriggerUI() {
         const hour = document.getElementById('trigger-hour').value;
         google.script.run.withSuccessHandler(msg => {
           alert(msg);
         }).installTrigger(hour);
      }
      
      function updateMail(input) {
        const bag = input.getAttribute('data-bag');
        const type = input.getAttribute('data-type');
        const value = input.value;
        
        const item = D.inventory.find(i => i.name === bag);
        if(item) {
          if(type === 'orange') item.mailOrange = value;
          if(type === 'red') item.mailRed = value;
        }
        
        clearTimeout(window.mailUpdateTimeout);
        window.mailUpdateTimeout = setTimeout(() => {
          google.script.run.withSuccessHandler(() => {
            console.log('Emails sauvegard√©s');
          }).updateBagMails(bag, type, value);
        }, 1000);
      }
      
      function renderAdmin() {
         const hb = document.getElementById('hist-body'); hb.innerHTML="";
         D.history.forEach((h, idx) => {
            hb.innerHTML += `<tr>
              <td>${h.dateStr}</td>
              <td><b>${h.name}</b></td>
              <td>${h.verifier}</td>
              <td style="text-align:right;">
                <button class="admin-btn" style="font-size:0.8rem; padding:5px;" onclick="openHistoryDetail(${idx})">üëÅÔ∏è Consulter</button>
                <button class="admin-btn secondary" style="font-size:0.8rem; padding:5px;" onclick="printLife('${h.name}')">üñ®Ô∏è</button>
              </td>
            </tr>`;
         });
         
         const ib = document.getElementById('inv-body'); ib.innerHTML="";
         D.inventory.forEach(i => {
            let btnState = i.state === 'HS' ? 
              `<button class="admin-btn success" onclick="setBagStatus('${i.name.replace(/'/g, "\\'")}','Actif')">Activer</button>` : 
              `<button class="admin-btn secondary" onclick="setBagStatus('${i.name.replace(/'/g, "\\'")}','HS')">HS</button>`;
            
            let orangePlaceholder = i.mailOrange ? '' : 'ex: contact@mail.com;autre@mail.com';
            let redPlaceholder = i.mailRed ? '' : 'ex: contact@mail.com;autre@mail.com';
            
            ib.innerHTML += `<tr>
              <td>${i.category}</td>
              <td><b>${i.name}</b></td>
              <td><input value="${i.mailOrange}" placeholder="${orangePlaceholder}" data-bag="${i.name}" data-type="orange" style="width:100%; color:#666;" onfocus="if(this.value==='')this.placeholder=''" onchange="updateMail(this)"></td>
              <td><input value="${i.mailRed}" placeholder="${redPlaceholder}" data-bag="${i.name}" data-type="red" style="width:100%; color:#666;" onfocus="if(this.value==='')this.placeholder=''" onchange="updateMail(this)"></td>
              <td style="display:flex; gap:5px;">${btnState}<button class="admin-btn danger" onclick="delBag('${i.name.replace(/'/g, "\\'")}')">X</button></td>
            </tr>`;
         });
         
         const catList = document.getElementById('cat-conf'); catList.innerHTML="";
         D.categoriesOrder.forEach(c => {
            catList.innerHTML += `<div class="cat-row">
              <span style="cursor:move;">‚ò∞</span> 
              <input class="cat-name-input" value="${c}" readonly style="border:none; background:none; font-weight:bold; flex:1;"> 
              <input class="cat-freq-input" value="${D.frequencies[c]||30}" size="3" style="text-align:center;"> 
              <span>jours</span>
            </div>`;
         });
         
         // CORRECTION: Remplir avec les valeurs par d√©faut ou existantes
         document.getElementById('mailOrangeSub2').value = D.mailConfig.orangeSub || "[ALERTE] P√©remption Proche";
         document.getElementById('mailOrangeBody2').value = D.mailConfig.orangeBody || "Bonjour,\n\nLe mat√©riel {nom} arrive √† √©ch√©ance le {echeance}.";
         document.getElementById('mailRedSub2').value = D.mailConfig.redSub || "[URGENT] Mat√©riel P√©rim√©";
         document.getElementById('mailRedBody2').value = D.mailConfig.redBody || "Bonjour,\n\nLe mat√©riel {nom} est p√©rim√© depuis le {echeance}.";
      }
      
      function printLife(n) {
         const h = D.history.filter(x => x.name == n);
         if(h.length === 0) return alert("Aucun historique.");
         
         let win = window.open('','','width=900,height=800');
         let html = `<html><head><title>Fiche de Vie - ${n}</title>`;
         html += `<style>body{font-family:sans-serif; padding:20px;} h1{color:#1565c0; border-bottom:2px solid #1565c0;} .rec{border:1px solid #ccc; margin-bottom:20px; border-radius:5px;} .head{background:#f0f0f0; padding:10px; font-weight:bold; display:flex; justify-content:space-between;} .body{padding:10px;} .row{display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px dotted #ddd;} .row:nth-child(even){background:#f9f9f9;} .label{font-weight:bold; color:#1565c0; flex:1;} .value{flex:1; text-align:right;}</style></head><body>`;
         html += `<h1>Fiche de Vie : ${n}</h1><p>G√©n√©r√© le ${new Date().toLocaleString()}</p>`;
         
         h.forEach(r => {
            html += `<div class="rec"><div class="head"><span>üìÖ ${r.dateStr}</span><span>üë§ ${r.verifier}</span></div><div class="body">`;
            if(r.details.startsWith("{")) {
               try {
                 const parts = r.details.split(" || ");
                 let j = JSON.parse(parts[0]);
                 for(let k in j) {
                   html += `<div class="row"><span class="label">${k}</span><span class="value">${j[k]}</span></div>`;
                 }
                 if(parts.length > 1) {
                   html += `<div style="margin-top:10px; padding:10px; background:#fff3cd; border-left:4px solid #ffc107;"><b>${parts[1]}</b></div>`;
                 }
               } catch(e) { html += r.details; }
            } else { html += r.details; }
            html += `</div></div>`;
         });
         html += `</body></html>`;
         win.document.write(html);
         win.document.close();
         setTimeout(()=>win.print(), 500);
      }
      
      function renderStats() {
         const s = D.stats;
         let html = `<div style="display:flex; justify-content:space-around; text-align:center; margin-bottom:30px;">
           <div><h2 style="color:#4caf50; margin:0;">${s.ok}</h2><small>OK</small></div>
           <div><h2 style="color:#ff9800; margin:0;">${s.orange}</h2><small>A surveiller</small></div>
           <div><h2 style="color:#f44336; margin:0;">${s.red}</h2><small>P√©rim√©s</small></div>
           <div><h2 style="color:#9c27b0; margin:0;">${s.expiredItems}</h2><small>Objets P√©rim√©s</small></div>
         </div>`;
         
         html += `<div class="admin-title">üìä Historique par Sac/VLI</div>`;
         html += `<table class="inv-table">
           <thead><tr>
             <th onclick="sortStatsTable(0)" style="cursor:pointer;">Nom ‚Üï</th>
             <th onclick="sortStatsTable(1)" style="cursor:pointer;">Passages Orange ‚Üï</th>
             <th onclick="sortStatsTable(2)" style="cursor:pointer;">Passages Rouge ‚Üï</th>
             <th onclick="sortStatsTable(3)" style="cursor:pointer;">Total V√©rifications ‚Üï</th>
           </tr></thead>
           <tbody id="stats-tbody">`;
         
         let statsData = D.inventory.map(item => {
           const histItem = D.history.filter(h => h.name === item.name);
           let countOrange = 0;
           let countRed = 0;
           
           if(item.status === 'orange') countOrange = 1;
           if(item.status === 'red') countRed = 1;
           
           return {
             name: item.name,
             orange: countOrange,
             red: countRed,
             total: histItem.length
           };
         });
         
         statsData.forEach(item => {
           html += `<tr>
             <td><b>${item.name}</b></td>
             <td style="color:#ff9800; font-weight:bold;">${item.orange}</td>
             <td style="color:#f44336; font-weight:bold;">${item.red}</td>
             <td>${item.total}</td>
           </tr>`;
         });
         
         html += `</tbody></table>`;
         document.getElementById('stats-container').innerHTML = html;
         
         // Stocker les donn√©es pour le tri
         window.statsData = statsData;
         window.currentSortCol = -1;
         window.sortAscending = false;
      }
      
      function sortStatsTable(colIdx) {
         const tbody = document.getElementById('stats-tbody');
         if (!tbody || !window.statsData) return;
         
         // Toggle sort direction
         if(window.currentSortCol === colIdx) {
           window.sortAscending = !window.sortAscending;
         } else {
           window.sortAscending = false;
           window.currentSortCol = colIdx;
         }
         
         const sortedData = [...window.statsData].sort((a, b) => {
           let aVal, bVal;
           
           if(colIdx === 0) { aVal = a.name; bVal = b.name; }
           else if(colIdx === 1) { aVal = a.orange; bVal = b.orange; }
           else if(colIdx === 2) { aVal = a.red; bVal = b.red; }
           else if(colIdx === 3) { aVal = a.total; bVal = b.total; }
           
           if(typeof aVal === 'string') {
             return window.sortAscending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
           } else {
             return window.sortAscending ? aVal - bVal : bVal - aVal;
           }
         });
         
         let html = '';
         sortedData.forEach(item => {
           html += `<tr>
             <td><b>${item.name}</b></td>
             <td style="color:#ff9800; font-weight:bold;">${item.orange}</td>
             <td style="color:#f44336; font-weight:bold;">${item.red}</td>
             <td>${item.total}</td>
           </tr>`;
         });
         
         tbody.innerHTML = html;
      }

      function addBag() { google.script.run.withSuccessHandler(loadData).addBag(document.getElementById('new-bag-cat').value, document.getElementById('new-bag-name').value); }
      function delBag(n) { if(confirm('Supprimer d√©finitivement ?')) google.script.run.withSuccessHandler(loadData).deleteBag(n); }
      function setBagStatus(n,s) { google.script.run.withSuccessHandler(loadData).updateBagStatus(n,s); }
      function addCat() { google.script.run.withSuccessHandler(loadData).createNewCategory(document.getElementById('new-cat-name').value); }
      function saveCatConf() { 
         let conf = [];
         document.querySelectorAll('.cat-row').forEach(r => {
            conf.push({ name: r.querySelector('.cat-name-input').value, freq: r.querySelector('.cat-freq-input').value });
         });
         google.script.run.withSuccessHandler(() => { alert("Fr√©quences enregistr√©es"); loadData(); }).updateCategoriesConfig(conf);
      }
    </script>
  </body>
</html>
