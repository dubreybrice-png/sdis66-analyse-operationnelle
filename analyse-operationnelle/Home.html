<!doctype html>
<!-- Version: v1.50 | 2026-01-30 -->
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script>const SCRIPT_URL = "<?= scriptUrl ?>";
  
  // Mapping des protocoles: colonne Excel (0-indexed) => label
  const PROTOCOLS_MAP = {
    22: "VVP (1A)",
    23: "Hypoglycémie (2A)",
    24: "Détr. Circu (3A)",
    25: "Brulures (4A)",
    26: "Dlr Aigue (5A)",
    27: "Penthrox (5A2)",
    28: "Dlr Iade (5A3)",
    29: "ACR (6A)",
    30: "Allergie (7A)",
    31: "DRA (8A)",
    32: "Intox Fumées (9A)",
    33: "Convulsions (10A)",
    34: "Accouchement (11A)",
    35: "Dlr Tho (12A)",
    36: "Coup chaleur (13A)",
    37: "Fracture fem'/bassin (14A)",
    38: "Hors Protocole (HPA)",
    39: "VVP (1E)",
    40: "Hypoglycémie (2E)",
    41: "Brulures (4E)",
    42: "Dlr Aigue (5E)",
    43: "ACR (6E)",
    44: "Allergie (7E)",
    45: "DRA (8E)",
    46: "Intox Fumées (9E)",
    47: "Convulsions (10E)",
    48: "Nouveau Né (11E)",
    49: "Hors Protocole (HPE)"
  };</script>
  <style>
    :root{ --bg0:#0b0f1f; --bg1:#0f1430; --text:#eaf0ff; --muted:#a9b5db; --border:rgba(255,255,255,.08); --accent3:#4fc3f7; --ok:#47d18c; --radius:18px; --red:#ff4d4d; --orange:#ffa500; --accent:#6ea8fe; --danger:#ff6b6b; --selectBg:#0e1730; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: ui-sans-serif, system-ui, sans-serif; color:var(--text); background:linear-gradient(180deg, var(--bg0), var(--bg1)); min-height:100vh; font-size:13px; }
    
    .neo-loader-box { position:fixed; top:20px; left:50%; transform:translateX(-50%); width:400px; padding:10px; background:rgba(0,0,0,0.9); border:1px solid var(--accent3); border-radius:4px; z-index:100000; box-shadow:0 0 15px rgba(57,255,20,0.3); display:none; flex-direction:column; gap:5px; }
    .neo-text { color:var(--accent3); font-family:monospace; font-weight:bold; font-size:12px; text-transform:uppercase; display:flex; justify-content:space-between; }
    .neo-track { width:100%; height:10px; background:#111; border:1px solid #333; border-radius:2px; overflow:hidden; }
    .neo-fill { height:100%; background: repeating-linear-gradient(45deg, var(--accent3), var(--accent3) 10px, #2ebf11 10px, #2ebf11 20px); width:0%; transition:width 0.2s linear; box-shadow:0 0 10px var(--accent3); }

    .app{ display:grid; grid-template-columns: 260px 1fr; min-height:100vh; }
    .sidebar{ position:sticky; top:0; height:100vh; padding:20px 15px; border-right:1px solid var(--border); background:rgba(18,26,59,.65); backdrop-filter:blur(10px); display:flex; flex-direction:column; overflow-y:auto; }
    .sideTop{ display:flex; flex-direction:column; align-items:center; text-align:center; gap:10px; margin-bottom:30px; }
    .sideLogo{ width:70px; height:70px; border-radius:14px; overflow:hidden; border:1px solid var(--border); }
    .sideLogo img{ width:100%; height:100%; object-fit:cover; }
    .sideTitle{ line-height:1.2; } .sideTitle b{ color:#fff; font-size:14px; }
    .sideBtns{ display:flex; flex-direction:column; gap:10px; }
    .sideBtn{ width:100%; text-align:left; background:rgba(255,255,255,.03); border:1px solid var(--border); color:var(--text); padding:12px; border-radius:12px; cursor:pointer; font-weight:600; display:flex; justify-content:space-between; align-items:center; transition:0.2s; }
    .sideBtn:hover{ background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.3); }
    .sideBtn.primary{ background:rgba(57,255,20,0.05); border-color:rgba(57,255,20,0.3); color:#fff; }
    .badgeBtn { background:var(--ok); color:#000; padding:2px 6px; border-radius:6px; font-size:11px; font-weight:bold; }
    .badgeBtn.red { background:var(--red); color:#fff; }

    .main{ padding:25px; overflow-y:auto; height:100vh; position:relative; }
    .view { display:none; animation:fadeIn 0.3s; }
    .view.active { display:block; }
    #viewChefferie.active { display:flex !important; flex-direction:column; position:absolute; top:0; left:0; right:0; bottom:0; overflow:hidden; background:#0b0f1f; z-index:50; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(5px);} to{opacity:1;transform:translateY(0);} }

    .topbar{ border-bottom:1px solid var(--border); padding-bottom:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; }
    .topbar h1 { margin:2px 0; font-size:18px; }
    .topbar p { margin:2px 0; font-size:12px; }
    .periodHero{ background:rgba(255,255,255,0.02); border:1px solid var(--border); padding:15px; border-radius:12px; text-align:center; margin-bottom:20px; }
    .kpiGrid{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-bottom:20px; }
    .panel{ background:rgba(18,26,59,.8); border:1px solid var(--border); border-radius:16px; overflow:hidden; margin-bottom:20px; }
    .panelHead{ background:rgba(0,0,0,0.2); padding:12px 15px; font-weight:bold; border-bottom:1px solid var(--border); font-size:13px; display:flex; justify-content:space-between; position:sticky; top:0; z-index:5; }
    .panelBody{ padding:15px; }
    .badge{ background:rgba(255,255,255,0.1); padding:3px 8px; border-radius:6px; font-size:12px; border:1px solid rgba(255,255,255,0.1); margin-left:15px; }
    
    table{ width:100%; border-collapse:collapse; font-size:11px; }
    thead{ position:sticky; top:0; z-index:10; background:#131b3a; }
    th{ text-align:left; color:var(--muted); padding:6px; border-bottom:1px solid var(--border); font-size:10px; text-transform:uppercase; cursor:pointer; user-select:none; background:#131b3a; }
    td{ padding:4px 6px; border-bottom:1px solid rgba(255,255,255,0.03); }
    tbody tr:nth-child(even) td{ background:rgba(79,195,247,0.04); }
    tbody tr:nth-child(odd) td{ background:transparent; }
    tr:hover td{ background:rgba(255,255,255,0.07) !important; cursor:pointer; }
    .num{ text-align:right; font-family:monospace; }
    table.compact{ width:auto; }
    table.compact td, table.compact th{ padding:4px 12px; white-space:nowrap; }
    
    .btnGo{ background:var(--accent3); color:#000; font-weight:bold; border:1px solid rgba(79,195,247,0.5); padding:8px 16px; border-radius:8px; cursor:pointer; transition:0.2s; box-shadow:0 0 12px rgba(79,195,247,0.3); }
    .btnGo:hover{ background:#5dd5ff; box-shadow:0 0 18px rgba(79,195,247,0.5); }
    .inp{ background:rgba(0,0,0,0.3); border:1px solid var(--border); color:#fff; padding:8px; border-radius:8px; outline:none; }
    .inp:focus{ border-color:var(--accent3); }
    
    .mini-load-box { display:none; width:150px; padding:5px; background:rgba(0,0,0,0.9); border:1px solid var(--accent3); border-radius:4px; margin-left:15px; }
    .mini-load-track { width:100%; height:6px; background:#111; border-radius:2px; overflow:hidden; }
    .mini-load-fill { width:0%; height:100%; background:var(--accent3); transition:width 0.2s; }
    .mini-load-text { font-size:10px; color:var(--accent3); text-align:center; font-family:monospace; margin-bottom:2px; }

    .adminSplit { display:flex; gap:20px; align-items:flex-start; }
    .adminLeft { flex:0 0 60%; }
    .adminRight { flex:1; }
    .admin-scroll { max-height:400px; overflow:auto; border:1px solid var(--border); border-radius:10px; }

    .btn-row { display:flex; gap:15px; margin-bottom:20px; position:sticky; top:35px; z-index:10; background:rgba(11,15,31,0.95); padding:15px 0; border-bottom:1px solid var(--border); }
    .c-btn { flex:1; padding:15px; background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:12px; color:#fff; cursor:pointer; text-align:left; transition:0.2s; }
    .c-btn:hover { background:rgba(255,255,255,.08); border-color:var(--accent3); }
    .c-btn h3 { margin:0 0 5px 0; font-size:14px; display:flex; justify-content:space-between; }
    .c-btn p { margin:0; font-size:11px; color:var(--muted); }

    .chef-layout { display:flex; gap:20px; height:85vh; }
    .chef-pdf { flex:2; background:#000; border-radius:12px; border:1px solid var(--border); overflow:hidden; }
    .chef-form { flex:1; background:rgba(0,0,0,0.2); padding:20px; border-radius:12px; border:1px solid var(--border); overflow-y:auto; display:flex; flex-direction:column; gap:15px; }

    .info-banner { background:rgba(57,255,20,0.05); border:1px solid var(--accent3); padding:10px; border-radius:8px; margin-bottom:10px; display:flex; flex-direction:column; gap:8px; font-weight:bold; font-size:12px; }
    .info-banner-row { display:flex; justify-content:space-between; flex-wrap:wrap; }
    
    .check-list { display:flex; flex-direction:column; gap:8px; background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; }
    .check-item { display:flex; align-items:center; gap:8px; }
    .chk-green { color:var(--ok); font-weight:bold; }
    .chk-orange { color:var(--orange); font-weight:bold; }
    .chk-red { color:var(--red); font-weight:bold; }

    textarea { width:100%; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:#fff; padding:10px; border-radius:6px; resize:vertical; min-height:60px; }
    .static-box { background:rgba(0,0,0,0.4); padding:10px; border-radius:6px; color:#ddd; font-size:12px; border:1px solid var(--border); }

    .modalOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(3px); }
    .modalCard { width:90%; max-width:1600px; height:98vh; background:#121a3b; border:1px solid var(--border); border-radius:20px; display:flex; flex-direction:column; overflow:hidden; }
    .modalHead { padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; font-weight:bold; font-size:16px; }
    .closeBtn { background:none; border:none; color:#fff; font-size:24px; cursor:pointer; }
    
    .modalBody { display:flex; flex:1; overflow:hidden; }
    
    #modalPdf { flex:2.5; border:0; background:#000; position:relative; width:auto; height:auto; }
    #modalPdfInfo { flex:1; min-width:350px; background:#1a2245; padding:20px; border-left:1px solid var(--border); overflow-y:auto; display:flex; flex-direction:column; gap:15px; }
    
    .detail-row { padding:12px; border-bottom:1px solid rgba(255,255,255,0.05); cursor:pointer; }
    .detail-row:hover { background:rgba(255,255,255,0.05); }
    .tag { padding:2px 6px; border-radius:4px; font-size:10px; margin-right:5px; border:1px solid transparent; }
    .tag.ok { color:var(--ok); border-color:var(--ok); }
    .tag.warn { color:var(--orange); border-color:var(--orange); }
    .tag.err { color:var(--red); border-color:var(--red); }
    
    .toast { position:fixed; bottom:20px; right:20px; background:#111; border:1px solid var(--border); padding:15px; border-radius:10px; z-index:99999; display:none; }
    .trendUp{ color:#39ff14; } .trendDown{ color:#ff4d4d; } .trendEq{ color:gray; }
    .text-green { color:var(--ok); font-weight:bold; } .text-orange { color:var(--orange); font-weight:bold; } .text-red { color:var(--red); font-weight:bold; }
    
    .table-title { background:rgba(0,0,0,0.2); padding:12px 15px; font-weight:bold; border-bottom:1px solid var(--border); font-size:13px; }

    .panelScrollWrapper { max-height:300px; overflow:auto; position:relative; }

    /* === STYLES APP === */
    header{ padding:8px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px; background: rgba(16,26,51,.8); backdrop-filter: blur(10px); border-bottom:1px solid var(--border); height: 50px; flex-shrink:0; }
    .brand{ display:flex; align-items:center; gap:10px; }
    .logo{ width:28px;height:28px;border-radius:8px; background: linear-gradient(135deg, rgba(110,168,254,.9), rgba(71,209,140,.85)); box-shadow: 0 18px 50px rgba(0,0,0,.35); cursor:pointer; }
    h1{ font-size:16px; margin:0; font-weight:700; } 
    .rightHead{ display:flex; align-items:center; gap:8px; }
    .pill{ font-size:11px; padding:4px 10px; border-radius: 999px; border:1px solid var(--border); color:var(--muted); background: rgba(255,255,255,.03); white-space:nowrap; }
    .btnTop{ border:1px solid var(--border); background: rgba(255,255,255,.03); color: var(--text); padding:6px 10px; border-radius: 999px; cursor:pointer; font-weight:600; font-size:11px; transition: background .2s; }
    .btnTop:hover{ background: rgba(255,255,255,.08); }

    .wrap{ padding:10px; max-width: 100%; margin:0 auto; height: calc(100vh - 50px); display:flex; gap:10px; }
    .leftCol { flex: 2.5; display:flex; flex-direction:column; gap:10px; height:100%; min-width:0; }
    .rightCol { flex: 2.2; display:flex; flex-direction:column; height:100%; min-width:500px; }

    .card{ background: linear-gradient(180deg, rgba(16,26,51,.95), rgba(15,24,48,.95)); border:1px solid var(--border); border-radius: var(--radius); box-shadow: 0 18px 50px rgba(0,0,0,.35); overflow:hidden; display:flex; flex-direction:column; flex:1; }
    .cardHead{ padding:8px 12px; border-bottom:1px solid var(--border); background: rgba(255,255,255,.02); flex-shrink:0; }
    
    .interInfos { display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; font-size: 11px; }
    .interItem { display:flex; flex-direction:column; }
    .interLabel { color: var(--muted); font-size:9px; text-transform:uppercase; letter-spacing:0.5px; }
    .interVal { font-weight:600; color:#fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size:11px; }
    .interVal.highlight { color: var(--accent); }

    .pdfBox{ flex:1; background: rgba(0,0,0,.2); position:relative; overflow:hidden; }
    iframe{ width:100%; height:100%; border:0; position:absolute; top:0; left:0; }

    .form{ padding:10px; display:flex; flex-direction:column; gap:8px; overflow-y:auto; flex:1; }
    .form::-webkit-scrollbar { width: 5px; }
    .form::-webkit-scrollbar-track { background: transparent; }
    .form::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    
    label{ font-size:10px; color:var(--muted); display:block; margin-bottom:2px; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .group{ padding:8px; border-radius: 10px; border:1px solid var(--border); background: rgba(255,255,255,.02); }
    .groupTitle { font-size:11px; font-weight:800; color:var(--accent); margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px; border-bottom:1px solid rgba(255,255,255,.05); padding-bottom:2px; }

    select, input[type="text"], textarea { padding:4px 6px; border-radius: 6px; border:1px solid var(--border); background: var(--selectBg); color: var(--text); outline:none; width:100%; font-family:inherit; font-size:11px; transition: border-color .2s; }
    select:focus, input:focus, textarea:focus { border-color: var(--accent); }
    textarea { resize: vertical; min-height: 30px; }

    .cb{ display:flex; align-items:flex-start; gap:4px; padding:3px 5px; border-radius: 4px; border:1px solid rgba(255,255,255,.05); background: rgba(255,255,255,.01); cursor:pointer; user-select:none; font-size:10px; transition: background .2s; line-height:1.2; white-space: normal; word-break: break-word; }
    .cb:hover { background: rgba(255,255,255,.05); }
    .cb.red { border-color: rgba(255,107,107,.3); color: var(--danger); }
    
    #protoAdultBox, #protoPediaBox { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 4px; }
    
    input[type="checkbox"]{ width:12px;height:12px; accent-color: var(--accent); cursor:pointer; flex-shrink:0; margin-top:1px; }
    input[type="checkbox"].danger-cb { accent-color: var(--danger); }

    .actions{ margin-top:auto; padding-top:6px; display:flex; gap:8px; flex-shrink:0; }
    .btn{ border:1px solid var(--border); background: rgba(255,255,255,.03); color: var(--text); padding:8px; border-radius: 8px; cursor:pointer; font-weight:700; flex:1; font-size:12px; }
    .btn.ok{ border-color: rgba(71,209,140,.45); background: linear-gradient(135deg, rgba(71,209,140,.25), rgba(71,209,140,.10)); color: #8affc1; }
    .btn.warn{ border-color: rgba(255,107,107,.35); background: linear-gradient(135deg, rgba(255,107,107,.16), rgba(255,107,107,.06)); }

    .grid-checks { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 4px; }
    .grid-selects { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .row2Items { display: grid; grid-template-columns: 2fr 1fr; gap:6px; margin-top:6px; }

    .appContainer { display:none; }
    .appContainer.active { display:flex; flex-direction:column; height:100%; }
    
    /* Flèche scroll clignotante */
    .scroll-arrow { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); width:40px; height:40px; background:linear-gradient(135deg, rgba(110,168,254,.2), rgba(71,209,140,.2)); border:2px solid var(--accent3); border-radius:50%; display:none; align-items:center; justify-content:center; font-size:20px; color:var(--accent3); cursor:pointer; animation:pulse 2s infinite; box-shadow:0 0 20px rgba(79,195,247,0.4); z-index:5000; }
    @keyframes pulse { 0%, 100% { opacity:1; transform:translateX(-50%) scale(1); } 50% { opacity:0.7; transform:translateX(-50%) scale(1.1); } }
    .scroll-arrow:hover { background:linear-gradient(135deg, rgba(110,168,254,.4), rgba(71,209,140,.4)); }

    /* === MOBILE SPLASH === */
    #splashChoice { position:fixed; top:0; left:0; width:100%; height:100%; z-index:99999; background:linear-gradient(135deg, var(--bg0) 0%, #0d1a4a 50%, var(--bg1) 100%); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:24px; }
    #splashChoice h2 { color:#fff; font-size:22px; text-align:center; margin:0; }
    #splashChoice p { color:rgba(255,255,255,.5); font-size:13px; margin:0; }
    .splashBtn { width:220px; padding:18px; border-radius:14px; border:2px solid rgba(79,195,247,.3); background:rgba(79,195,247,.06); color:#fff; font-size:17px; font-weight:700; cursor:pointer; transition:all .2s; text-align:center; }
    .splashBtn:hover { background:rgba(79,195,247,.15); border-color:rgba(79,195,247,.5); box-shadow:0 0 20px rgba(79,195,247,.2); }
    #modeStrip { display:none; position:fixed; bottom:0; left:0; width:100%; z-index:99998; background:rgba(15,20,48,.95); border-top:1px solid rgba(255,255,255,.1); padding:6px 12px; text-align:center; font-size:11px; color:rgba(255,255,255,.6); backdrop-filter:blur(8px); }
    #modeStrip a { color:var(--accent3); cursor:pointer; text-decoration:underline; margin-left:6px; }

    /* === MOBILE MODE === */
    body.mobile-mode { padding-bottom:36px; }
    body.mobile-mode .app { display:flex; flex-direction:column; min-height:100vh; }
    body.mobile-mode .sidebar { position:relative; height:auto; width:100%; border-right:none; border-bottom:1px solid var(--border); padding:12px; flex-direction:row; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center; }
    body.mobile-mode .sideTop { flex-direction:row; margin-bottom:0; gap:8px; }
    body.mobile-mode .sideLogo { width:40px; height:40px; border-radius:8px; }
    body.mobile-mode .sideTitle { text-align:left; } body.mobile-mode .sideTitle b { font-size:12px; } body.mobile-mode .sideTitle span { font-size:10px; }
    body.mobile-mode .sideBtns { flex-direction:row; flex-wrap:wrap; gap:6px; justify-content:center; width:100%; }
    body.mobile-mode .sideBtn { width:auto; flex:1 1 140px; min-width:0; padding:8px 10px; font-size:11px; border-radius:8px; }
    body.mobile-mode #todayInfoBox { width:100%; padding:8px; font-size:9px; }
    body.mobile-mode .main { height:auto; min-height:0; padding:10px; }
    body.mobile-mode .topbar { flex-direction:column; gap:6px; text-align:center; }
    body.mobile-mode .topbar h1 { font-size:15px; }
    body.mobile-mode .kpiGrid { grid-template-columns:1fr; gap:10px; }
    body.mobile-mode .panelBody { padding:10px; }
    body.mobile-mode .panelHead { padding:8px 10px; font-size:12px; }
    body.mobile-mode .periodHero { padding:10px; font-size:12px; }
    body.mobile-mode .adminSplit { flex-direction:column; }
    body.mobile-mode .adminLeft { flex:none; width:100%; }
    body.mobile-mode .adminRight { width:100%; }
    body.mobile-mode .admin-scroll { max-height:300px; }
    body.mobile-mode table { font-size:10px; display:block; overflow-x:auto; -webkit-overflow-scrolling:touch; }
    body.mobile-mode #ispLogin { flex-wrap:wrap; }
    body.mobile-mode #ispData > div:first-child { grid-template-columns:1fr !important; gap:10px; }
    body.mobile-mode .btn-row { flex-direction:column; gap:8px; }
    body.mobile-mode .c-btn { flex:none; }
    body.mobile-mode .c-btn h3 { font-size:12px; } body.mobile-mode .c-btn p { font-size:10px; }
    body.mobile-mode #viewChefferie > div:nth-child(2) { flex-direction:column; gap:8px; padding:10px; position:static; }
    body.mobile-mode .chef-layout { flex-direction:column; height:auto; }
    body.mobile-mode .chef-pdf { min-height:300px; }
    body.mobile-mode .chef-form { min-height:auto; }
    /* Mobile: APP view */
    body.mobile-mode .appContainer.active { display:flex; }
    body.mobile-mode .wrap { flex-direction:column; height:auto; padding:8px; gap:8px; }
    body.mobile-mode .leftCol { flex:none; min-width:0; }
    body.mobile-mode .rightCol { flex:none; min-width:0; }
    body.mobile-mode .card { min-height:0; }
    body.mobile-mode .pdfBox { min-height:350px; }
    body.mobile-mode .interInfos { grid-template-columns:repeat(3, 1fr); }
    body.mobile-mode header { flex-wrap:wrap; height:auto; gap:6px; padding:8px 12px; }
    body.mobile-mode header h1 { font-size:13px; }
    body.mobile-mode .rightHead { flex-wrap:wrap; }
    /* Mobile: modals */
    body.mobile-mode .modalCard { width:100% !important; max-width:100% !important; height:100vh !important; border-radius:0 !important; }
    body.mobile-mode .modalBody { flex-direction:column !important; }
    body.mobile-mode #modalPdf { min-height:300px; flex:none !important; }
    body.mobile-mode #modalPdfInfo { min-width:0 !important; border-left:none !important; border-top:1px solid var(--border); }
    body.mobile-mode .panel > div[style*="grid-template-columns:1fr 1fr"] { grid-template-columns:1fr !important; }
    body.mobile-mode select, body.mobile-mode input[type="text"], body.mobile-mode input[type="number"], body.mobile-mode input[type="password"], body.mobile-mode input[type="date"], body.mobile-mode textarea { font-size:16px !important; }
    /* Mobile: chefferie grid 2-col to 1-col */
    body.mobile-mode #chefModeApp > div > div[style*="grid-template-columns"], body.mobile-mode #chefModeMed > div > div[style*="grid-template-columns"], body.mobile-mode #chefModeAction > div > div[style*="grid-template-columns"] { grid-template-columns:1fr !important; }
  </style>
</head>
<body>
  <script>(function(){var m=localStorage.getItem('sdsOperMode');if(m==='mobile')document.body.classList.add('mobile-mode');})();</script>

  <div id="splashChoice">
    <div style="font-size:50px;">🚒</div>
    <h2>SDIS 66 — SDS Opérationnel</h2>
    <p>Comment souhaitez-vous consulter ?</p>
    <button class="splashBtn" onclick="chooseMobile()">📱 Téléphone</button>
    <button class="splashBtn" onclick="chooseDesktop()">💻 Ordinateur</button>
  </div>
  <div id="modeStrip"></div>

  <div id="loadingBox" class="neo-loader-box">
    <div class="neo-text"><span>Chargement...</span><span id="loadPct">0%</span></div>
    <div class="neo-track"><div id="loadFill" class="neo-fill"></div></div>
  </div>

  <div id="loadingBox25" class="neo-loader-box">
    <div class="neo-text"><span>Chargement 2025...</span><span id="loadPct25">0%</span></div>
    <div class="neo-track"><div id="loadFill25" class="neo-fill"></div></div>
  </div>

  <!-- Flèche de scroll -->
  <div class="scroll-arrow" id="scrollArrow" onclick="document.querySelector('.main').scrollTo({top: document.querySelector('.main').scrollHeight, behavior: 'smooth'});">↓</div>

  <!-- VUE DASHBOARD -->
  <div class="app" id="viewContainer">
    <aside class="sidebar">
      <div class="sideTop">
        <div class="sideLogo"><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTytvs_50DuR6nodg_2fA5DzNfpdDSR1s_YaQ&s"></div>
        <div class="sideTitle">
            <b>Sdis 66 - SDS</b>
            <span style="display:block;margin-top:2px;">Outil de données<br>opérationnelles</span>
            <div id="cacheTime" style="font-size:10px;color:gray;margin-top:5px;"></div>
        </div>
      </div>
      <div class="sideBtns">
        <button class="sideBtn primary" id="btnAppAccess" onclick="openAppView()"><span>Accès APP</span><span class="badgeBtn" id="cntAppBadge">...</span></button>
        <button class="sideBtn" onclick="askPass('chef')"><span>Accès chefferie</span><span style="display:flex;align-items:center;gap:4px;"><span class="badgeBtn" id="cntIspGBadge">...</span><span class="badgeBtn" style="background:var(--orange);color:#000;" id="cntMedBadge">...</span><span class="badgeBtn red" id="cntActionBadge">...</span></span></button>
        <button class="sideBtn" onclick="openPlanningModal()" style="position:relative;overflow:hidden;"><span style="position:relative;z-index:2;">📅 Planning</span><div id="planningPreview" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;opacity:0.3;"></div></button>
      </div>
      
      <div id="todayInfoBox" style="padding:12px;background:#1a1f2e;border-top:1px solid #444;font-size:10px;color:var(--muted);">
        <div style="font-weight:bold;color:var(--text);margin-bottom:8px;" id="todayDate">-</div>
        <div style="line-height:1.6;">
          <div><span style="color:#666;">ISP Garde Matin:</span> <span id="todayGardeMatin" style="color:var(--text);font-weight:bold;">-</span></div>
          <div><span style="color:#666;">ISP Garde AM:</span> <span id="todayGardeAm" style="color:var(--text);font-weight:bold;">-</span></div>
          <div style="margin-top:6px;"></div>
          <div><span style="color:#666;">Conducteur:</span> <span id="todayConduct" style="color:var(--text);font-weight:bold;">-</span></div>
          <div style="margin-top:6px;"></div>
          <div><span style="color:#666;">MaD jour:</span> <span id="todayMadJour" style="color:var(--text);font-weight:bold;">-</span></div>
          <div><span style="color:#666;">MaD nuit:</span> <span id="todayMadNuit" style="color:var(--text);font-weight:bold;">-</span></div>
          <div style="margin-top:6px;"></div>
          <div><span style="color:#666;">Infirmier astreinte pro:</span> <span id="todayInfirmier" style="color:var(--text);font-weight:bold;">-</span></div>
        </div>
      </div>
    </aside>

    <main class="main">
      
      <div id="viewDashboard" class="view active">
        <div class="topbar">
            <div><h1>Synthèse</h1><p style="color:var(--muted)">Activité opérationnelle 2026 — comparaison à date de la période 2025</p></div>
        </div>
        
        <div class="periodHero">Les données sont comparées du <b style="color:#fff;font-size:16px;">01/01/2026</b> au <b style="color:#fff;font-size:16px;"><span id="cutoffDateBig">...</span></b></div>

        <div class="kpiGrid">
           <div class="panel"><div class="panelBody">
              <div style="font-size:11px;color:var(--muted)">Interventions — Garde PSud</div><div style="font-size:32px;font-weight:900" id="psud2026">...</div>
              <div class="kpiBottom"><span style="color:var(--muted);font-size:11px">Total 2025:</span><span class="badge" id="psud2025Badge">...</span></div>
              <div style="font-size:9px;color:var(--muted);margin-top:4px;">Comparaison du 1er janvier au <span id="cutoffCompPsud">...</span></div>
           </div></div>
           <div class="panel"><div class="panelBody">
              <div style="font-size:11px;color:var(--muted)">Interventions — Secteur</div><div style="font-size:32px;font-weight:900" id="secteur2026">...</div>
              <div class="kpiBottom"><span style="color:var(--muted);font-size:11px">Total 2025:</span><span class="badge" id="sect2025Badge">...</span></div>
              <div style="font-size:9px;color:var(--muted);margin-top:4px;">Comparaison du 1er janvier au <span id="cutoffCompSect">...</span></div>
           </div></div>
           <div class="panel"><div class="panelBody">
              <div style="font-size:11px;color:var(--muted)">Total interventions SDS</div><div style="font-size:32px;font-weight:900" id="total2026">...</div>
              <div class="kpiBottom"><span style="color:var(--muted);font-size:11px">Total 2025:</span><span class="badge" id="total2025Badge">...</span></div>
              <div style="font-size:9px;color:var(--muted);margin-top:4px;">Comparaison du 1er janvier au <span id="cutoffCompTotal">...</span></div>
           </div></div>
        </div>

        <div class="panel" style="margin-bottom:20px;"><div class="panelBody" style="display:flex;align-items:center;gap:40px;">
            <div><div style="font-size:11px;color:var(--muted)">Astreintes / Dispo 2026</div><div style="font-size:24px;font-weight:bold" id="hrs2026">...</div><div style="font-size:9px;color:var(--muted);margin-top:4px;">Comparaison du 1er janvier au <span id="cutoffCompAst">...</span></div></div>
            <div><div style="font-size:11px;color:var(--muted)">Total 2025</div><div class="badge" id="hrs2025Badge">...</div></div>
        </div></div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
            <div class="panel"><div class="panelHead">Sorties par CIS</div><div class="panelScrollWrapper"><table id="tableCis"><thead><tr><th>CIS</th><th class="num">2026</th><th class="num">2025 (Date)</th><th class="num">2025 (Total)</th></tr></thead><tbody></tbody></table></div></div>
            <div class="panel"><div class="panelHead">Sorties par Secteur</div><div class="panelScrollWrapper"><table id="tableSect"><thead><tr><th>Secteur</th><th class="num">2026</th><th class="num">2025 (Date)</th><th class="num">2025 (Total)</th></tr></thead><tbody></tbody></table></div></div>
        </div>

        <div class="panel" style="margin-bottom:20px;">
            <div class="panelHead">Données par ISP</div>
            <div class="panelBody">
                <div id="ispLogin" style="display:flex;gap:10px;align-items:center;">
                    <input type="text" id="matInput" class="inp" placeholder="Matricule" style="width:120px;">
                    <input type="text" id="dobInput" class="inp" placeholder="JJ/MM/AAAA" style="width:140px;">
                    <button class="btnGo" style="width:auto;margin:0" onclick="loginIsp()">Voir mes données</button>
                    <div id="ispLoadBox" class="mini-load-box">
                       <div class="mini-load-text"><span id="ispPct">0</span>%</div>
                       <div class="mini-load-track"><div id="ispFill" class="mini-load-fill"></div></div>
                    </div>
                </div>
                <div id="ispData" style="display:none;margin-top:15px;">
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;">
                        <div>
                            <h4 style="color:var(--accent3);margin:0 0 5px 0">Temps (Agent: <span id="ispNameDisplay">—</span>)</h4>
                            <div style="font-size:12px;"><b>Astreinte 2026:</b> <span id="ispAst26"></span>h <span id="ispAstTrend"></span></div>
                            <div style="font-size:11px;color:var(--muted)">Comparatif 2025 à date: <span id="ispAst25Ytd"></span>h | Total 2025: <span id="ispAst25Tot"></span>h</div>
                            <hr style="border:0;border-top:1px solid #333;margin:5px 0">
                            <div style="font-size:12px;"><b>Garde 2026:</b> <span id="ispGarde26"></span>h <span id="ispGardeTrend"></span></div>
                            <div style="font-size:11px;color:var(--muted)">Comparatif 2025 à date: <span id="ispGarde25Ytd"></span>h | Total 2025: <span id="ispGarde25Tot"></span>h</div>
                            <hr style="border:0;border-top:1px solid #333;margin:8px 0 4px 0">
                            <div style="font-size:11px;font-weight:bold;margin-bottom:3px;">Détail mensuel 2026 :</div>
                            <table style="font-size:10px;width:100%;border-collapse:collapse;">
                                <thead><tr style="border-bottom:1px solid #444;"><th style="text-align:left;padding:2px 4px;">Mois</th><th style="text-align:right;padding:2px 4px;">Astreinte</th><th style="text-align:right;padding:2px 4px;">Garde</th></tr></thead>
                                <tbody id="ispMonthlyTbody"></tbody>
                            </table>
                        </div>
                        <div>
                            <h4 style="color:var(--accent3);margin:0 0 5px 0">Nbr Inters (Hors Garde)</h4>
                            <div style="font-size:12px;"><b>2026:</b> <span id="ispInter26"></span> <span id="ispInterTrend"></span></div>
                            <div style="font-size:11px;color:var(--muted)">Comparatif 2025 à date: <span id="ispInter25Ytd"></span> | Total 2025: <span id="ispInter25Tot"></span></div>
                            <hr style="border:0;border-top:1px solid #333;margin:8px 0 6px 0">
                            <h4 style="color:var(--accent3);margin:0 0 5px 0">Taux sollicitation</h4>
                            <div style="font-size:12px;"><b>Taux:</b> <span id="ispSollTx">—</span></div>
                            <div style="font-size:10px;color:var(--muted)">% temps passé en intervention par rapport temps dispo total hors garde</div>
                        </div>
                        <div>
                            <h4 style="color:var(--accent3);margin:0 0 5px 0">Etude qualitative des BPV</h4>
                            <div style="color:gray;font-size:11px;margin-bottom:8px;">Cliquez sur une intervention pour la voir</div>
                            <div style="font-size:12px;cursor:pointer;text-decoration:underline;" class="text-green" onclick="openErrorList('Bilan')">Bilan OK: <b id="ispBilanOk"></b></div>
                            <div style="font-size:12px;cursor:pointer;text-decoration:underline;" class="text-green" onclick="openErrorList('Pisu')">Pisu OK: <b id="ispPisuOk"></b></div>
                            
                            <div style="margin-top:8px;cursor:pointer;text-decoration:underline;" class="text-orange" onclick="openErrorList('BilanLeg')">Erreur Bilan Légère: <span id="ispErrBil"></span></div>
                            <div style="cursor:pointer;text-decoration:underline;" class="text-orange" onclick="openErrorList('PisuLeg')">Erreur Pisu Légère: <span id="ispErrPisu"></span></div>
                            
                            <div style="margin-top:8px;cursor:pointer;text-decoration:underline;" class="text-red" onclick="openErrorList('Grave')">Erreur Grave: <span id="ispErrLourd"></span></div>
                        </div>
                    </div>
                    <div style="margin-top:15px;">
                        <h4 style="color:var(--accent3);margin:0 0 6px 0">Temps de disponibilité — années précédentes</h4>
                        <table style="font-size:10px;width:100%;border-collapse:collapse;">
                            <thead><tr style="border-bottom:1px solid #444;">
                                <th class="num">2019</th><th class="num">2020</th><th class="num">2021</th>
                                <th class="num">2022</th><th class="num">2023</th><th class="num">2024</th>
                                <th class="num">2025</th>
                            </tr></thead>
                            <tbody id="ispHistTbody"></tbody>
                        </table>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:15px;">
                        <button class="btnGo" style="width:auto;background:#333;color:#fff" onclick="logoutIsp()">Déconnexion</button>
                        <button class="btnGo" style="width:auto;background:#444;color:#fff" onclick="refreshIspData()">🔄 Rafraîchir</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panelHead">Administration (à date)</div>
            <div class="panelBody">
                <div id="adminLogin" style="display:flex;gap:10px;align-items:center;">
                    <input type="password" id="adminPwd" class="inp" placeholder="Code...">
                    <button class="btnGo" style="width:auto;margin:0" onclick="loadAdmin()">Valider</button>
                </div>
                <div id="adminLoadBox" class="mini-load-box" style="margin-top:10px;">
                   <div class="mini-load-text"><span id="adminPct">0</span>%</div>
                   <div class="mini-load-track"><div id="adminFill" class="mini-load-fill"></div></div>
                </div>
                <div id="adminData" style="display:none;margin-top:10px;">
                    <input type="text" id="adminSearch" class="inp" placeholder="Filtrer (séparer par ;)" style="width:100%;margin-bottom:10px;" onkeyup="filterAdmin()">
                    
                    <div class="adminSplit">
                        <div class="adminLeft">
                            <div class="table-title">Données par ISP</div>
                            <div class="admin-scroll">
                                <table id="adminTable" class="compact">
                                    <thead><tr>
                                        <th onclick="sortAdmin(0)">Nom <span id="sortA0">↕</span></th>
                                        <th onclick="sortAdmin(1)" class="num">Nbr inter<br>hors garde<br>2026 <span id="sortA1">▼</span></th>
                                        <th onclick="sortAdmin(2)" class="num" style="color:var(--muted)">Nbr inter<br>hors garde<br>2025 <span id="sortA2">↕</span></th>
                                        <th onclick="sortAdmin(3)" class="num">Nbr inter<br>en garde<br>2026 <span id="sortA3">↕</span></th>
                                        <th onclick="sortAdmin(4)" class="num" style="color:var(--muted)">Nbr inter<br>en garde<br>2025 <span id="sortA4">↕</span></th>
                                        <th onclick="sortAdmin(5)" class="num">Temps astreinte<br>et dispo<br>2026 <span id="sortA5">↕</span></th>
                                        <th onclick="sortAdmin(6)" class="num" style="color:var(--muted)">Temps astreinte<br>et dispo<br>2025 <span id="sortA6">↕</span></th>
                                        <th onclick="sortAdmin(7)" class="num">Temps passé<br>en garde<br>2026 <span id="sortA7">↕</span></th>
                                        <th onclick="sortAdmin(8)" class="num" style="color:var(--muted)">Temps passé<br>en garde<br>2025 <span id="sortA8">↕</span></th>
                                    </tr></thead>
                                    <tbody id="adminTbody"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="adminRight">
                            <div class="table-title">Taux sollicitation</div>
                            <div style="font-size:10px;color:gray;margin-bottom:5px;padding:0 8px;">(% de temps passé en intervention par rapport temps dispo total hors garde)</div>
                            <div class="admin-scroll">
                                <table class="compact"><thead><tr><th>Nom</th><th>Taux</th></tr></thead><tbody id="adminSollTbody"></tbody></table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fenêtres CIS et Secteurs après -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px;">
                        <div class="panel"><div class="panelHead">Interventions par CIS (décroissant)</div><div class="panelScrollWrapper" style="max-height:250px;"><table id="tableAdminCis" class="compact"><thead><tr><th>CIS</th><th class="num">Nbr intervention<br>en 2026</th><th class="num">Nbr intervention<br>en 2025 (Date)</th><th class="num">Nbr intervention<br>en 2025 (Total)</th></tr></thead><tbody></tbody></table></div></div>
                        <div class="panel"><div class="panelHead">Interventions par Secteur (décroissant)</div><div class="panelScrollWrapper" style="max-height:250px;"><table id="tableAdminSect" class="compact"><thead><tr><th>Secteur</th><th class="num">Nbr intervention<br>en 2026</th><th class="num">Nbr intervention<br>en 2025 (Date)</th><th class="num">Nbr intervention<br>en 2025 (Total)</th></tr></thead><tbody></tbody></table></div></div>
                    </div>
                    
                    <div class="panel" style="margin-top:20px;">
                        <div class="panelHead">Temps de disponibilité et astreinte par ISP et par mois — 2026</div>
                        <div class="panelScrollWrapper" style="max-height:400px;">
                            <table id="adminMonthlyTable" class="compact" style="font-size:11px;">
                                <thead><tr>
                                    <th>Nom</th>
                                    <th class="num">Jan</th><th class="num">Fév</th><th class="num">Mar</th>
                                    <th class="num">Avr</th><th class="num">Mai</th><th class="num">Jun</th>
                                    <th class="num">Jul</th><th class="num">Aoû</th><th class="num">Sep</th>
                                    <th class="num">Oct</th><th class="num">Nov</th><th class="num">Déc</th>
                                    <th class="num" style="font-weight:bold;">Total</th>
                                </tr></thead>
                                <tbody id="adminMonthlyTbody"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="panel" style="margin-top:20px;">
                        <div class="panelHead">Historique temps travail — heures dispo + astreinte</div>
                        <div class="panelScrollWrapper" style="max-height:300px;">
                            <table id="adminHistTable" class="compact" style="font-size:11px;">
                                <thead><tr>
                                    <th style="text-align:left">Nom</th>
                                    <th style="text-align:right">2019</th><th style="text-align:right">2020</th><th style="text-align:right">2021</th>
                                    <th style="text-align:right">2022</th><th style="text-align:right">2023</th><th style="text-align:right">2024</th>
                                    <th style="text-align:right">2025</th>
                                </tr></thead>
                                <tbody id="adminHistTbody"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="panel" style="margin-top:20px;">
                        <div class="panelHead">Astreinte départementale ISPP 2026 (en journées)</div>
                        <div class="panelScrollWrapper" style="max-height:300px;">
                            <table id="adminAstreinteDeptTable" class="compact" style="font-size:11px;">
                                <thead><tr>
                                    <th>Nom</th>
                                    <th class="num">Jan</th><th class="num">Fév</th><th class="num">Mar</th>
                                    <th class="num">Avr</th><th class="num">Mai</th><th class="num">Jun</th>
                                    <th class="num">Jul</th><th class="num">Aoû</th><th class="num">Sep</th>
                                    <th class="num">Oct</th><th class="num">Nov</th><th class="num">Déc</th>
                                    <th class="num" style="font-weight:bold;">Total</th>
                                </tr></thead>
                                <tbody id="adminAstreinteDeptTbody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="margin-top:20px;padding-top:20px;border-top:1px solid #444;text-align:center;">
                      <button style="font-size:11px;padding:6px 12px;background:#333;border:1px solid #555;color:#999;cursor:pointer;border-radius:4px;" onclick="clearCachesAndReload()">🔄 Vider cache</button>
                    </div>
                </div>
                </div>
            </div>
        </div>
      </div>

      <!-- NOUVELLE INTERFACE CHEFFERIE -->
      <div id="viewChefferie" class="view">
          <!-- Header fixe -->
          <div style="background:var(--bg); border-bottom:2px solid var(--border); padding:12px 20px; display:flex; align-items:center; gap:15px;">
              <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTytvs_50DuR6nodg_2fA5DzNfpdDSR1s_YaQ&s" style="width:40px;height:40px;border-radius:10px;border:1px solid var(--border);">
              <button class="btnGo" style="width:auto;padding:8px 16px;" onclick="goHome()">← Retour Dashboard</button>
              <h1 style="margin:0;font-size:18px;font-weight:800;">Espace Chefferie</h1>
          </div>
          
          <!-- 4 Boutons TOUJOURS EN HAUT -->
          <div style="background:rgba(11,15,31,0.98); border-bottom:1px solid var(--border); padding:15px 20px; display:flex; gap:12px; position:sticky; top:0; z-index:100;">
              <button class="c-btn" style="flex:1;" onclick="showChefferieMode('app')">
                  <h3 style="margin:0 0 4px 0; font-size:14px;">📋 Faire APP Chefferie <span class="badgeBtn" id="btnBadgeIspG" style="font-size:10px;">...</span></h3>
                  <p style="margin:0; font-size:11px; opacity:0.8;">Fiches Bilan/Pisu incomplets</p>
              </button>
              <button class="c-btn" style="flex:1;" onclick="showChefferieMode('med')">
                  <h3 style="margin:0 0 4px 0; font-size:14px;">⚠️ Analyse Médecin Cheffe <span class="badgeBtn" style="background:var(--orange);color:#000;font-size:10px;" id="btnBadgeMed">...</span></h3>
                  <p style="margin:0; font-size:11px; opacity:0.8;">Erreurs graves</p>
              </button>
              <button class="c-btn" style="flex:1;" onclick="showChefferieMode('action')">
                  <h3 style="margin:0 0 4px 0; font-size:14px;">🎯 Réaliser actions chefferie <span class="badgeBtn red" style="font-size:10px;" id="btnBadgeAction">...</span></h3>
                  <p style="margin:0; font-size:11px; opacity:0.8;">Actions finales à mener</p>
              </button>
              <button class="c-btn" style="flex:1;" onclick="showChefferieMode('data')">
                  <h3 style="margin:0 0 4px 0; font-size:14px;">📊 Voir Données APP</h3>
                  <p style="margin:0; font-size:11px; opacity:0.8;">Tous les ISP</p>
              </button>
          </div>
          
          <!-- Zone de contenu -->
          <div style="flex:1; overflow-y:auto; padding:20px;">
              <!-- Mode APP Chefferie -->
              <div id="chefModeApp" style="display:none;">
                  <div id="chefAppContent"></div>
              </div>
              
              <!-- Mode Médecin -->
              <div id="chefModeMed" style="display:none;">
                  <div id="chefMedContent"></div>
              </div>
              
              <!-- Mode Action -->
              <div id="chefModeAction" style="display:none;">
                  <div id="chefActionContent"></div>
              </div>

              <!-- Mode Data -->
              <div id="chefModeData" style="display:none;">
                  <div style="display:flex; gap:10px; margin-bottom:15px;">
                      <button class="btnGo" style="flex:1; background:var(--red); border-color:var(--red); color:#fff;" onclick="showErrorsByType('Erreur Grave')">🚨 Voir erreurs graves</button>
                      <button class="btnGo" style="flex:1; background:var(--orange); border-color:var(--orange); color:#000;" onclick="showErrorsByType('Erreur Pisu Légère')">⚠ Voir erreurs pisu légères</button>
                      <button class="btnGo" style="flex:1; background:var(--orange); border-color:var(--orange); color:#000;" onclick="showErrorsByType('Erreur Bilan Légère')">⚠ Voir erreurs bilan légères</button>
                  </div>
                  <div class="panel">
                      <div class="panelHead">Récapitulatif par ISP</div>
                      <div class="panelBody">
                          <table id="globalTable" style="width:100%;">
                              <thead><tr>
                                  <th>Nom ISP</th>
                                  <th>Bilan OK</th>
                                  <th>Pisu OK</th>
                                  <th>Err. Bilan Lég.</th>
                                  <th>Err. Pisu Lég.</th>
                                  <th>Err. Grave</th>
                              </tr></thead>
                              <tbody id="globalTbody"></tbody>
                          </table>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <div id="viewMedecin" class="view">
          <div class="topbar"><button class="btnGo" style="width:auto;margin:0" onclick="goHome()">← Retour Dashboard</button><h1 style="display:inline-block;margin-left:15px;">Espace Médecin Cheffe</h1></div>
          <div id="medFormArea" style="height:85vh;margin-top:20px;"></div>
      </div>

      <!-- PLANNING MODAL -->
      <div id="planningModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center;padding:20px;">
        <div style="background:var(--bg);border:1px solid var(--border);border-radius:8px;max-width:95vw;max-height:85vh;overflow:hidden;padding:20px;position:relative;display:flex;flex-direction:column;">
          <button onclick="document.getElementById('planningModal').style.display='none'" style="position:absolute;top:10px;right:10px;background:none;border:none;color:var(--text);font-size:24px;cursor:pointer;z-index:10;">✕</button>
          <h2 id="planningTitle" style="margin-top:0;margin-bottom:10px;"></h2>
          <div id="planningContent" style="flex:1;overflow-x:auto;overflow-y:auto;border:1px solid var(--border);border-radius:4px;"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- VUE APP -->
  <div class="appContainer" id="appView">
    <header>
      <div class="brand">
        <div class="logo" title="Retour accueil" onclick="closeAppView()"></div>
        <h1>APP par ISP</h1>
      </div>
      <div class="rightHead">
        <div class="pill" id="statusPill">Chargement…</div>
        <button class="btnTop" onclick="loadNext(currentAppRow)">Recharger</button>
        <button class="btnTop" onclick="closeAppView()">Accueil</button>
      </div>
    </header>

    <div class="wrap">
      <div class="leftCol">
        <div class="card">
            <div class="cardHead">
            <div class="interInfos">
                <div class="interItem"><span class="interLabel">Intervention</span><span class="interVal" id="iNum">—</span></div>
                <div class="interItem"><span class="interLabel">Date</span><span class="interVal" id="iDate">—</span></div>
                <div class="interItem"><span class="interLabel">Infirmier</span><span class="interVal highlight" id="iInf">—</span></div>
                <div class="interItem"><span class="interLabel">Centre</span><span class="interVal" id="iCis">—</span></div>
                <div class="interItem"><span class="interLabel">Motif</span><span class="interVal" id="iMotif">—</span></div>
                <div class="interItem"><span class="interLabel">Engin</span><span class="interVal" id="iEngin">—</span></div>
            </div>
            </div>
            <div class="pdfBox">
            <iframe id="pdfFrame" src=""></iframe>
            <div id="pdfPlaceholder" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:var(--muted);">Chargement PDF...</div>
            </div>
            <div style="padding:4px; text-align:center; border-top:1px solid var(--border); background:rgba(0,0,0,0.3); font-size:10px;">
            <a id="openPdfLink" href="#" target="_blank" style="color:var(--accent); text-decoration:none;">Ouvrir dans Drive ↗</a> 
            <span class="pill" id="remainingPill" style="margin-left:10px; font-size:9px; padding:2px 6px;">Reste : —</span>
            </div>
        </div>
      </div>

      <div class="rightCol">
        <div class="card">
            <div class="form" id="mainForm">
            
            <div class="group" style="padding:6px;">
                <div style="display:flex;align-items:center;gap:10px;">
                    <label style="margin:0;">ISP Analyse :</label>
                    <select id="ispSelect" style="flex:1;"><option value="">Chargement...</option></select>
                </div>
            </div>

            <div class="group">
                <div class="groupTitle">Protocoles</div>
                <div style="margin-bottom:2px;font-size:10px;color:var(--muted);font-weight:700;">Adultes</div>
                <div class="grid-checks" id="protoAdultBox"></div>
                <div style="margin:6px 0 2px;font-size:10px;color:var(--muted);font-weight:700;border-top:1px solid rgba(255,255,255,.05);padding-top:4px;">Pédiatriques</div>
                <div class="grid-checks" id="protoPediaBox"></div>
            </div>

            <div class="group">
                <div class="groupTitle">Critères</div>
                <div class="grid-selects">
                    <div><label id="lblAx">AKIM</label><select id="selAx"></select></div>
                    <div><label id="lblAy">SMUR</label><select id="selAy"></select></div>
                    <div><label id="lblAz">CCMU</label><select id="selAz"></select></div>
                    <div><label id="lblBa">DEVENIR</label><select id="selBa"></select></div>
                </div>
                <div class="row2Items">
                    <div><label id="lblBb">SOUSAN</label><select id="selBb"></select></div>
                    <div><label id="lblBc">NB VICTIMES</label><input type="text" id="txtBc"></div>
                </div>
                <div style="margin-top:8px;"><label id="lblBg">Examen clinique</label><select id="selBg"></select></div>
            </div>

            <div class="group">
                <div class="groupTitle">Résultat</div>
                <div id="biBmBox" style="display:grid; grid-template-columns: 1fr; gap:6px; word-wrap:break-word; word-break:break-word;"></div>
            </div>

            <div class="group" id="motifContainer" style="display:none;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px;">
                    <div id="motifBilanDiv"><label>Motif bilan incomplet</label><textarea id="txtBn"></textarea></div>
                    <div id="motifPisuDiv"><label>Motif pisu pas ok</label><textarea id="txtBo"></textarea></div>
                </div>
            </div>

            <div class="group" style="border-color: rgba(255,107,107,.3); padding:4px;">
                <label class="cb red" style="margin:0;">
                    <input type="checkbox" id="pbCheck" class="danger-cb">
                    Signaler un problème à Brice
                </label>
                <div id="pbDetails" style="margin-top:4px; display:none;">
                    <input type="text" id="pbTxt" placeholder="Précisez..." style="width:100%;">
                </div>
            </div>

            <div class="actions">
                <button class="btn ok" id="sendBtn" onclick="sendApp()">Envoyer et Clôturer</button>
                <button class="btn warn" id="skipBtn" onclick="skipApp()">Ignorer</button>
            </div>
            </div>
        </div>
      </div>
    </div>
  </div>

  <div id="modalDetail" class="modalOverlay" style="z-index:20000;">
    <div class="modalCard" style="width:95%; max-width:1600px; height:98vh;">
      <div class="modalHead">
        <span>Détail de l'intervention</span>
        <button class="closeBtn" onclick="closeModal('modalDetail')">×</button>
      </div>
      <div class="modalBody" style="display:flex; gap:0;">
        <iframe id="modalPdf" style="flex:2.5; border:0; background:#000;"></iframe>
        <div id="modalPdfInfo" style="flex:1; min-width:350px; background:#1a2245; padding:20px; border-left:1px solid var(--border); overflow-y:auto; display:flex; flex-direction:column; gap:15px;">
          <h4 style="color:var(--accent3);margin:0 0 15px 0;">Informations</h4>
          <div style="display:flex;flex-direction:column;gap:12px;font-size:13px;">
            <div><span style="color:var(--muted);font-size:11px;">N° Intervention</span><br><b id="detailId" style="font-size:15px;color:#fff;"></b></div>
            <div><span style="color:var(--muted);font-size:11px;">Date</span><br><b id="detailDate"></b></div>
            <div><span style="color:var(--muted);font-size:11px;">Statut</span><br><b id="detailCentre"></b></div>
            <div><span style="color:var(--muted);font-size:11px;">Motif d'intervention</span><br><b id="detailMotif"></b></div>
            <div><span style="color:var(--muted);font-size:11px;">Engin</span><br><b id="detailEngin"></b></div>
          </div>
          <h4 style="color:var(--accent3);margin:15px 0 10px 0;">Commentaire Chefferie</h4>
          <div id="commChef" class="static-box"></div>
          <div id="blockMed" style="display:none;">
            <h4 style="color:var(--red);margin:15px 0 10px 0;">Analyse Médecin</h4>
            <div id="commMed" class="static-box" style="color:var(--red);"></div>
          </div>
          <button class="btnGo" style="width:100%;margin-bottom:8px;" onclick="document.getElementById('modalDetail').style.display='none'; document.getElementById('modalList').style.display='flex';">← Retour aux fiches</button>
          <button class="btnGo" style="width:100%;" onclick="closeModal('modalDetail')">Fermer</button>
        </div>
      </div>
    </div>
  </div>
  
  <div id="modalList" class="modalOverlay" style="z-index:15000;"><div class="modalCard" style="max-width:800px;height:80vh;"><div class="modalHead"><span id="modalListTitle">Liste des dossiers</span><button class="closeBtn" onclick="closeModal('modalList')">×</button></div>
      <div style="padding:15px;border-bottom:1px solid var(--border);display:flex;gap:15px;flex-wrap:wrap;background:rgba(0,0,0,0.3);" id="filterBox">
          <label><input type="checkbox" checked onchange="filterDetails()" value="Bilan OK"> Bilan OK</label>
          <label><input type="checkbox" checked onchange="filterDetails()" value="Pisu OK"> Pisu OK</label>
          <label><input type="checkbox" checked onchange="filterDetails()" value="Erreur Bilan Légère"> Erreur Bilan Lég.</label>
          <label><input type="checkbox" checked onchange="filterDetails()" value="Erreur Pisu Légère"> Erreur Pisu Lég.</label>
          <label><input type="checkbox" checked onchange="filterDetails()" value="Erreur Grave"> Erreur Grave</label>
      </div>
      <div class="modalBody" id="modalListContent" style="display:block;padding:0;overflow-y:auto;flex-direction:column;"></div>
  </div></div>

  <div class="toast" id="toast"></div>

  <script>
    // === VARIABLES GLOBALES ===
    let currentAppRow = null;
    let isAppSubmitting = false;
    let currentAppRowNumber = null;

    // --- CORE FUNCTIONS ---
    const lFill=document.getElementById("loadFill"), lPct=document.getElementById("loadPct");
    let loadInt;
    function startLoad(){ document.getElementById("loadingBox").style.display="flex"; let w=0; loadInt=setInterval(()=>{ if(w<90)w+=5; lFill.style.width=w+"%"; lPct.textContent=Math.floor(w)+"%"; },100); }
    function stopLoad(){ clearInterval(loadInt); lFill.style.width="100%"; lPct.textContent="100%"; setTimeout(()=>{ document.getElementById("loadingBox").style.display="none"; lFill.style.width="0"; },300); }
    function toast(m){ const t=document.getElementById("toast"); t.textContent=m; t.style.display="block"; setTimeout(()=>t.style.display="none",3000); }
    function goHome(){ document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); document.getElementById('viewDashboard').classList.add('active'); }
    function setText(id,v){ const e=document.getElementById(id); if(e) e.textContent=(v==null?"-":v); }
    function getTrendHtml(a,b){ 
      const v1=parseFloat(a)||0, v2=parseFloat(b)||0; 
      if(v2===0 && v1>0) {
        const pct = Math.round((v1/v1)*100) + '%';
        return '<span class="trendUp">▲</span> <small style="color:#4f9;font-size:11px;margin-left:4px;">+100%</small>';
      }
      if(v2===0 && v1===0) {
        return '<span class="trendEq">=</span>';
      }
      const diff = v1 - v2;
      const pct = Math.round((Math.abs(diff) / v2) * 100);
      if(v1>v2) {
        return '<span class="trendUp">▲</span> <small style="color:#4f9;font-size:11px;margin-left:4px;">+' + pct + '%</small>';
      }
      if(v1<v2) {
        return '<span class="trendDown">▼</span> <small style="color:#f44;font-size:11px;margin-left:4px;">-' + pct + '%</small>';
      }
      return '<span class="trendEq">=</span>';
    }
    document.getElementById('dobInput').addEventListener('input', function(e){ if(e.inputType!="deleteContentBackward"){ let v=this.value; if(v.length==2||v.length==5) this.value=v+'/'; } });

    function updateCacheDisplay() {
        google.script.run.withSuccessHandler(status => {
            if(status) {
                document.getElementById("cacheTime").textContent = "Mise en cache: " + status;
            }
        }).getCacheStatus();
    }

    // --- INIT ---
    window.onload = () => {
        startLoad();
        google.script.run.withSuccessHandler(d => {
            stopLoad();
            if(d.error){ toast("Erreur: "+d.error); return; }
            setText("cutoffDateBig", d.date);
            setText("cutoffCompPsud", d.date);
            setText("cutoffCompSect", d.date);
            setText("cutoffCompTotal", d.date);
            setText("cutoffCompAst", d.date);
            setText("psud2026", d.psud); setText("total2026", d.total);
            setText("secteur2026", d.sect); setText("hrs2026", d.ast+" h");
            
            document.querySelector("#tableCis tbody").innerHTML = (d.cis||[]).map(x=>`<tr id="cis_${x.name}"><td>${x.name}</td><td class="num">${x.v26}</td><td class="num v25">...</td><td class="num" style="color:gray">${x.v25tot}</td></tr>`).join('');
            document.querySelector("#tableSect tbody").innerHTML = (d.secteurs||[]).map(x=>`<tr id="sect_${x.name}"><td>${x.name}</td><td class="num">${x.v26}</td><td class="num v25">...</td><td class="num" style="color:gray">${x.v25tot}</td></tr>`).join('');
            
            setText("cntAppBadge", d.cntApp||0);
            setText("cntIspGBadge", d.cntIspG||0);
            setText("cntMedBadge", d.cntMed||0);
            setText("cntActionBadge", d.cntAction||0);
            setText("btnBadgeIspG", d.cntIspG||0);
            setText("btnBadgeMed", d.cntMed||0);
            setText("btnBadgeAction", d.cntAction||0);

            // 2025 (Deferred)
            const l25 = document.getElementById("loadingBox25"), f25=document.getElementById("loadFill25"), p25=document.getElementById("loadPct25");
            l25.style.display="flex"; let w25=0; const i25 = setInterval(()=>{ if(w25<90)w25+=5; f25.style.width=w25+"%"; p25.textContent=w25+"%"; },100);

            google.script.run.withSuccessHandler(d25 => {
                clearInterval(i25); f25.style.width="100%"; p25.textContent="100%"; setTimeout(()=>l25.style.display="none",300);

                document.getElementById("cacheTime").textContent = "Mise en cache: " + (d25.cacheTime || "N/A");
                document.getElementById("psud2025Badge").innerHTML = `${d25.psud} ${getTrendHtml(d.psud, d25.psud)}`;
                document.getElementById("sect2025Badge").innerHTML = `${d25.sect} ${getTrendHtml(d.sect, d25.sect)}`;
                document.getElementById("total2025Badge").innerHTML = `${d25.total} ${getTrendHtml(d.total, d25.total)}`;
                document.getElementById("hrs2025Badge").innerHTML = `${d25.ast} h ${getTrendHtml(d.ast, d25.ast)}`;
                for(let k in d25.cisMap) { const row = document.getElementById("cis_"+k); if(row) row.querySelector(".v25").textContent = d25.cisMap[k]; }
                for(let k in d25.sectMap) { const row = document.getElementById("sect_"+k); if(row) row.querySelector(".v25").textContent = d25.sectMap[k]; }

                google.script.run.preCacheAllData();
                let cacheInt = setInterval(() => {
                    updateCacheDisplay();
                }, 500);
                setTimeout(() => clearInterval(cacheInt), 60000);

            }).getStats2025();

        }).getStats2026();
        
        // Gestion flèche scroll
        const checkScroll = () => {
            const scrollArrow = document.getElementById('scrollArrow');
            const mainEl = document.querySelector('.main');
            if (!scrollArrow || !mainEl) return;
            const scrolled = mainEl.scrollTop;
            const windowHeight = mainEl.clientHeight;
            const docHeight = mainEl.scrollHeight;
            const isAtBottom = (scrolled + windowHeight) >= (docHeight - 50);
            
            if (docHeight > windowHeight && !isAtBottom) {
                scrollArrow.style.display = 'flex';
            } else {
                scrollArrow.style.display = 'none';
            }
        };
        
        const mainEl = document.querySelector('.main');
        if(mainEl) {
            mainEl.addEventListener('scroll', checkScroll);
            window.addEventListener('resize', checkScroll);
            setTimeout(() => {
                checkScroll();
                setInterval(checkScroll, 2000);
            }, 2000);
        }
    };

    function askPass(target) {
        const p=prompt("Mot de passe :");
        if(p==="0007"){
            document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
            if(target==='chef') document.getElementById('viewChefferie').classList.add('active');
            if(target==='med') { document.getElementById('viewMedecin').classList.add('active'); loadChefCase('med_chef'); }
        } else toast("Erreur");
    }

    // === APP VIEW ===
    function openAppView() {
      const pwd = prompt("Mot de passe :");
      if(pwd !== "APP66") { alert("Code incorrect"); return; }
      document.getElementById('viewContainer').style.display='none';
      document.getElementById('appView').classList.add('active');
      loadNext();
    }

    function closeAppView() {
      document.getElementById('appView').classList.remove('active');
      document.getElementById('viewContainer').style.display='grid';
      goHome();
    }

    function setStatus(t){ document.getElementById("statusPill").textContent=t; }
    function extractDriveFileId(u){ if(!u)return ""; const m=String(u).match(/\/file\/d\/([^\/\?]+)/i); return (m&&m[1])?m[1]:""; }
    function buildPdfEmbed(u){ const id=extractDriveFileId(u); return id ? "https://drive.google.com/file/d/"+id+"/preview" : ""; }
    function setButtons(d){ ["sendBtn","skipBtn"].forEach(i=>document.getElementById(i).disabled=d); }

    document.getElementById("pbCheck").addEventListener("change", (e)=>{
       document.getElementById("pbDetails").style.display = e.target.checked ? "block" : "none";
    });

    function loadNext(specificRow){
      if(isAppSubmitting) return;
      setStatus("Recherche..."); setButtons(true);
      
      // Afficher loader
      document.getElementById("loadingBox").style.display="flex";
      let w=0; 
      const loadInt = setInterval(()=>{ 
          if(w<90) w+=5; 
          document.getElementById("loadFill").style.width=w+"%"; 
          document.getElementById("loadPct").textContent=Math.floor(w)+"%"; 
      }, 100);
      
      google.script.run.withSuccessHandler(res=>{
        clearInterval(loadInt);
        document.getElementById("loadFill").style.width="100%";
        document.getElementById("loadPct").textContent="100%";
        setTimeout(()=>document.getElementById("loadingBox").style.display="none", 300);
        
        setButtons(false);
        document.getElementById("remainingPill").textContent = "Reste : "+(res.remaining||0);

        if(res.done){
          setStatus("Terminé"); 
          toast(res.message);
          document.getElementById("mainForm").innerHTML = `<div style="text-align:center;color:var(--muted);margin-top:50px;">${res.message}</div>`;
          document.getElementById("pdfFrame").src="";
          return;
        }

        currentAppRow = res.rowNumber;
        currentAppRowNumber = res.rowNumber;
        setStatus("Fiche prête");
        
        const info = res.info;
        setText("iNum", info.interId);
        setText("iDate", info.date);
        setText("iInf", info.infName);
        setText("iCis", info.cis);
        setText("iMotif", info.motif);
        setText("iEngin", info.engin);

        const pdfUrl = buildPdfEmbed(res.url);
        document.getElementById("pdfFrame").src = pdfUrl; 
        document.getElementById("openPdfLink").href = res.url || "#";
        document.getElementById("pdfPlaceholder").style.display = pdfUrl ? "none" : "block";

        renderForm(res.schema, res.ispList);

      }).withFailureHandler(err=>{ 
        clearInterval(loadInt);
        document.getElementById("loadingBox").style.display="none";
        setStatus("Erreur"); toast(err.message,"err"); setButtons(false); 
      }).getNextCase(specificRow);
    }

    function renderForm(schema, ispList) {
       fillSelect("ispSelect", ispList, schema.ispVal);

       const mkCb = (boxId, items) => {
         const box = document.getElementById(boxId);
         box.innerHTML = "";
         if (!items || !Array.isArray(items)) return;
         
         // Pour biBmBox, créer un layout groupé
         if(boxId === "biBmBox") {
            let currentRow = null;
            let itemsInRow = 0;
            
            items.forEach((item, idx) => {
               // "Absence traçabilité" seule sur sa ligne
               const isAbsenceTracabilite = item.label.includes("Absence traçabilité");
               const itemsPerRow = isAbsenceTracabilite ? 1 : 2;
               
               // Créer une nouvelle ligne si nécessaire
               if(itemsInRow === 0) {
                  currentRow = document.createElement("div");
                  currentRow.style.display = "grid";
                  currentRow.style.gridTemplateColumns = itemsPerRow === 1 ? "1fr" : "1fr 1fr";
                  currentRow.style.gap = "6px";
                  currentRow.style.marginBottom = "6px";
                  box.appendChild(currentRow);
                  itemsInRow = 0;
               } else if(itemsInRow >= 2) {
                  // Si on a 2 items et qu'on en ajoute un 3e, créer une nouvelle ligne
                  currentRow = document.createElement("div");
                  currentRow.style.display = "grid";
                  currentRow.style.gridTemplateColumns = "1fr 1fr";
                  currentRow.style.gap = "6px";
                  currentRow.style.marginBottom = "6px";
                  box.appendChild(currentRow);
                  itemsInRow = 0;
               }
               
               const lbl = document.createElement("label");
               lbl.className = "cb";
               if(item.color === "ok") {
                 lbl.style.borderColor = "rgba(71,209,140,.3)";
                 lbl.style.color = "var(--ok)";
               } else if(item.color === "orange") {
                 lbl.style.borderColor = "rgba(255,165,0,.3)";
                 lbl.style.color = "#ff8c00";
               }
               lbl.innerHTML = `<input type="checkbox" name="chk_${item.id}" ${item.checked?'checked':''}> ${item.label}`;
               currentRow.appendChild(lbl);
               itemsInRow++;
               
               // Si c'est "Absence traçabilité", reset pour la prochaine ligne
               if(isAbsenceTracabilite) {
                  itemsInRow = 0;
               }
            });
         } else {
            // Layout standard pour autres
            items.forEach(item => {
               const lbl = document.createElement("label");
               lbl.className = "cb";
               if(item.color === "ok") {
                 lbl.style.borderColor = "rgba(71,209,140,.3)";
                 lbl.style.color = "var(--ok)";
               } else if(item.color === "orange") {
                 lbl.style.borderColor = "rgba(255,165,0,.3)";
                 lbl.style.color = "#ff8c00";
               }
               lbl.innerHTML = `<input type="checkbox" name="chk_${item.colIdx}" data-col="${item.colIdx}" ${item.checked?'checked':''} /> ${item.label}`;
               box.appendChild(lbl);
            });
         }
       };

       mkCb("protoAdultBox", schema.protoAdult || []);
       mkCb("protoPediaBox", schema.protoPedia || []);
       
       const c = schema.criteres;
       fillSelect("selAx", c.ax.opts, c.ax.val); document.getElementById("lblAx").textContent = c.ax.label;
       fillSelect("selAy", c.ay.opts, c.ay.val); document.getElementById("lblAy").textContent = c.ay.label;
       fillSelect("selAz", c.az.opts, c.az.val); document.getElementById("lblAz").textContent = c.az.label;
       fillSelect("selBa", c.ba.opts, c.ba.val); document.getElementById("lblBa").textContent = c.ba.label;
       fillSelect("selBb", c.bb.opts, c.bb.val); document.getElementById("lblBb").textContent = c.bb.label;
       
       document.getElementById("lblBc").textContent = c.bc.label;
       document.getElementById("txtBc").value = c.bc.val;
       
       fillSelect("selBg", c.bg.opts, c.bg.val); document.getElementById("lblBg").textContent = c.bg.label;

       const r = schema.resultats;

       mkCb("biBmBox", r.checksBiBm);

       document.getElementById("txtBn").value = schema.fieldBn.val;
       document.getElementById("txtBo").value = schema.fieldBo.val;

       const pbCb = document.getElementById("pbCheck");
       pbCb.checked = !!schema.pbCheck;
       document.getElementById("pbTxt").value = schema.pbTxt; 
       document.getElementById("pbDetails").style.display = schema.pbCheck ? "block" : "none";

       // Ajouter logique conditionnelle pour afficher/masquer les motifs
       updateMotifVisibility();
       
       // Ajouter event listeners sur les checkboxes du résultat
       const checkboxes = document.querySelectorAll('#biBmBox input[type="checkbox"]');
       checkboxes.forEach(cb => {
           cb.addEventListener('change', updateMotifVisibility);
       });
    }

    function updateMotifVisibility() {
       // Récupérer les checkboxes de biBmBox
       const checkboxes = document.querySelectorAll('#biBmBox input[type="checkbox"]');
       let hasBilanIncomplet = false;
       let hasPisuPasOk = false;
       
       checkboxes.forEach(cb => {
           // Chercher le texte du label - peut être dans un span ou directement après l'input
           let labelText = '';
           const parent = cb.closest('label');
           if(parent) {
               labelText = parent.textContent;
           } else if(cb.nextElementSibling) {
               labelText = cb.nextElementSibling.textContent;
           }
           
           labelText = labelText.toLowerCase();
           if(labelText.includes('bilan') && labelText.includes('incomplet')) {
               if(cb.checked) hasBilanIncomplet = true;
           }
           if(labelText.includes('pisu') && labelText.includes('pas ok')) {
               if(cb.checked) hasPisuPasOk = true;
           }
       });
       
       // Afficher/masquer le conteneur des motifs
       const motifContainer = document.getElementById("motifContainer");
       if(hasBilanIncomplet || hasPisuPasOk) {
           motifContainer.style.display = "block";
       } else {
           motifContainer.style.display = "none";
       }
       
       // Afficher/masquer les motifs individuels
       const motifBilanDiv = document.getElementById("motifBilanDiv");
       const motifPisuDiv = document.getElementById("motifPisuDiv");
       if(motifBilanDiv) motifBilanDiv.style.display = hasBilanIncomplet ? "block" : "none";
       if(motifPisuDiv) motifPisuDiv.style.display = hasPisuPasOk ? "block" : "none";
    }

    function fillSelect(id, opts, currentVal) {
       const s = document.getElementById(id);
       s.innerHTML = '<option value="">—</option>';
       if(opts) {
           opts.forEach(o => {
               const op = document.createElement("option");
               op.value = o; op.textContent = o;
               if(String(o) === String(currentVal)) op.selected = true;
               s.appendChild(op);
           });
       }
    }

    function sendApp(){
      if(!currentAppRow){ toast("Erreur: aucune fiche","err"); return; }
      const isp = document.getElementById("ispSelect").value;
      if(!isp) { toast("Veuillez sélectionner l'ISP Analyse","err"); return; }

      isAppSubmitting = true;
      setStatus("Enregistrement..."); setButtons(true);

      const checks = {};
      document.querySelectorAll('input[type="checkbox"][name^="chk_"]').forEach(cb => {
         const dataCol = cb.getAttribute('data-col');
         if(dataCol) {
           checks[parseInt(dataCol)] = cb.checked;
         }
      });

      const payload = {
         rowNumber: currentAppRowNumber,
         isp: isp,
         checks: checks,
         criteres: {
            ax: document.getElementById("selAx").value,
            ay: document.getElementById("selAy").value,
            az: document.getElementById("selAz").value,
            ba: document.getElementById("selBa").value,
            bb: document.getElementById("selBb").value,
            bc: document.getElementById("txtBc").value
         },
         resultats: (function(){
            const res = { bg: document.getElementById("selBg").value };
            document.querySelectorAll('#biBmBox input[type="checkbox"]').forEach(cb => {
               const id = cb.name.replace('chk_','');
               if(id) res[id] = cb.checked;
            });
            return res;
         })(),
         txtBn: document.getElementById("txtBn").value,
         txtBo: document.getElementById("txtBo").value,
         pbCheck: document.getElementById("pbCheck").checked,
         pbTxt: document.getElementById("pbTxt").value
      };

      console.log("Sending saveCase payload:", payload);
      google.script.run.withSuccessHandler((res)=>{ 
          console.log("saveCase success:", res);
          isAppSubmitting = false;
          setStatus("Sauvegardé"); 
          toast("Enregistré et Clôturé ✅"); 
          loadNext(); 
      })
      .withFailureHandler(e=>{ 
          console.error("saveCase error:", e);
          isAppSubmitting = false;
          setStatus("Erreur"); 
          toast("Erreur: " + e.message,"err"); 
          setButtons(false); 
      }).saveCase(payload);
    }

    function skipApp(){ 
        if(!currentAppRow) return; 
        currentAppRow = null;
        loadNext(); 
    }

    // ISP
    let window_currentIspData = {};
    function loginIsp() {
        const m=document.getElementById("matInput").value, d=document.getElementById("dobInput").value;
        if(!m||!d) { toast("Infos manquantes"); return; }
        document.getElementById("ispLoadBox").style.display="inline-block";
        let w=0; const i=setInterval(()=>{ if(w<90) w+=10; document.getElementById("ispFill").style.width=w+"%"; document.getElementById("ispPct").textContent=w+"%"; }, 100);
        google.script.run.withSuccessHandler(res => {
            clearInterval(i); document.getElementById("ispFill").style.width="100%"; document.getElementById("ispPct").textContent="100%";
            setTimeout(()=>document.getElementById("ispLoadBox").style.display="none", 300);
            if(res.error) { toast(res.error); return; }
            document.getElementById("ispLogin").style.display="none";
            document.getElementById("ispData").style.display="block";
            document.getElementById("ispNameDisplay").textContent = res.nom;
            
            setText("ispAst26", Math.ceil(res.astreinte2026)); setText("ispAst25Ytd", Math.ceil(res.astreinte2025_ytd)); setText("ispAst25Tot", res.astreinte2025_tot);
            document.getElementById("ispAstTrend").innerHTML = getTrendHtml(res.astreinte2026, res.astreinte2025_ytd);
            setText("ispGarde26", Math.ceil(res.garde2026)); setText("ispGarde25Ytd", Math.ceil(res.garde2025_ytd)); setText("ispGarde25Tot", res.garde2025_tot);
            document.getElementById("ispGardeTrend").innerHTML = getTrendHtml(res.garde2026, res.garde2025_ytd);
            setText("ispInter26", res.inter2026); setText("ispInter25Ytd", res.inter2025_ytd); setText("ispInter25Tot", res.inter2025_tot);
            document.getElementById("ispInterTrend").innerHTML = getTrendHtml(res.inter2026, res.inter2025_ytd);
            
            setText("ispBilanOk", (res.bilanOkCount||0)); setText("ispPisuOk", (res.pisuOkCount||0));
            setText("ispErrBil", (res.errLegereBilan||[]).length); setText("ispErrPisu", (res.errLegerePisu||[]).length); setText("ispErrLourd", (res.errLourde||[]).length);
            
            // Monthly breakdown
            const moisNoms = ['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
            const mA = res.monthlyAst26 || new Array(12).fill(0);
            const mG = res.monthlyGarde26 || new Array(12).fill(0);
            document.getElementById("ispMonthlyTbody").innerHTML = moisNoms.map((m, i) => {
                const a = Math.ceil(mA[i]), g = Math.ceil(mG[i]);
                if(a === 0 && g === 0) return '';
                return `<tr style="border-bottom:1px solid #333;"><td style="padding:2px 4px;">${m}</td><td style="text-align:right;padding:2px 4px;">${a}h</td><td style="text-align:right;padding:2px 4px;">${g}h</td></tr>`;
            }).join('');

            const txSoll = Number(res.txSoll);
            setText("ispSollTx", isFinite(txSoll) ? (txSoll*100).toFixed(1) + "%" : "—");

            const h = res.histTempsTravail || {};
            const histRow = [h.y2019, h.y2020, h.y2021, h.y2022, h.y2023, h.y2024, h.y2025].map(v => (v==null || v==="") ? "—" : v);
            document.getElementById("ispHistTbody").innerHTML = `<tr>${histRow.map(v => `<td class="num">${v}</td>`).join('')}</tr>`;
            
            window_currentIspData = res;
        }).getIspStats(m, d);
    }
    function logoutIsp(){ document.getElementById("ispData").style.display="none"; document.getElementById("ispLogin").style.display="flex"; window_currentIspData={}; currentDetailList=[]; }
    
    function refreshIspData() {
        const mat = document.getElementById("matInput").value;
        if(!mat) { toast("Matricule requis"); return; }
        // Fermer le modal s'il est ouvert
        document.getElementById("modalList").style.display = "none";
        currentDetailList = []; // Vider la liste en cache
        google.script.run.withSuccessHandler(() => {
            toast("Cache vidé - rechargement...");
            loginIsp();
        }).clearIspCache(mat);
    }

    function openErrorList(type) {
        if(!window_currentIspData || !window_currentIspData.nom) return;
        
        // Récupérer le matricule depuis les inputs
        const mat = document.getElementById("matInput").value;
        if(!mat) { toast("Matricule requis"); return; }
        
        const typeMap = {
            'Bilan': 'Bilan OK',
            'Pisu': 'Pisu OK',
            'BilanLeg': 'Erreur Bilan Légère',
            'PisuLeg': 'Erreur Pisu Légère',
            'Grave': 'Erreur Grave'
        };
        const filterValue = typeMap[type] || "";
        
        // Toujours s'assurer que le filterBox est visible
        document.getElementById('filterBox').style.display = '';
        
        // Si les données sont déjà chargées ET le modal est visible, juste mettre à jour les checkboxes
        if(currentDetailList && currentDetailList.length > 0 && document.getElementById("modalList").style.display === "flex") {
            // Cocher seulement le type cliqué
            document.querySelectorAll('#filterBox input[type="checkbox"]').forEach(cb => {
                cb.checked = cb.value === filterValue;
            });
            filterDetails();
            return; // Pas besoin de recharger les données
        }
        
        // Chargement: charger TOUTES les données fraîches
        google.script.run.withSuccessHandler(fullList => {
            // Stocker toutes les données en mémoire pour filtrage côté client
            currentDetailList = fullList;
            
            // Cocher seulement le type cliqué
            document.querySelectorAll('#filterBox input[type="checkbox"]').forEach(cb => {
                cb.checked = cb.value === filterValue;
            });
            
            document.getElementById("modalListTitle").textContent = `Dossiers de ${window_currentIspData.nom}`;
            filterDetails();
            document.getElementById("modalList").style.display="flex";
        }).getIspDetailsAdmin(mat);
    }

    // ADMIN
    let adminDataCache = [], adminSortDir = -1, adminSortCol = 1;
    function loadAdmin() {
        if(document.getElementById("adminPwd").value!=="0007") { toast("Erreur code"); return; }
        
        document.getElementById("adminLogin").style.display="none";
        document.getElementById("adminLoadBox").style.display="block";
        
        let w=0; 
        const i=setInterval(()=>{ 
            if(w<90) w+=8; 
            document.getElementById("adminFill").style.width=w+"%"; 
            document.getElementById("adminPct").textContent=w+"%"; 
        }, 120);
        
        google.script.run.withSuccessHandler(res => {
            clearInterval(i); 
            document.getElementById("adminFill").style.width="100%"; 
            document.getElementById("adminPct").textContent="100%";
            setTimeout(()=> { 
                document.getElementById("adminLoadBox").style.display="none"; 
                document.getElementById("adminData").style.display="block"; 
            }, 300);
            
            adminDataCache = res.activity.map(a => ({ 0:a.nom, 1:a.interHg26, 2:a.interHg25, 3:a.interG26, 4:a.interG25, 5:a.hAst26, 6:a.hAst25, 7:a.hGarde26, 8:a.hGarde25 }));
            renderAdminTable();
            document.getElementById("adminSollTbody").innerHTML = res.sollicitation.map(s => `<tr><td>${s.nom}</td><td class="num"><b>${s.tx}</b></td></tr>`).join('');
            
            // Monthly table
            if(res.monthly && res.monthly.length) {
                document.getElementById("adminMonthlyTbody").innerHTML = res.monthly.map(r => {
                    const cells = r.months.map(v => `<td class="num">${v||''}</td>`).join('');
                    return `<tr><td><b>${r.nom}</b></td>${cells}<td class="num" style="font-weight:bold;">${r.total}</td></tr>`;
                }).join('');
            }
            
            // Astreinte départementale ISPP
            google.script.run.withSuccessHandler(function(data) {
                if (data && data.length) {
                    document.getElementById("adminAstreinteDeptTbody").innerHTML = data.map(r => {
                        const cells = r.months.map(v => '<td class="num">' + (v || '') + '</td>').join('');
                        return '<tr><td><b>' + r.nom + '</b></td>' + cells + '<td class="num" style="font-weight:bold;">' + r.total + '</td></tr>';
                    }).join('');
                }
            }).getAstreinteISPP();

            // Historique temps travail (2019-2025)
            google.script.run.withSuccessHandler(function(rows) {
                if (rows && rows.length) {
                    document.getElementById("adminHistTbody").innerHTML = rows.map(r => {
                        return '<tr><td style="text-align:left;white-space:nowrap"><b>' + r.nom + '</b></td>' +
                            '<td style="text-align:right;font-family:monospace">' + (r.y2019 || '') + '</td>' +
                            '<td style="text-align:right;font-family:monospace">' + (r.y2020 || '') + '</td>' +
                            '<td style="text-align:right;font-family:monospace">' + (r.y2021 || '') + '</td>' +
                            '<td style="text-align:right;font-family:monospace">' + (r.y2022 || '') + '</td>' +
                            '<td style="text-align:right;font-family:monospace">' + (r.y2023 || '') + '</td>' +
                            '<td style="text-align:right;font-family:monospace">' + (r.y2024 || '') + '</td>' +
                            '<td style="text-align:right;font-family:monospace">' + (r.y2025 || '') + '</td>' +
                            '</tr>';
                    }).join('');
                }
            }).getHistoriqueTempsTravailAdmin();
            
            // Remplir tableaux CIS et Secteurs depuis getStats2025() pour avoir les bonnes données YTD
            google.script.run.withSuccessHandler(stats25 => {
                // Récupérer les comptages 2025 YTD depuis cisMap et sectMap
                const cisNames = Object.keys(stats25.cisMap || {});
                const sectNames = Object.keys(stats25.sectMap || {});
                
                // Récupérer aussi les totaux 2026 et 2025 total depuis getStats2026
                google.script.run.withSuccessHandler(stats26 => {
                    // Combiner les données: cisMap pour 2025 YTD, cis array pour 2026 et 2025 total
                    const cisData = (stats26.cis || []).map(x => ({
                        name: x.name,
                        v26: x.v26,
                        v25ytd: stats25.cisMap[x.name] || 0,
                        v25tot: x.v25tot
                    }));
                    const sectData = (stats26.secteurs || []).map(x => ({
                        name: x.name,
                        v26: x.v26,
                        v25ytd: stats25.sectMap[x.name] || 0,
                        v25tot: x.v25tot
                    }));
                    
                    // Trier par 2026 décroissant
                    const cisSorted = cisData.sort((a,b) => b.v26 - a.v26);
                    const sectSorted = sectData.sort((a,b) => b.v26 - a.v26);
                    
                    document.querySelector("#tableAdminCis tbody").innerHTML = cisSorted.map(x => `<tr><td>${x.name}</td><td class="num"><b>${x.v26}</b></td><td class="num" style="color:gray">${x.v25ytd}</td><td class="num" style="color:gray">${x.v25tot}</td></tr>`).join('');
                    document.querySelector("#tableAdminSect tbody").innerHTML = sectSorted.map(x => `<tr><td>${x.name}</td><td class="num"><b>${x.v26}</b></td><td class="num" style="color:gray">${x.v25ytd}</td><td class="num" style="color:gray">${x.v25tot}</td></tr>`).join('');
                }).getStats2026();
            }).getStats2025();
        }).withFailureHandler(e => {
            clearInterval(i);
            toast("Erreur: " + e.message);
            document.getElementById("adminLoadBox").style.display="none";
            document.getElementById("adminLogin").style.display="flex";
        }).getAdminData("0007");
    }
    
    function renderAdminTable() {
        document.getElementById("adminTbody").innerHTML = adminDataCache.map(r => `<tr><td><b>${r[0]}</b></td><td class="num"><b>${r[1]}</b></td><td class="num" style="color:gray">${r[2]}</td><td class="num"><b>${r[3]}</b></td><td class="num" style="color:gray">${r[4]}</td><td class="num"><b>${Math.ceil(r[5])}</b></td><td class="num" style="color:gray">${Math.ceil(r[6])}</td><td class="num"><b>${Math.ceil(r[7])}</b></td><td class="num" style="color:gray">${Math.ceil(r[8])}</td></tr>`).join('');
    }
    
    function sortAdmin(colIdx) {
        if(adminSortCol === colIdx) adminSortDir *= -1; else { adminSortCol = colIdx; adminSortDir = colIdx===0?1:-1; }
        adminDataCache.sort((a,b) => { let v1=a[colIdx], v2=b[colIdx]; if(typeof v1==='string'){v1=v1.toLowerCase();v2=v2.toLowerCase();} if(v1>v2)return adminSortDir; if(v1<v2)return -adminSortDir; return 0; });
        for(let i=0; i<9; i++) document.getElementById("sortA"+i).textContent="↕";
        document.getElementById("sortA"+colIdx).textContent = adminSortDir===1 ? "▲" : "▼";
        renderAdminTable();
    }
    
    function filterAdmin() {
        const terms = document.getElementById("adminSearch").value.toLowerCase().split(';').map(t=>t.trim()).filter(t=>t);
        document.querySelectorAll("#adminTbody tr").forEach(r => {
            const txt = r.innerText.toLowerCase();
            r.style.display = (terms.length===0 || terms.some(t => txt.includes(t))) ? "" : "none";
        });
        document.querySelectorAll("#adminSollTbody tr").forEach(r => {
            const txt = r.innerText.toLowerCase();
            r.style.display = (terms.length===0 || terms.some(t => txt.includes(t))) ? "" : "none";
        });
    }

    // === NOUVELLE INTERFACE CHEFFERIE ===
    let currentChefData = null;
    
    function showChefferieMode(mode) {
        // Masquer tous les modes
        document.getElementById('chefModeApp').style.display = 'none';
        document.getElementById('chefModeMed').style.display = 'none';
        document.getElementById('chefModeAction').style.display = 'none';
        document.getElementById('chefModeData').style.display = 'none';
        
        if(mode === 'app') {
            document.getElementById('chefModeApp').style.display = 'block';
            loadAppChefferie();
        } else if(mode === 'med') {
            document.getElementById('chefModeMed').style.display = 'block';
            loadMedecinChef();
        } else if(mode === 'action') {
            document.getElementById('chefModeAction').style.display = 'block';
            loadActionChefferie();
        } else if(mode === 'data') {
            document.getElementById('chefModeData').style.display = 'block';
            loadGlobalList();
        }
    }
    
    function loadChefferieCounts() {
        google.script.run.withSuccessHandler(res => {
            if(res) {
                setText("cntIspGBadge", res.isp||0);
                setText("cntMedBadge", res.med||0);
                setText("cntActionBadge", res.action||0);
                setText("btnBadgeIspG", res.isp||0);
                setText("btnBadgeMed", res.med||0);
                setText("btnBadgeAction", res.action||0);
            }
        }).getChefferieCounts();
    }
    
    function loadAppChefferie() {
        const div = document.getElementById('chefAppContent');
        div.innerHTML = '<div style="text-align:center;padding:40px;color:gray;">Chargement...</div>';
        
        google.script.run.withSuccessHandler(res => {
            if(!res.found) {
                div.innerHTML = `<div style="text-align:center;padding:40px;color:var(--accent3);">${res.message}</div>`;
                return;
            }
            currentChefData = res;
            renderAppChefferie(res);
        }).getNextAppChefferie();
    }
    
    function renderAppChefferie(data) {
        const div = document.getElementById('chefAppContent');
        const info = data.info;
        
        div.innerHTML = `
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; height:calc(100vh - 200px);">
                <!-- PDF à gauche -->
                <div style="border:1px solid var(--border); border-radius:12px; overflow:hidden;">
                    <iframe src="${(info.pdf||'').replace('/view','/preview')}" style="width:100%; height:100%; border:none; position:relative;"></iframe>
                </div>
                
                <!-- Formulaire à droite -->
                <div style="overflow-y:auto; padding:15px;">
                    <div class="panel">
                        <div class="panelHead">Fiche Intervention</div>
                        <div class="panelBody">
                            <div style="margin-bottom:10px;"><strong>ID:</strong> ${info.interId}</div>
                            <div style="margin-bottom:10px;"><strong>Date:</strong> ${info.date}</div>
                            <div style="margin-bottom:10px;"><strong>ISP:</strong> ${info.infName}</div>
                            <div style="margin-bottom:10px;"><strong>Statut:</strong> ${info.status}</div>
                            <div style="margin-bottom:10px;"><strong>Motif:</strong> ${info.motif}</div>
                            <div style="margin-bottom:10px;"><strong>Engin:</strong> ${info.engin}</div>
                        </div>
                    </div>
                    
                    ${info.bilanKo ? `<div class="panel" style="margin-top:15px;">
                        <div class="panelHead">Motif Bilan Incomplet (lecture seule)</div>
                        <div class="panelBody">
                            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:6px; font-size:12px;">${info.motifBilan || 'Aucun motif renseigné'}</div>
                        </div>
                    </div>` : ''}
                    
                    ${info.pisuKo ? `<div class="panel" style="margin-top:15px;">
                        <div class="panelHead">Motif Pisu Incomplet (lecture seule)</div>
                        <div class="panelBody">
                            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:6px; font-size:12px;">${info.motifPisu || 'Aucun motif renseigné'}</div>
                        </div>
                    </div>` : ''}
                    
                    <div class="panel" style="margin-top:15px;">
                        <div class="panelHead">Côter la fiche</div>
                        <div class="panelBody">
                            <label class="cb" style="background:rgba(71,209,140,.1); border-color:rgba(71,209,140,.3); margin-bottom:8px;">
                                <input type="checkbox" id="chkH" ${data.checks.H?'checked':''}>
                                <span style="color:var(--ok);">✓ Passer Bilan en OK</span>
                            </label>
                            <label class="cb" style="background:rgba(71,209,140,.1); border-color:rgba(71,209,140,.3); margin-bottom:8px;">
                                <input type="checkbox" id="chkI" ${data.checks.I?'checked':''}>
                                <span style="color:var(--ok);">✓ Passer Pisu en OK</span>
                            </label>
                            <label class="cb" style="background:rgba(255,165,0,.1); border-color:rgba(255,165,0,.3); margin-bottom:8px;">
                                <input type="checkbox" id="chkJ" ${data.checks.J?'checked':''}>
                                <span style="color:orange;">⚠ Erreur Bilan Légère</span>
                            </label>
                            <label class="cb" style="background:rgba(255,165,0,.1); border-color:rgba(255,165,0,.3); margin-bottom:8px;">
                                <input type="checkbox" id="chkK" ${data.checks.K?'checked':''}>
                                <span style="color:orange;">⚠ Erreur Pisu Légère</span>
                            </label>
                            <label class="cb" style="background:rgba(255,107,107,.1); border-color:rgba(255,107,107,.3); margin-bottom:8px;">
                                <input type="checkbox" id="chkL" ${data.checks.L?'checked':''}>
                                <span style="color:var(--danger);">🚨 Erreur Grave</span>
                            </label>
                            
                            <div style="margin-top:15px;">
                                <label style="display:block; margin-bottom:5px; font-size:11px; font-weight:bold;">Commentaire Chefferie</label>
                                <textarea id="txtCommentChef" style="width:100%; min-height:80px;">${data.commentChef}</textarea>
                            </div>
                            
                            <div style="margin-top:20px; display:flex; gap:10px;">
                                <button class="btn ok" style="flex:1;" onclick="saveAndNextAppChef()">💾 Clôturer et Suivant</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function saveAndNextAppChef() {
        const form = {
            interId: currentChefData.info.interId,
            rowAlex: currentChefData.rowAlex,
            checks: {
                H: document.getElementById('chkH').checked,
                I: document.getElementById('chkI').checked,
                J: document.getElementById('chkJ').checked,
                K: document.getElementById('chkK').checked,
                L: document.getElementById('chkL').checked
            },
            commentChef: document.getElementById('txtCommentChef').value
        };
        
        document.getElementById('chefAppContent').innerHTML = '<div style="text-align:center;padding:40px;">Enregistrement...</div>';
        
        google.script.run.withSuccessHandler(() => {
            toast("Fiche clôturée ✅");
            loadChefferieCounts(); // Mettre à jour les badges
            loadAppChefferie(); // Charger la suivante
        }).withFailureHandler(e => {
            toast("Erreur: " + e.message, "err");
            loadAppChefferie();
        }).saveAppChefferie(form);
    }
    
    function loadMedecinChef() {
        const div = document.getElementById('chefMedContent');
        div.innerHTML = '<div style="text-align:center;padding:40px;color:gray;">Chargement...</div>';
        
        google.script.run.withSuccessHandler(res => {
            if(!res.found) {
                div.innerHTML = `<div style="text-align:center;padding:40px;color:var(--accent3);">${res.message}</div>`;
                return;
            }
            currentChefData = res;
            renderMedecinChef(res);
        }).getNextMedecinChef();
    }
    
    function renderMedecinChef(data) {
        const div = document.getElementById('chefMedContent');
        const info = data.info;
        
        div.innerHTML = `
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; height:calc(100vh - 200px);">
                <!-- PDF à gauche -->
                <div style="border:1px solid var(--border); border-radius:12px; overflow:hidden;">
                    <iframe src="${(info.pdf||'').replace('/view','/preview')}" style="width:100%; height:100%; border:none; position:relative;"></iframe>
                </div>
                
                <!-- Formulaire à droite -->
                <div style="overflow-y:auto; padding:15px;">
                    <div class="panel">
                        <div class="panelHead" style="background:rgba(255,107,107,.2);">⚠️ Erreur Grave</div>
                        <div class="panelBody">
                            <div style="margin-bottom:10px;"><strong>ID:</strong> ${info.interId}</div>
                            <div style="margin-bottom:10px;"><strong>Date:</strong> ${info.date}</div>
                            <div style="margin-bottom:10px;"><strong>ISP:</strong> ${info.infName}</div>
                            <div style="margin-bottom:10px;"><strong>Statut:</strong> ${info.status}</div>
                            <div style="margin-bottom:10px;"><strong>Motif:</strong> ${info.motif}</div>
                            <div style="margin-bottom:10px;"><strong>Engin:</strong> ${info.engin}</div>
                        </div>
                    </div>
                    
                    ${info.commentChef ? `<div class="panel" style="margin-top:15px;">
                        <div class="panelHead">Commentaire Chefferie</div>
                        <div class="panelBody">
                            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:6px; font-size:12px;">${info.commentChef}</div>
                        </div>
                    </div>` : ''}
                    
                    <div class="panel" style="margin-top:15px;">
                        <div class="panelHead">Analyse Médecin Cheffe</div>
                        <div class="panelBody">
                            <div style="margin-bottom:15px;">
                                <label style="display:block; margin-bottom:5px; font-size:11px; font-weight:bold;">Analyse</label>
                                <textarea id="txtAnalyse" style="width:100%; min-height:100px;" placeholder="Votre analyse de l'erreur grave..."></textarea>
                            </div>
                            
                            <div>
                                <label style="display:block; margin-bottom:5px; font-size:11px; font-weight:bold;">Action Requise</label>
                                <textarea id="txtAction" style="width:100%; min-height:80px;" placeholder="Actions à mener..."></textarea>
                            </div>
                            
                            <div style="margin-top:20px;">
                                <button class="btn ok" style="width:100%;" onclick="saveAndNextMedChef()">💾 Enregistrer et Suivant</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function saveAndNextMedChef() {
        const form = {
            interId: currentChefData.info.interId,
            analyse: document.getElementById('txtAnalyse').value,
            action: document.getElementById('txtAction').value
        };
        
        document.getElementById('chefMedContent').innerHTML = '<div style="text-align:center;padding:40px;">Enregistrement...</div>';
        
        google.script.run.withSuccessHandler(() => {
            toast("Analyse enregistrée ✅");
            loadChefferieCounts(); // Mettre à jour les badges
            loadMedecinChef(); // Charger la suivante
        }).withFailureHandler(e => {
            toast("Erreur: " + e.message, "err");
            loadMedecinChef();
        }).saveMedecinAnalyse(form);
    }

    // === ACTION CHEFFERIE ===
    function loadActionChefferie() {
        const div = document.getElementById('chefActionContent');
        div.innerHTML = '<div style="text-align:center;padding:40px;color:gray;">Chargement...</div>';
        
        google.script.run.withSuccessHandler(res => {
            if(!res.found) {
                div.innerHTML = `<div style="text-align:center;padding:40px;color:var(--accent3);">${res.message}</div>`;
                return;
            }
            currentChefData = res;
            renderActionChefferie(res);
        }).getNextActionChefferie();
    }
    
    function renderActionChefferie(data) {
        const div = document.getElementById('chefActionContent');
        const info = data.info;
        
        div.innerHTML = `
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; height:calc(100vh - 200px);">
                <div style="border:1px solid var(--border); border-radius:12px; overflow:hidden;">
                    <iframe src="${(info.pdf||'').replace('/view','/preview')}" style="width:100%; height:100%; border:none; position:relative;"></iframe>
                </div>
                <div style="overflow-y:auto; padding:15px;">
                    <div class="panel">
                        <div class="panelHead" style="background:rgba(255,165,0,.2);">🎯 Action Chefferie</div>
                        <div class="panelBody">
                            <div style="margin-bottom:10px;"><strong>ID:</strong> ${info.interId}</div>
                            <div style="margin-bottom:10px;"><strong>Date:</strong> ${info.date}</div>
                            <div style="margin-bottom:10px;"><strong>ISP:</strong> ${info.infName}</div>
                            <div style="margin-bottom:10px;"><strong>Statut:</strong> ${info.status}</div>
                            <div style="margin-bottom:10px;"><strong>Motif:</strong> ${info.motif}</div>
                            <div style="margin-bottom:10px;"><strong>Engin:</strong> ${info.engin}</div>
                        </div>
                    </div>
                    
                    ${info.commChef ? `<div class="panel" style="margin-top:15px;">
                        <div class="panelHead">Commentaire Chefferie</div>
                        <div class="panelBody">
                            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:6px; font-size:12px;">${info.commChef}</div>
                        </div>
                    </div>` : ''}
                    
                    ${info.analyseMed ? `<div class="panel" style="margin-top:15px;">
                        <div class="panelHead" style="color:var(--red);">Analyse Médecin</div>
                        <div class="panelBody">
                            <div style="background:rgba(255,107,107,0.1); padding:10px; border-radius:6px; font-size:12px; color:var(--red);">${info.analyseMed}</div>
                        </div>
                    </div>` : ''}
                    
                    ${info.actionRequise ? `<div class="panel" style="margin-top:15px;">
                        <div class="panelHead" style="color:var(--orange);">Action Requise par Médecin</div>
                        <div class="panelBody">
                            <div style="background:rgba(255,165,0,0.1); padding:10px; border-radius:6px; font-size:12px; color:var(--orange);">${info.actionRequise}</div>
                        </div>
                    </div>` : ''}
                    
                    <div class="panel" style="margin-top:15px;">
                        <div class="panelHead">Action Réalisée</div>
                        <div class="panelBody">
                            <textarea id="txtActionFaite" style="width:100%; min-height:100px;" placeholder="Décrivez l'action réalisée...">${info.actionFaite || ''}</textarea>
                            <div style="margin-top:20px;">
                                <button class="btn ok" style="width:100%;" onclick="saveAndNextAction()">💾 Clôturer et Suivant</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function saveAndNextAction() {
        const form = {
            rowEve: currentChefData.rowEve,
            actionFaite: document.getElementById('txtActionFaite').value
        };
        
        if(!form.actionFaite) { toast("Veuillez décrire l'action réalisée"); return; }
        
        document.getElementById('chefActionContent').innerHTML = '<div style="text-align:center;padding:40px;">Enregistrement...</div>';
        
        google.script.run.withSuccessHandler(res => {
            if(res.success) {
                toast("Action clôturée");
                refreshChefferieBadges();
                loadActionChefferie();
            } else {
                toast("Erreur: " + (res.error||"inconnue"), "err");
                loadActionChefferie();
            }
        }).withFailureHandler(e => {
            toast("Erreur: " + e.message, "err");
            loadActionChefferie();
        }).saveActionChefferie(form);
    }
    
    function refreshChefferieBadges() {
        google.script.run.withSuccessHandler(res => {
            if(res) {
                setText("cntIspGBadge", res.isp||0);
                setText("cntMedBadge", res.med||0);
                setText("cntActionBadge", res.action||0);
                setText("btnBadgeIspG", res.isp||0);
                setText("btnBadgeMed", res.med||0);
                setText("btnBadgeAction", res.action||0);
            }
        }).getChefferieCounts();
    }

    // CHEFFERIE (ANCIENNE - à garder pour compatibilité)
    let currentSchema = null;
    function hideGlobal() { document.getElementById("globalListArea").style.display="none"; document.getElementById("chefFormArea").style.display="block"; }
    function loadChefCase(mode) {
        const area = (mode==='med_chef') ? 'medFormArea' : 'chefFormArea';
        document.getElementById(area).innerHTML = "<div style='text-align:center;padding:50px;color:gray'>Chargement...</div>";
        google.script.run.withSuccessHandler(res => {
            if(res.done) { document.getElementById(area).innerHTML = `<div style='text-align:center;padding:50px;color:var(--accent3)'>${res.message}</div>`; return; }
            currentSchema = res;
            renderChefForm(res, area);
        }).getChefferieNextCase(mode);
    }
    
    function renderChefForm(s, areaId) {
        const i = s.info;
        const html = `
        <div style="height:100%;">
            <div class="info-banner">
                <div class="info-banner-row"><span>N° Inter: <b>${i.interId}</b></span> <span>ISP: <b>${i.infName}</b></span></div>
                <div class="info-banner-row"><span>Motif: <b>${i.motif || '—'}</b></span> <span>${i.date}</span></div>
            </div>
            <div class="chef-layout">
                <div class="chef-pdf"><iframe src="${(i.pdf||'').replace('/view','/preview')}" style="width:100%;height:100%;border:0"></iframe></div>
                <div class="chef-form">
                    ${s.mode==='app_isp' ? `
                       <div><label>Commentaire ISP</label><div class="static-box">${i.commBN||"-"}</div></div>
                       <div><label>Checklist Qualité</label><div class="check-list">
                          ${s.checks.map((c,k) => {
                              let cls = ""; if(c.label.includes("OK")) cls="chk-green"; if(c.label.includes("KO")) cls="chk-red";
                              const checked = c.checked ? " checked" : "";
                              return `<div class="check-item ${cls}"><input type="checkbox" id="chk_${k}" name="check_${c.id}"${checked}> ${c.label}</div>`;
                          }).join('')}
                       </div></div>
                       <div><label>Commentaire Chefferie</label><textarea id="chefComm">${s.existingComment||""}</textarea></div>
                       <button class="btnGo" onclick="sendChef()">Valider</button>
                    ` : s.mode==='med_chef' ? `
                       <div><label>Analyse</label><div class="static-box">${i.motif||"-"}</div></div>
                       <div><label>Analyse Médecin</label><textarea id="medAnalyse"></textarea></div>
                       <div><label>Actions</label><textarea id="medAction"></textarea></div>
                       <button class="btnGo" onclick="sendChef()">Valider</button>
                    ` : `<div>Formulaire non défini</div>`}
                </div>
            </div>
        </div>`;
        document.getElementById(areaId).innerHTML = html;
    }
    
    function sendChef() {
        if(!currentSchema) return;
        const s = currentSchema;
        const payload = { mode:s.mode, info:s.info };
        if(s.mode==='app_isp') {
            payload.comment = document.getElementById("chefComm").value;
            if(!payload.comment) { toast("Commentaire requis"); return; }
            payload.checks = {};
            s.checks.forEach((c,k) => {
                const chk = document.getElementById("chk_"+k);
                if(chk) payload.checks[c.id] = chk.checked;
            });
        } else if(s.mode==='med_chef') {
            payload.analyse = document.getElementById("medAnalyse").value;
            payload.action = document.getElementById("medAction").value;
        }
        const areaId = (s.mode==='med_chef') ? 'medFormArea' : 'chefFormArea';
        document.getElementById(areaId).innerHTML = "<div style='text-align:center;padding:50px'>Enregistrement...</div>";
        google.script.run.withSuccessHandler(() => { toast("Enregistré"); loadChefCase(s.mode); }).saveChefferie(payload);
    }

    // LIST & SORT
    let globalList = [], currentDetailList = [], currentDetailIspName = "";
    let sortDir = 1;
    function loadGlobalList() {
        const tbody = document.getElementById("globalTbody");
        if(!tbody) return;
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;color:gray;">Chargement...</td></tr>';
        
        google.script.run.withSuccessHandler(res => {
            globalList = res;
            renderGlobalTable(res);
        }).getAllIspErrorStats();
    }
    
    function renderGlobalTable(data) {
        document.getElementById("globalTbody").innerHTML = data.map(r => `
          <tr onclick="loadIspDetail('${r.mat}', '${r.nom}')"><td><b>${r.nom}</b></td><td class="text-green">${r.bilanOk}</td><td class="text-green">${r.pisuOk}</td><td class="text-orange">${r.errBilL}</td><td class="text-orange">${r.errPisuL}</td><td class="text-red">${r.errGrave}</td></tr>
        `).join('');
    }
    
    function sortGlobal(idx) {
        sortDir *= -1;
        const keys = ['nom', 'bilanOk', 'pisuOk', 'errBilL', 'errPisuL', 'errGrave'];
        const k = keys[idx];
        globalList.sort((a,b) => { if(a[k]>b[k]) return sortDir; if(a[k]<b[k]) return -sortDir; return 0; });
        for(let i=0; i<6; i++) document.getElementById("sortIcon"+i).textContent="↕";
        document.getElementById("sortIcon"+idx).textContent = sortDir===1 ? "▼" : "▲";
        renderGlobalTable(globalList);
    }
    
    function loadIspDetail(mat, ispName) {
        currentDetailIspName = ispName || mat;
        startLoad();
        google.script.run.withSuccessHandler(list => {
            stopLoad();
            currentDetailList = list;
            document.getElementById('filterBox').style.display = 'flex';
            document.querySelectorAll('#filterBox input[type="checkbox"]').forEach(cb => cb.checked = true);
            document.getElementById("modalListTitle").textContent = `Dossiers de ${ispName || mat}`;
            filterDetails();
            document.getElementById("modalList").style.display="flex";
        }).getIspDetailsAdmin(mat);
    }

    function loadAllGraveErrors() {
        startLoad();
        let allGraveList = [];
        let loaded = 0;
        let totalIsps = globalList.length;

        if(totalIsps === 0) { toast("Aucune donnée"); stopLoad(); return; }

        globalList.forEach(isp => {
            google.script.run.withSuccessHandler(list => {
                loaded++;
                const graveErrors = list.filter(x => x.errorType === "Erreur Grave");
                graveErrors.forEach(e => {
                    e.ispName = isp.nom;
                });
                allGraveList = allGraveList.concat(graveErrors);

                if(loaded === totalIsps) {
                    stopLoad();
                    currentDetailList = allGraveList;
                    document.querySelectorAll('#filterBox input[type="checkbox"]').forEach(cb => {
                        cb.checked = cb.value === "Erreur Grave";
                    });
                    document.getElementById("modalListTitle").textContent = "Toutes les fiches en erreur grave";
                    filterDetails();
                    document.getElementById("modalList").style.display="flex";
                }
            }).getIspDetailsAdmin(isp.mat);
        });
    }
    
    function filterDetails() {
        const filters = Array.from(document.querySelectorAll('input[type=checkbox]:checked')).map(c=>c.value);
        const c = document.getElementById("modalListContent"); 
        c.innerHTML="";
        const filtered = currentDetailList.filter(x => x.types.some(t => filters.includes(t)));
        if(filtered.length===0) { c.innerHTML="<div style='padding:20px;text-align:center;color:gray'>Aucun dossier</div>"; return; }
        filtered.forEach(x => {
            const tagHtml = x.types.map(t => {
                let tagBg = "#47d18c", tagColor = "white";
                if(t.includes("Grave")) { tagBg = "#d32f2f"; }
                else if(t.includes("Légère")) { tagBg = "#ff9800"; }
                return `<span style="display:inline-block;padding:3px 8px;border-radius:3px;font-size:10px;font-weight:bold;background:${tagBg};color:${tagColor};margin-left:4px;">${t}</span>`;
            }).join('');
            const ispLabel = x.ispName ? `<div style="font-size:10px;color:var(--accent3);margin-top:4px;">ISP: <b>${x.ispName}</b></div>` : '';
            const idx = currentDetailList.indexOf(x);
            const div = document.createElement('div');
            div.className = 'detail-row';
            div.style.cssText = 'padding:12px;border-bottom:1px solid #333;cursor:pointer;';
            div.onclick = function(){ loadInterDetail(idx); };
            div.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
                    <div style="flex:1;">
                        <div style="font-weight:bold;color:#39ff14;font-size:13px;">Numéro d'intervention: ${x.id}</div>
                        <div style="font-size:10px;color:#aaa;margin-top:3px;">Date: <b>${x.date || '-'}</b></div>
                    </div>
                    <div style="margin-left:10px;">${tagHtml}</div>
                </div>
                <div style="font-size:12px;color:#ccc;margin-bottom:6px;"><b>Motif: ${x.motif || '-'}</b></div>
                <div style="font-size:10px;color:#aaa;margin-bottom:3px;">Type: <b>${x.status || '-'}</b></div>
                <div style="font-size:10px;color:#aaa;">Engin: <b>${x.engin || '-'}</b></div>
                ${ispLabel}
                ${x.commChef ? `<div style="font-size:10px;color:var(--accent3);margin-top:4px;">Chef: ${x.commChef}</div>` : ''}
                ${x.commMed ? `<div style="font-size:10px;color:var(--red);">Med: ${x.commMed}</div>` : ''}
            `;
            c.appendChild(div);
        });
    }
    
    function showErrorsByType(errorType) {
        if(!globalList || globalList.length === 0) { toast("Chargez d'abord les donn\u00e9es"); return; }
        
        document.getElementById("modalListTitle").textContent = errorType + ' \u2014 par ISP';
        document.getElementById('filterBox').style.display = 'none';
        const c = document.getElementById("modalListContent");
        c.innerHTML = '<div style="padding:30px;text-align:center;color:gray;">Chargement des donn\u00e9es...</div>';
        document.getElementById("modalList").style.display = "flex";
        
        let colorMap = { 'Erreur Grave': 'var(--red)', 'Erreur Pisu L\u00e9g\u00e8re': 'var(--orange)', 'Erreur Bilan L\u00e9g\u00e8re': 'var(--orange)' };
        let color = colorMap[errorType] || 'var(--red)';
        
        let loaded = 0;
        let totalIsps = globalList.length;
        let ispResults = [];
        
        globalList.forEach(isp => {
            google.script.run.withSuccessHandler(list => {
                loaded++;
                const matched = list.filter(x => x.types.some(t => t === errorType));
                if(matched.length > 0) {
                    ispResults.push({ nom: isp.nom, mat: isp.mat, count: matched.length, fiches: matched });
                }
                if(loaded === totalIsps) {
                    ispResults.sort((a,b) => b.count - a.count);
                    if(ispResults.length === 0) {
                        c.innerHTML = '<div style="padding:30px;text-align:center;color:gray;">Aucun ISP avec ce type d\'erreur</div>';
                        return;
                    }
                    let tagBg = errorType.includes('Grave') ? '#d32f2f' : '#ff9800';
                    c.innerHTML = ispResults.map(r => {
                        let fichesHtml = r.fiches.map(x => {
                            let safeMotif = (x.motif||'').replace(/'/g, "\\'");
                            let safeDate = (x.date||'').replace(/'/g, "\\'");
                            let safeStatus = (x.status||'').replace(/'/g, "\\'");
                            let safeCentre = (x.centre||'').replace(/'/g, "\\'");
                            let safeEngin = (x.engin||'').replace(/'/g, "\\'");
                            return '<div class="detail-row" onclick="event.stopPropagation();loadInterDetailFromGroup(\''+x.id+'\', \''+safeDate+'\', \''+safeMotif+'\', \''+safeStatus+'\', \''+safeCentre+'\', \''+safeEngin+'\');" style="padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.05);cursor:pointer;">'
                                +'<div style="display:flex;justify-content:space-between;align-items:center;">'
                                +'<div><span style="color:#39ff14;font-weight:bold;font-size:12px;">'+x.id+'</span><span style="color:#aaa;font-size:11px;margin-left:10px;">'+(x.date||'-')+'</span></div>'
                                +'<span style="background:'+tagBg+';color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:bold;">'+errorType+'</span>'
                                +'</div>'
                                +'<div style="font-size:11px;color:#ccc;margin-top:4px;">Motif: <b>'+(x.motif||'-')+'</b></div>'
                                +(x.commChef ? '<div style="font-size:10px;color:var(--accent3);margin-top:2px;">Chef: '+x.commChef+'</div>' : '')
                                +'</div>';
                        }).join('');
                        return '<div style="border-bottom:1px solid #333;">'
                            +'<div class="detail-row" onclick="toggleExpand(this)" style="padding:14px 16px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">'
                            +'<div style="flex:1;"><b style="color:#fff;font-size:14px;">'+r.nom+'</b></div>'
                            +'<div style="display:flex;align-items:center;gap:8px;">'
                            +'<span style="background:'+color+';color:#fff;padding:4px 10px;border-radius:6px;font-weight:bold;font-size:12px;">'+r.count+' fiche'+(r.count>1?'s':'')+'</span>'
                            +'<span class="expand-arrow" style="color:var(--muted);font-size:16px;">\u25b6</span>'
                            +'</div></div>'
                            +'<div class="isp-expand" style="display:none;background:rgba(0,0,0,0.2);padding:0 16px;">'+fichesHtml+'</div>'
                            +'</div>';
                    }).join('');
                }
            }).getIspDetailsAdmin(isp.mat);
        });
    }
    
    function toggleExpand(btn) {
        const expandDiv = btn.nextElementSibling;
        const arrow = btn.querySelector('.expand-arrow');
        if(expandDiv.style.display === 'block') {
            expandDiv.style.display = 'none';
            arrow.textContent = '\u25b6';
        } else {
            expandDiv.style.display = 'block';
            arrow.textContent = '\u25bc';
        }
    }

        function loadInterDetailFromGroup(id, date, motif, status, centre, engin) {
        startLoad();
        google.script.run.withSuccessHandler(res => {
            stopLoad();
            document.getElementById("modalPdf").src = (res.pdfUrl||'').replace('/view','/preview');
            setText("detailId", id);
            setText("detailDate", date || "-");
            setText("detailCentre", status || "-");
            setText("detailMotif", motif || "-");
            setText("detailEngin", engin || res.engin || "-");
            document.getElementById("commChef").textContent = res.commentChefferie||"Aucun commentaire.";
            const m = document.getElementById("blockMed");
            if(res.analyseMed) { m.style.display="block"; document.getElementById("commMed").textContent=res.analyseMed; } else m.style.display="none";
            document.getElementById("modalDetail").style.display="flex";
        }).getInterventionDetails(id);
    }

    function loadInterDetail(idx) {
        // Récupérer les données directement depuis la liste en mémoire (pas d'appel serveur !)
        const x = currentDetailList[idx];
        if(!x) { toast("Erreur: fiche introuvable"); return; }
        
        // Fermer la liste des interventions
        document.getElementById("modalList").style.display = "none";
        
        // Remplir le modal directement avec les données déjà chargées
        const pdfUrl = String(x.pdf||"").replace('/view','/preview');
        document.getElementById("modalPdf").src = pdfUrl;
        setText("detailId", x.id || "-");
        setText("detailDate", x.date || "-");
        setText("detailCentre", x.status || "-");
        setText("detailMotif", x.motif || "-");
        setText("detailEngin", x.engin || "-");
        document.getElementById("commChef").textContent = x.commChef || "Aucun commentaire.";
        const m = document.getElementById("blockMed");
        if(x.commMed) { m.style.display="block"; document.getElementById("commMed").textContent = x.commMed; }
        else { m.style.display="none"; }
        
        document.getElementById("modalDetail").style.display = "flex";
    }

    function openPlanningModal() {
      google.script.run.withSuccessHandler(function(data) {
        if (!data || !data.html) {
          alert("Impossible de charger le planning");
          return;
        }
        document.getElementById("planningTitle").textContent = "Planning " + data.mois + " 2026";
        document.getElementById("planningContent").innerHTML = data.html;
        document.getElementById("planningModal").style.display = 'flex';
      }).getPlanningMois();
    }
    
    function loadPlanningPreview() {
      google.script.run.withSuccessHandler(function(data) {
        if (!data || !data.html) return;
        // Créer une miniature du planning dans le bouton
        const previewDiv = document.getElementById("planningPreview");
        if (previewDiv) {
          previewDiv.innerHTML = '<div style="font-size:7px;overflow:hidden;transform:scale(0.15);transform-origin:top left;max-width:450px;cursor:pointer;" onclick="openPlanningModal()">' + data.html + '</div>';
        }
        // Afficher les infos du jour
        if (data.todayInfo) {
          document.getElementById("todayDate").textContent = "Date du jour: " + (data.todayInfo.date || "-");
          document.getElementById("todayGardeMatin").textContent = data.todayInfo.garde_matin || "-";
          document.getElementById("todayGardeAm").textContent = data.todayInfo.garde_am || "-";
          document.getElementById("todayConduct").textContent = data.todayInfo.conducteur || "-";
          document.getElementById("todayMadJour").textContent = data.todayInfo.mad_jour || "-";
          document.getElementById("todayMadNuit").textContent = data.todayInfo.mad_nuit || "-";
          document.getElementById("todayInfirmier").textContent = data.todayInfo.infirmier_ast || "-";
        }
      }).getPlanningMois();
    }
    
    function clearCachesAndReload() {
      google.script.run.withSuccessHandler(function(msg) {
        alert(msg);
        location.reload();
      }).clearAllCaches();
    }
    
    // Charger la miniature au démarrage
    setTimeout(loadPlanningPreview, 2000);
    
    function closeModal(id){ document.getElementById(id).style.display="none"; }

    // === MOBILE / DESKTOP MODE ===
    function chooseMobile() { localStorage.setItem('sdsOperMode','mobile'); document.body.classList.add('mobile-mode'); document.getElementById('splashChoice').style.display='none'; showModeStrip('mobile'); }
    function chooseDesktop() { localStorage.setItem('sdsOperMode','desktop'); document.body.classList.remove('mobile-mode'); document.getElementById('splashChoice').style.display='none'; showModeStrip('desktop'); }
    function switchMode(m) { if(m==='mobile') chooseMobile(); else chooseDesktop(); }
    function showModeStrip(m) {
      var s = document.getElementById('modeStrip'); s.style.display='block';
      s.innerHTML = m==='mobile' ? '📱 Mobile <a onclick="switchMode(\'desktop\')">Passer en PC</a>' : '💻 PC <a onclick="switchMode(\'mobile\')">Passer en mobile</a>';
    }
    (function(){ var s=localStorage.getItem('sdsOperMode'); if(s==='mobile'||s==='desktop'){document.getElementById('splashChoice').style.display='none';showModeStrip(s);if(s==='mobile')document.body.classList.add('mobile-mode');} })();

  </script>
</body>
</html>
