<!doctype html>
<!-- Version: v1.72 | 2026-02-09 | FIX: div+chk+onerror -->
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script>
    window.onerror = function(msg, src, line, col, err) {
        try {
            var d = document.createElement('div');
            d.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#d00;color:#fff;z-index:999999;padding:15px;font-size:14px;font-family:monospace;white-space:pre-wrap;';
            var srcInfo = src ? (' | src: ' + src) : '';
            d.textContent = 'JS ERROR: ' + msg + ' (ligne ' + line + ', col ' + col + ')' + srcInfo;
            if (err && err.stack) {
                var pre = document.createElement('pre');
                pre.style.cssText = 'margin:8px 0 0 0;white-space:pre-wrap;opacity:0.9;font-size:12px;';
                pre.textContent = err.stack;
                d.appendChild(pre);
            }
            if (document.body) {
                document.body.insertBefore(d, document.body.firstChild);
            } else {
                document.addEventListener('DOMContentLoaded', function(){
                    document.body.insertBefore(d, document.body.firstChild);
                });
            }
            console.error('JS ERROR:', msg, src, line, col, err);
        } catch (e) {
            // Fallback silent
        }
    };
  </script>
  <script>const SCRIPT_URL = "<?= scriptUrl ?>";
  
  // Mapping des protocoles: colonne Excel (0-indexed) => label
  const PROTOCOLS_MAP = {
    22: "VVP (1A)",
    23: "Hypoglyc\u00e9mie (2A)",
    24: "D\u00e9tr. Circu (3A)",
    25: "Brulures (4A)",
    26: "Dlr Aigue (5A)",
    27: "Penthrox (5A2)",
    28: "Dlr Iade (5A3)",
    29: "ACR (6A)",
    30: "Allergie (7A)",
    31: "DRA (8A)",
    32: "Intox Fum\u00e9es (9A)",
    33: "Convulsions (10A)",
    34: "Accouchement (11A)",
    35: "Dlr Tho (12A)",
    36: "Coup chaleur (13A)",
    37: "Fracture fem'/bassin (14A)",
    38: "Hors Protocole (HPA)",
    39: "VVP (1E)",
    40: "Hypoglyc\u00e9mie (2E)",
    41: "Brulures (4E)",
    42: "Dlr Aigue (5E)",
    43: "ACR (6E)",
    44: "Allergie (7E)",
    45: "DRA (8E)",
    46: "Intox Fum\u00e9es (9E)",
    47: "Convulsions (10E)",
    48: "Nouveau N\u00e9 (11E)",
    49: "Hors Protocole (HPE)"
  };</script>
  <style>
    :root{ --bg0:#0b0f1f; --bg1:#0f1430; --text:#eaf0ff; --muted:#a9b5db; --border:rgba(255,255,255,.08); --accent3:#4fc3f7; --ok:#47d18c; --radius:18px; --red:#ff4d4d; --orange:#ffa500; --accent:#6ea8fe; --danger:#ff6b6b; --selectBg:#0e1730; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: ui-sans-serif, system-ui, sans-serif; color:var(--text); background:linear-gradient(180deg, var(--bg0), var(--bg1)); min-height:100vh; font-size:13px; }
    
    .neo-loader-box { position:fixed; top:20px; left:50%; transform:translateX(-50%); width:400px; padding:10px; background:rgba(0,0,0,0.9); border:1px solid var(--accent3); border-radius:4px; z-index:100000; box-shadow:0 0 15px rgba(57,255,20,0.3); display:none; flex-direction:column; gap:5px; }
    .neo-text { color:var(--accent3); font-family:monospace; font-weight:bold; font-size:12px; text-transform:uppercase; display:flex; justify-content:space-between; }
    .neo-track { width:100%; height:10px; background:#111; border:1px solid #333; border-radius:2px; overflow:hidden; }
    .neo-fill { height:100%; background: repeating-linear-gradient(45deg, var(--accent3), var(--accent3) 10px, #2ebf11 10px, #2ebf11 20px); width:0%; transition:width 0.2s linear; box-shadow:0 0 10px var(--accent3); }

    .app{ display:grid; grid-template-columns: 260px 1fr; min-height:100vh; }
    .sidebar{ position:sticky; top:0; height:100vh; padding:20px 15px; border-right:1px solid var(--border); background:rgba(18,26,59,.65); backdrop-filter:blur(10px); display:flex; flex-direction:column; overflow-y:auto; }
    .sideTop{ display:flex; flex-direction:column; align-items:center; text-align:center; margin-bottom:30px; }
    .sideLogo{ width:60px; height:60px; border-radius:12px; overflow:hidden; border:1px solid var(--border); margin-bottom:12px; }
    .sideLogo img{ width:100%; height:100%; object-fit:cover; }
    .sideTitle{ line-height:1.2; } .sideTitle b{ color:#fff; font-size:14px; }
    .sideBtns{ display:flex; flex-direction:column; gap:10px; }
    .sideBtn{ width:100%; text-align:left; background:rgba(255,255,255,.03); border:1px solid var(--border); color:var(--text); padding:12px; border-radius:12px; cursor:pointer; font-weight:600; display:flex; justify-content:space-between; align-items:center; transition:0.2s; }
    .sideBtn:hover{ background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.3); }
    .sideBtn.primary{ background:rgba(57,255,20,0.05); border-color:rgba(57,255,20,0.3); color:#fff; }
    .badgeBtn { background:var(--ok); color:#000; padding:2px 6px; border-radius:6px; font-size:11px; font-weight:bold; }
    .badgeBtn.red { background:var(--red); color:#fff; }

    .main{ padding:25px; overflow-y:auto; height:100vh; position:relative; }
    .view { display:none; animation:fadeIn 0.3s; }
    .view.active { display:block; }
    #viewChefferie.active { display:flex; flex-direction:column; position:absolute; top:0; left:0; right:0; bottom:0; z-index:10; background:linear-gradient(180deg, var(--bg0), var(--bg1)); }
    .chefHeader { flex-shrink:0; border-bottom:2px solid var(--border); padding:12px 20px; background:var(--bg0); }
    .chefBtnRow { flex-shrink:0; background:rgba(11,15,31,0.98); border-bottom:1px solid var(--border); padding:15px 20px; display:flex; gap:12px; flex-wrap:wrap; }
    .chefContent { flex:1; overflow-y:auto; padding:20px; min-height:0; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(5px);} to{opacity:1;transform:translateY(0);} }

    .topbar{ border-bottom:1px solid var(--border); padding-bottom:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; }
    .topbar h1 { margin:2px 0; font-size:18px; }
    .topbar p { margin:2px 0; font-size:12px; }
    .periodHero{ background:rgba(255,255,255,0.02); border:1px solid var(--border); padding:15px; border-radius:12px; text-align:center; margin-bottom:20px; }
    .kpiGrid{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-bottom:20px; }
    .panel{ background:rgba(18,26,59,.8); border:1px solid var(--border); border-radius:16px; overflow:hidden; margin-bottom:20px; }
    .panelHead{ background:rgba(0,0,0,0.2); padding:12px 15px; font-weight:bold; border-bottom:1px solid var(--border); font-size:13px; display:flex; justify-content:space-between; position:sticky; top:0; z-index:5; }
    .panelBody{ padding:15px; }
    .badge{ background:rgba(255,255,255,0.1); padding:3px 8px; border-radius:6px; font-size:12px; border:1px solid rgba(255,255,255,0.1); margin-left:15px; }
    
    table{ width:100%; border-collapse:collapse; font-size:11px; }
    thead{ position:sticky; top:0; z-index:10; background:#131b3a; }
    th{ text-align:left; color:var(--muted); padding:6px; border-bottom:1px solid var(--border); font-size:10px; text-transform:uppercase; cursor:pointer; user-select:none; background:#131b3a; }
    td{ padding:4px 6px; border-bottom:1px solid rgba(255,255,255,0.03); }
    tr:hover td{ background:rgba(255,255,255,0.03); cursor:pointer; }
    .num{ text-align:right; font-family:monospace; }
    
    .btnGo{ background:var(--accent3); color:#000; font-weight:bold; border:1px solid rgba(79,195,247,0.5); padding:8px 16px; border-radius:8px; cursor:pointer; transition:0.2s; box-shadow:0 0 12px rgba(79,195,247,0.3); }
    .btnGo:hover{ background:#5dd5ff; box-shadow:0 0 18px rgba(79,195,247,0.5); }
    .inp{ background:rgba(0,0,0,0.3); border:1px solid var(--border); color:#fff; padding:8px; border-radius:8px; outline:none; }
    .inp:focus{ border-color:var(--accent3); }
    
    .mini-load-box { display:none; width:150px; padding:5px; background:rgba(0,0,0,0.9); border:1px solid var(--accent3); border-radius:4px; margin-left:15px; }
    .mini-load-track { width:100%; height:6px; background:#111; border-radius:2px; overflow:hidden; }
    .mini-load-fill { width:0%; height:100%; background:var(--accent3); transition:width 0.2s; }
    .mini-load-text { font-size:10px; color:var(--accent3); text-align:center; font-family:monospace; margin-bottom:2px; }

    .adminSplit { display:flex; gap:20px; align-items:flex-start; }
    .adminLeft { flex:0 0 60%; }
    .adminRight { flex:1; }
    .admin-scroll { max-height:400px; overflow:auto; border:1px solid var(--border); border-radius:10px; }

    .btn-row { display:flex; gap:15px; margin-bottom:20px; position:sticky; top:0; z-index:10; background:rgba(11,15,31,0.95); padding:15px 0; border-bottom:1px solid var(--border); }
    .c-btn { flex:1; padding:15px; background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:12px; color:#fff; cursor:pointer; text-align:left; transition:0.2s; }
    .c-btn:hover { background:rgba(255,255,255,.08); border-color:var(--accent3); }
    .c-btn h3 { margin:0 0 5px 0; font-size:14px; display:flex; justify-content:space-between; }
    .c-btn p { margin:0; font-size:11px; color:var(--muted); }

    .chef-layout { display:flex; gap:20px; height:85vh; }
    .chef-pdf { flex:2; background:#000; border-radius:12px; border:1px solid var(--border); overflow:hidden; }
    .chef-form { flex:1; background:rgba(0,0,0,0.2); padding:20px; border-radius:12px; border:1px solid var(--border); overflow-y:auto; display:flex; flex-direction:column; gap:15px; }

    .info-banner { background:rgba(57,255,20,0.05); border:1px solid var(--accent3); padding:10px; border-radius:8px; margin-bottom:10px; display:flex; flex-direction:column; gap:8px; font-weight:bold; font-size:12px; }
    .info-banner-row { display:flex; justify-content:space-between; flex-wrap:wrap; }
    
    .check-list { display:flex; flex-direction:column; gap:8px; background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; }
    .check-item { display:flex; align-items:center; gap:8px; }
    .chk-green { color:var(--ok); font-weight:bold; }
    .chk-orange { color:var(--orange); font-weight:bold; }
    .chk-red { color:var(--red); font-weight:bold; }

    textarea { width:100%; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:#fff; padding:10px; border-radius:6px; resize:vertical; min-height:60px; }
    .static-box { background:rgba(0,0,0,0.4); padding:10px; border-radius:6px; color:#ddd; font-size:12px; border:1px solid var(--border); }

    .modalOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(3px); }
    .modalCard { width:90%; max-width:1600px; height:98vh; background:#121a3b; border:1px solid var(--border); border-radius:20px; display:flex; flex-direction:column; overflow:hidden; }
    .modalHead { padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; font-weight:bold; font-size:16px; }
    .closeBtn { background:none; border:none; color:#fff; font-size:24px; cursor:pointer; }
    
    .modalBody { display:flex; flex:1; overflow:hidden; }
    
    #modalPdf { flex:1; border:0; background:#000; }
    #modalPdfInfo { flex:0 0 300px; background:#1a2245; padding:20px; border-left:1px solid var(--border); overflow-y:auto; display:flex; flex-direction:column; gap:15px; }
    
    .detail-row { padding:12px; border-bottom:1px solid rgba(255,255,255,0.05); cursor:pointer; }
    .detail-row:hover { background:rgba(255,255,255,0.05); }
    .tag { padding:2px 6px; border-radius:4px; font-size:10px; margin-right:5px; border:1px solid transparent; }
    .tag.ok { color:var(--ok); border-color:var(--ok); }
    .tag.warn { color:var(--orange); border-color:var(--orange); }
    .tag.err { color:var(--red); border-color:var(--red); }
    
    .toast { position:fixed; bottom:20px; right:20px; background:#111; border:1px solid var(--border); padding:15px; border-radius:10px; z-index:99999; display:none; }
    .trendUp{ color:#39ff14; } .trendDown{ color:#ff4d4d; } .trendEq{ color:gray; }
    .text-green { color:var(--ok); font-weight:bold; } .text-orange { color:var(--orange); font-weight:bold; } .text-red { color:var(--red); font-weight:bold; }
    
    .table-title { background:rgba(0,0,0,0.2); padding:12px 15px; font-weight:bold; border-bottom:1px solid var(--border); font-size:13px; }

    .panelScrollWrapper { max-height:300px; overflow:auto; position:relative; }

    /* === STYLES APP === */
    header{ padding:8px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px; background: rgba(16,26,51,.8); backdrop-filter: blur(10px); border-bottom:1px solid var(--border); height: 50px; flex-shrink:0; }
    .brand{ display:flex; align-items:center; gap:10px; }
    .logo{ width:28px;height:28px;border-radius:8px; background: linear-gradient(135deg, rgba(110,168,254,.9), rgba(71,209,140,.85)); box-shadow: 0 18px 50px rgba(0,0,0,.35); cursor:pointer; }
    h1{ font-size:16px; margin:0; font-weight:700; } 
    .rightHead{ display:flex; align-items:center; gap:8px; }
    .pill{ font-size:11px; padding:4px 10px; border-radius: 999px; border:1px solid var(--border); color:var(--muted); background: rgba(255,255,255,.03); white-space:nowrap; }
    .btnTop{ border:1px solid var(--border); background: rgba(255,255,255,.03); color: var(--text); padding:6px 10px; border-radius: 999px; cursor:pointer; font-weight:600; font-size:11px; transition: background .2s; }
    .btnTop:hover{ background: rgba(255,255,255,.08); }

    .wrap{ padding:10px; max-width: 100%; margin:0 auto; height: calc(100vh - 50px); display:flex; gap:10px; }
    .leftCol { flex: 2.5; display:flex; flex-direction:column; gap:10px; height:100%; min-width:0; }
    .rightCol { flex: 2.2; display:flex; flex-direction:column; height:100%; min-width:500px; }

    .card{ background: linear-gradient(180deg, rgba(16,26,51,.95), rgba(15,24,48,.95)); border:1px solid var(--border); border-radius: var(--radius); box-shadow: 0 18px 50px rgba(0,0,0,.35); overflow:hidden; display:flex; flex-direction:column; flex:1; }
    .cardHead{ padding:8px 12px; border-bottom:1px solid var(--border); background: rgba(255,255,255,.02); flex-shrink:0; }
    
    .interInfos { display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; font-size: 11px; }
    .interItem { display:flex; flex-direction:column; }
    .interLabel { color: var(--muted); font-size:9px; text-transform:uppercase; letter-spacing:0.5px; }
    .interVal { font-weight:600; color:#fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size:11px; }
    .interVal.highlight { color: var(--accent); }

    .pdfBox{ flex:1; background: rgba(0,0,0,.2); position:relative; overflow:hidden; }
    iframe{ width:100%; height:100%; border:0; position:absolute; top:0; left:0; }

    .form{ padding:10px; display:flex; flex-direction:column; gap:8px; overflow-y:auto; flex:1; }
    .form::-webkit-scrollbar { width: 5px; }
    .form::-webkit-scrollbar-track { background: transparent; }
    .form::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    
    label{ font-size:10px; color:var(--muted); display:block; margin-bottom:2px; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .group{ padding:8px; border-radius: 10px; border:1px solid var(--border); background: rgba(255,255,255,.02); }
    .groupTitle { font-size:11px; font-weight:800; color:var(--accent); margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px; border-bottom:1px solid rgba(255,255,255,.05); padding-bottom:2px; }

    select, input[type="text"], textarea { padding:4px 6px; border-radius: 6px; border:1px solid var(--border); background: var(--selectBg); color: var(--text); outline:none; width:100%; font-family:inherit; font-size:11px; transition: border-color .2s; }
    select:focus, input:focus, textarea:focus { border-color: var(--accent); }
    textarea { resize: vertical; min-height: 30px; }

    .cb{ display:flex; align-items:flex-start; gap:4px; padding:3px 5px; border-radius: 4px; border:1px solid rgba(255,255,255,.05); background: rgba(255,255,255,.01); cursor:pointer; user-select:none; font-size:10px; transition: background .2s; line-height:1.2; white-space: normal; word-break: break-word; }
    .cb:hover { background: rgba(255,255,255,.05); }
    .cb.red { border-color: rgba(255,107,107,.3); color: var(--danger); }
    
    #protoAdultBox, #protoPediaBox { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 4px; }
    
    input[type="checkbox"]{ width:12px;height:12px; accent-color: var(--accent); cursor:pointer; flex-shrink:0; margin-top:1px; }
    input[type="checkbox"].danger-cb { accent-color: var(--danger); }

    .actions{ margin-top:auto; padding-top:6px; display:flex; gap:8px; flex-shrink:0; }
    .btn{ border:1px solid var(--border); background: rgba(255,255,255,.03); color: var(--text); padding:8px; border-radius: 8px; cursor:pointer; font-weight:700; flex:1; font-size:12px; }
    .btn.ok{ border-color: rgba(71,209,140,.45); background: linear-gradient(135deg, rgba(71,209,140,.25), rgba(71,209,140,.10)); color: #8affc1; }
    .btn.warn{ border-color: rgba(255,107,107,.35); background: linear-gradient(135deg, rgba(255,107,107,.16), rgba(255,107,107,.06)); }

    .grid-checks { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 4px; }
    .grid-selects { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .row2Items { display: grid; grid-template-columns: 2fr 1fr; gap:6px; margin-top:6px; }

    .appContainer { display:none; }
    .appContainer.active { display:flex; flex-direction:column; height:100%; }
    
    /* Fl√®che scroll clignotante */
    .scroll-arrow { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); width:40px; height:40px; background:linear-gradient(135deg, rgba(110,168,254,.2), rgba(71,209,140,.2)); border:2px solid var(--accent3); border-radius:50%; display:none; align-items:center; justify-content:center; font-size:20px; color:var(--accent3); cursor:pointer; animation:pulse 2s infinite; box-shadow:0 0 20px rgba(79,195,247,0.4); z-index:5000; }
    @keyframes pulse { 0%, 100% { opacity:1; transform:translateX(-50%) scale(1); } 50% { opacity:0.7; transform:translateX(-50%) scale(1.1); } }
    .scroll-arrow:hover { background:linear-gradient(135deg, rgba(110,168,254,.4), rgba(71,209,140,.4)); }
  </style>
</head>
<body>
  <div id="loadingBox" class="neo-loader-box">
    <div class="neo-text"><span>Chargement...</span><span id="loadPct">0%</span></div>
    <div class="neo-track"><div id="loadFill" class="neo-fill"></div></div>
  </div>

  <div id="loadingBox25" class="neo-loader-box">
    <div class="neo-text"><span>Chargement 2025...</span><span id="loadPct25">0%</span></div>
    <div class="neo-track"><div id="loadFill25" class="neo-fill"></div></div>
  </div>

  <!-- Fl√®che de scroll -->
  <div class="scroll-arrow" id="scrollArrow" onclick="document.querySelector('.main').scrollTo({top: document.querySelector('.main').scrollHeight, behavior: 'smooth'});">‚Üì</div>

  <!-- VUE DASHBOARD -->
  <div class="app" id="viewContainer">
    <aside class="sidebar">
      <div class="sideTop">
        <div class="sideLogo"><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTytvs_50DuR6nodg_2fA5DzNfpdDSR1s_YaQ&s"></div>
        <div class="sideTitle">
            <b>Sdis 66 - SDS</b>
            <span style="display:block;margin-top:2px;">Outil de donn√©es<br>op√©rationnelles</span>
            <div id="cacheTime" style="font-size:10px;color:gray;margin-top:5px;"></div>
        </div>
      </div>
      <div class="sideBtns">
        <button class="sideBtn primary" id="btnAppAccess" onclick="openAppView()"><span>Acc√®s APP</span><span class="badgeBtn" id="cntAppBadge">...</span></button>
        <button class="sideBtn" onclick="askPass('chef')"><span>Acc√®s Chefferie</span><span style="display:flex;align-items:center;gap:4px;"><span class="badgeBtn" id="cntIspGBadge">...</span><span style="color:var(--muted);">/</span><span class="badgeBtn" style="background:var(--orange);color:#000;" id="cntIspRBadge">...</span></span></button>
      </div>
    </aside>

    <main class="main">
      
      <div id="viewDashboard" class="view active">
        <div class="topbar">
            <div><h1>Synth√®se</h1><p style="color:var(--muted)">Activit√© op√©rationnelle 2026 ‚Äî comparaison √† date de la p√©riode 2025</p></div>
        </div>
        
        <div class="periodHero">Les donn√©es sont compar√©es du <b style="color:#fff;font-size:16px;">01/01/2026</b> au <b style="color:#fff;font-size:16px;"><span id="cutoffDateBig">...</span></b></div>

        <div class="kpiGrid">
           <div class="panel"><div class="panelBody">
              <div style="font-size:11px;color:var(--muted)">Interventions ‚Äî Garde PSud</div><div style="font-size:32px;font-weight:900" id="psud2026">...</div>
              <div class="kpiBottom"><span style="color:var(--muted);font-size:11px">Total 2025:</span><span class="badge" id="psud2025Badge">...</span></div>
              <div style="font-size:9px;color:var(--muted);margin-top:4px;">Comparaison du 1er janvier au <span id="cutoffCompPsud">...</span></div>
           </div></div>
           <div class="panel"><div class="panelBody">
              <div style="font-size:11px;color:var(--muted)">Interventions ‚Äî Secteur</div><div style="font-size:32px;font-weight:900" id="secteur2026">...</div>
              <div class="kpiBottom"><span style="color:var(--muted);font-size:11px">Total 2025:</span><span class="badge" id="sect2025Badge">...</span></div>
              <div style="font-size:9px;color:var(--muted);margin-top:4px;">Comparaison du 1er janvier au <span id="cutoffCompSect">...</span></div>
           </div></div>
           <div class="panel"><div class="panelBody">
              <div style="font-size:11px;color:var(--muted)">Total interventions SDS</div><div style="font-size:32px;font-weight:900" id="total2026">...</div>
              <div class="kpiBottom"><span style="color:var(--muted);font-size:11px">Total 2025:</span><span class="badge" id="total2025Badge">...</span></div>
              <div style="font-size:9px;color:var(--muted);margin-top:4px;">Comparaison du 1er janvier au <span id="cutoffCompTotal">...</span></div>
           </div></div>
        </div>

        <div class="panel" style="margin-bottom:20px;"><div class="panelBody" style="display:flex;align-items:center;gap:40px;">
            <div><div style="font-size:11px;color:var(--muted)">Astreintes / Dispo 2026</div><div style="font-size:24px;font-weight:bold" id="hrs2026">...</div><div style="font-size:9px;color:var(--muted);margin-top:4px;">Comparaison du 1er janvier au <span id="cutoffCompAst">...</span></div></div>
            <div><div style="font-size:11px;color:var(--muted)">Total 2025</div><div class="badge" id="hrs2025Badge">...</div></div>
        </div></div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
            <div class="panel"><div class="panelHead">Sorties par CIS</div><div class="panelScrollWrapper"><table id="tableCis"><thead><tr><th>CIS</th><th class="num">2026</th><th class="num">2025 (Date)</th><th class="num">2025 (Total)</th></tr></thead><tbody></tbody></table></div></div>
            <div class="panel"><div class="panelHead">Sorties par Secteur</div><div class="panelScrollWrapper"><table id="tableSect"><thead><tr><th>Secteur</th><th class="num">2026</th><th class="num">2025 (Date)</th><th class="num">2025 (Total)</th></tr></thead><tbody></tbody></table></div></div>
        </div>

        <div class="panel" style="margin-bottom:20px;">
            <div class="panelHead">Donn√©es par ISP</div>
            <div class="panelBody">
                <div id="ispLogin" style="display:flex;gap:10px;align-items:center;">
                    <input type="text" id="matInput" class="inp" placeholder="Matricule" style="width:120px;">
                    <input type="text" id="dobInput" class="inp" placeholder="JJ/MM/AAAA" style="width:140px;">
                    <button class="btnGo" style="width:auto;margin:0" onclick="loginIsp()">Voir mes donn√©es</button>
                    <div id="ispLoadBox" class="mini-load-box">
                       <div class="mini-load-text"><span id="ispPct">0</span>%</div>
                       <div class="mini-load-track"><div id="ispFill" class="mini-load-fill"></div></div>
                    </div>
                </div>
                <div id="ispData" style="display:none;margin-top:15px;">
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;">
                        <div>
                            <h4 style="color:var(--accent3);margin:0 0 5px 0">Temps (Agent: <span id="ispNameDisplay">‚Äî</span>)</h4>
                            <div style="font-size:12px;"><b>Astreinte 2026:</b> <span id="ispAst26"></span>h <span id="ispAstTrend"></span></div>
                            <div style="font-size:11px;color:var(--muted)">Comparatif 2025 √† date: <span id="ispAst25Ytd"></span>h | Total 2025: <span id="ispAst25Tot"></span>h</div>
                            <hr style="border:0;border-top:1px solid #333;margin:5px 0">
                            <div style="font-size:12px;"><b>Garde 2026:</b> <span id="ispGarde26"></span>h <span id="ispGardeTrend"></span></div>
                            <div style="font-size:11px;color:var(--muted)">Comparatif 2025 √† date: <span id="ispGarde25Ytd"></span>h | Total 2025: <span id="ispGarde25Tot"></span>h</div>
                        </div>
                        <div>
                            <h4 style="color:var(--accent3);margin:0 0 5px 0">Nbr Inters (Hors Garde)</h4>
                            <div style="font-size:12px;"><b>2026:</b> <span id="ispInter26"></span> <span id="ispInterTrend"></span></div>
                            <div style="font-size:11px;color:var(--muted)">Comparatif 2025 √† date: <span id="ispInter25Ytd"></span> | Total 2025: <span id="ispInter25Tot"></span></div>
                        </div>
                        <div>
                            <h4 style="color:var(--accent3);margin:0 0 5px 0">Etude qualitative des BPV</h4>
                            <div style="color:gray;font-size:11px;margin-bottom:8px;">Cliquez sur une intervention pour la voir</div>
                            <div style="font-size:12px;cursor:pointer;text-decoration:underline;" class="text-green" onclick="openErrorList('Bilan')">Bilan OK: <b id="ispBilanOk"></b></div>
                            <div style="font-size:12px;cursor:pointer;text-decoration:underline;" class="text-green" onclick="openErrorList('Pisu')">Pisu OK: <b id="ispPisuOk"></b></div>
                            
                            <div style="margin-top:8px;cursor:pointer;text-decoration:underline;" class="text-orange" onclick="openErrorList('BilanLeg')">Erreur Bilan L√©g√®re: <span id="ispErrBil"></span></div>
                            <div style="cursor:pointer;text-decoration:underline;" class="text-orange" onclick="openErrorList('PisuLeg')">Erreur Pisu L√©g√®re: <span id="ispErrPisu"></span></div>
                            
                            <div style="margin-top:8px;cursor:pointer;text-decoration:underline;" class="text-red" onclick="openErrorList('Grave')">Erreur Grave: <span id="ispErrLourd"></span></div>
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:15px;">
                        <button class="btnGo" style="width:auto;background:#333;color:#fff" onclick="logoutIsp()">D√©connexion</button>
                        <button class="btnGo" style="width:auto;background:#444;color:#fff" onclick="refreshIspData()">üîÑ Rafra√Æchir</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panelHead">Administration (√† date)</div>
            <div class="panelBody">
                <div id="adminLogin" style="display:flex;gap:10px;align-items:center;">
                    <input type="password" id="adminPwd" class="inp" placeholder="Code...">
                    <button class="btnGo" style="width:auto;margin:0" onclick="loadAdmin()">Valider</button>
                </div>
                <div id="adminLoadBox" class="mini-load-box" style="margin-top:10px;">
                   <div class="mini-load-text"><span id="adminPct">0</span>%</div>
                   <div class="mini-load-track"><div id="adminFill" class="mini-load-fill"></div></div>
                </div>
                <div id="adminData" style="display:none;margin-top:10px;">
                    <input type="text" id="adminSearch" class="inp" placeholder="Filtrer (s√©parer par ;)" style="width:100%;margin-bottom:10px;" onkeyup="filterAdmin()">
                    
                    <div class="adminSplit">
                        <div class="adminLeft">
                            <div class="table-title">Donn√©es par ISP</div>
                            <div class="admin-scroll">
                                <table id="adminTable">
                                    <thead><tr>
                                        <th onclick="sortAdmin(0)">Nom <span id="sortA0">‚Üï</span></th>
                                        <th onclick="sortAdmin(1)" class="num">Inter<br>Hors Garde<br>26 <span id="sortA1">‚ñº</span></th>
                                        <th onclick="sortAdmin(2)" class="num" style="color:var(--muted)">Inter<br>Hors Garde<br>25 <span id="sortA2">‚Üï</span></th>
                                        <th onclick="sortAdmin(3)" class="num">Inter<br>En Garde<br>26 <span id="sortA3">‚Üï</span></th>
                                        <th onclick="sortAdmin(4)" class="num" style="color:var(--muted)">Inter<br>En Garde<br>25 <span id="sortA4">‚Üï</span></th>
                                        <th onclick="sortAdmin(5)" class="num">Astreinte<br>26 <span id="sortA5">‚Üï</span></th>
                                        <th onclick="sortAdmin(6)" class="num" style="color:var(--muted)">Astreinte<br>25 <span id="sortA6">‚Üï</span></th>
                                        <th onclick="sortAdmin(7)" class="num">Garde<br>26 <span id="sortA7">‚Üï</span></th>
                                        <th onclick="sortAdmin(8)" class="num" style="color:var(--muted)">Garde<br>25 <span id="sortA8">‚Üï</span></th>
                                    </tr></thead>
                                    <tbody id="adminTbody"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="adminRight">
                            <div class="table-title">Taux sollicitation</div>
                            <div class="admin-scroll">
                                <table><thead><tr><th>Nom</th><th>Taux</th></tr></thead><tbody id="adminSollTbody"></tbody></table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fen√™tres CIS et Secteurs apr√®s -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px;">
                        <div class="panel"><div class="panelHead">Interventions par CIS (d√©croissant)</div><div class="panelScrollWrapper" style="max-height:250px;"><table id="tableAdminCis"><thead><tr><th>CIS</th><th class="num">2026</th><th class="num">2025 (Date)</th><th class="num">2025 (Total)</th></tr></thead><tbody></tbody></table></div></div>
                        <div class="panel"><div class="panelHead">Interventions par Secteur (d√©croissant)</div><div class="panelScrollWrapper" style="max-height:250px;"><table id="tableAdminSect"><thead><tr><th>Secteur</th><th class="num">2026</th><th class="num">2025 (Date)</th><th class="num">2025 (Total)</th></tr></thead><tbody></tbody></table></div></div>
                    </div>
                </div>
            </div>
        </div>
      </div>

      <!-- NOUVELLE INTERFACE CHEFFERIE -->
      <div id="viewChefferie" class="view">
          <div class="chefHeader">
              <button class="btnGo" style="width:auto;padding:8px 16px;" onclick="goHome()">‚Üê Retour Dashboard</button>
              <h1 style="display:inline;margin-left:20px;font-size:18px;font-weight:800;">Espace Chefferie</h1>
          </div>
          <div class="chefBtnRow">
              <button class="c-btn" style="flex:1;" onclick="showChefferieMode('app')">
                  <h3 style="margin:0 0 4px 0; font-size:14px;">üìã Faire APP Chefferie</h3>
                  <p style="margin:0; font-size:11px; opacity:0.8;">Fiches Bilan/Pisu incomplets</p>
              </button>
              <button class="c-btn" style="flex:1;" onclick="showChefferieMode('med')">
                  <h3 style="margin:0 0 4px 0; font-size:14px;">‚ö†Ô∏è Analyse M√©decin Cheffe</h3>
                  <p style="margin:0; font-size:11px; opacity:0.8;">Erreurs graves</p>
              </button>
              <button class="c-btn" style="flex:1;" onclick="showChefferieMode('action')">
                  <h3 style="margin:0 0 4px 0; font-size:14px;">üéØ Action √† mener chefferie</h3>
                  <p style="margin:0; font-size:11px; opacity:0.8;">Actions finales √† traiter</p>
              </button>
              <button class="c-btn" style="flex:1;" onclick="showChefferieMode('data')">
                  <h3 style="margin:0 0 4px 0; font-size:14px;">üìä Voir Donn√©es APP</h3>
                  <p style="margin:0; font-size:11px; opacity:0.8;">Tous les ISP</p>
              </button>
          </div>
          <div class="chefContent">
                  <!-- Mode APP Chefferie -->
                  <div id="chefModeApp" style="display:none;">
                      <div id="chefAppContent"></div>
                  </div>
                  
                  <!-- Mode M√©decin -->
                  <div id="chefModeMed" style="display:none;">
                      <div id="chefMedContent"></div>
                  </div>
                  
                  <!-- Mode Action -->
                  <div id="chefModeAction" style="display:none;">
                      <div id="chefActionContent"></div>
                  </div>
                  
                  <!-- Mode Data -->
                  <div id="chefModeData" style="display:none;">
                      <div style="display:flex; gap:12px; margin-bottom:15px;">
                          <button class="btnGo" style="background:var(--red);border-color:rgba(255,77,77,0.5);box-shadow:0 0 12px rgba(255,77,77,0.3);" onclick="loadAllGraveErrors()">üö® Voir toutes les erreurs graves</button>
                          <button class="btnGo" style="background:var(--orange);border-color:rgba(255,165,0,0.5);box-shadow:0 0 12px rgba(255,165,0,0.3);" onclick="loadAllLegereErrors()">‚ö†Ô∏è Voir toutes les erreurs l√©g√®res</button>
                      </div>
                      <div class="panel">
                          <div class="panelHead">R√©capitulatif par ISP</div>
                          <div class="panelBody">
                              <table id="globalTable" style="width:100%;">
                                  <thead><tr>
                                      <th onclick="sortGlobal(0)" style="cursor:pointer;">Nom ISP <span id="sortIcon0">‚Üï</span></th>
                                      <th onclick="sortGlobal(1)" style="cursor:pointer;">Bilan OK <span id="sortIcon1">‚Üï</span></th>
                                      <th onclick="sortGlobal(2)" style="cursor:pointer;">Pisu OK <span id="sortIcon2">‚Üï</span></th>
                                      <th onclick="sortGlobal(3)" style="cursor:pointer;">Err. Bilan L√©g. <span id="sortIcon3">‚Üï</span></th>
                                      <th onclick="sortGlobal(4)" style="cursor:pointer;">Err. Pisu L√©g. <span id="sortIcon4">‚Üï</span></th>
                                      <th onclick="sortGlobal(5)" style="cursor:pointer;">Err. Grave <span id="sortIcon5">‚Üï</span></th>
                                  </tr></thead>
                                  <tbody id="globalTbody"></tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              </div>
      </div>

      <div id="viewMedecin" class="view">
          <div class="topbar"><button class="btnGo" style="width:auto;margin:0" onclick="goHome()">‚Üê Retour Dashboard</button><h1 style="display:inline-block;margin-left:15px;">Espace M√©decin Cheffe</h1></div>
          <div id="medFormArea" style="height:85vh;margin-top:20px;"></div>
      </div>
    </main>
  </div>

  <!-- VUE APP -->
  <div class="appContainer" id="appView">
    <header>
      <div class="brand">
        <div class="logo" title="Retour accueil" onclick="closeAppView()"></div>
        <h1>APP par ISP</h1>
      </div>
      <div class="rightHead">
        <div class="pill" id="statusPill">Chargement‚Ä¶</div>
        <button class="btnTop" onclick="loadNext(currentAppRow)">Recharger</button>
        <button class="btnTop" onclick="closeAppView()">Accueil</button>
      </div>
    </header>

    <div class="wrap">
      <div class="leftCol">
        <div class="card">
            <div class="cardHead">
            <div class="interInfos">
                <div class="interItem"><span class="interLabel">Intervention</span><span class="interVal" id="iNum">‚Äî</span></div>
                <div class="interItem"><span class="interLabel">Date</span><span class="interVal" id="iDate">‚Äî</span></div>
                <div class="interItem"><span class="interLabel">Infirmier</span><span class="interVal highlight" id="iInf">‚Äî</span></div>
                <div class="interItem"><span class="interLabel">Centre</span><span class="interVal" id="iCis">‚Äî</span></div>
                <div class="interItem"><span class="interLabel">Motif</span><span class="interVal" id="iMotif">‚Äî</span></div>
                <div class="interItem"><span class="interLabel">Engin</span><span class="interVal" id="iEngin">‚Äî</span></div>
            </div>
            </div>
            <div class="pdfBox">
            <iframe id="pdfFrame" src=""></iframe>
            <div id="pdfPlaceholder" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:var(--muted);">Chargement PDF...</div>
            </div>
            <div style="padding:4px; text-align:center; border-top:1px solid var(--border); background:rgba(0,0,0,0.3); font-size:10px;">
            <a id="openPdfLink" href="#" target="_blank" style="color:var(--accent); text-decoration:none;">Ouvrir dans Drive ‚Üó</a> 
            <span class="pill" id="remainingPill" style="margin-left:10px; font-size:9px; padding:2px 6px;">Reste : ‚Äî</span>
            </div>
        </div>
      </div>

      <div class="rightCol">
        <div class="card">
            <div class="form" id="mainForm">
            
            <div class="group" style="padding:6px;">
                <div style="display:flex;align-items:center;gap:10px;">
                    <label style="margin:0;">ISP Analyse :</label>
                    <select id="ispSelect" style="flex:1;"><option value="">Chargement...</option></select>
                </div>
            </div>

            <div class="group">
                <div class="groupTitle">Protocoles</div>
                <div style="margin-bottom:2px;font-size:10px;color:var(--muted);font-weight:700;">Adultes</div>
                <div class="grid-checks" id="protoAdultBox"></div>
                <div style="margin:6px 0 2px;font-size:10px;color:var(--muted);font-weight:700;border-top:1px solid rgba(255,255,255,.05);padding-top:4px;">P√©diatriques</div>
                <div class="grid-checks" id="protoPediaBox"></div>
            </div>

            <div class="group">
                <div class="groupTitle">Crit√®res</div>
                <div class="grid-selects">
                    <div><label id="lblAx">AKIM</label><select id="selAx"></select></div>
                    <div><label id="lblAy">SMUR</label><select id="selAy"></select></div>
                    <div><label id="lblAz">CCMU</label><select id="selAz"></select></div>
                    <div><label id="lblBa">DEVENIR</label><select id="selBa"></select></div>
                </div>
                <div class="row2Items">
                    <div><label id="lblBb">SOUSAN</label><select id="selBb"></select></div>
                    <div><label id="lblBc">NB VICTIMES</label><input type="text" id="txtBc"></div>
                </div>
                <div style="margin-top:8px;"><label id="lblBg">Examen clinique</label><select id="selBg"></select></div>
            </div>

            <div class="group">
                <div class="groupTitle">R√©sultat</div>
                <div style="margin-bottom:8px;">
                    <label class="cb"><input type="checkbox" id="chkBh"> <span id="lblBh">Absence / erreur commande PUI</span></label>
                </div>
                <div id="biBmBox" style="display:grid; grid-template-columns: 1fr; gap:6px; word-wrap:break-word; word-break:break-word;"></div>
            </div>

            <div class="group" id="motifContainer" style="display:none;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px;">
                    <div id="motifBilanDiv"><label>Motif bilan incomplet</label><textarea id="txtBn"></textarea></div>
                    <div id="motifPisuDiv"><label>Motif pisu pas ok</label><textarea id="txtBo"></textarea></div>
                </div>
            </div>

            <div class="group" style="border-color: rgba(255,107,107,.3); padding:4px;">
                <label class="cb red" style="margin:0;">
                    <input type="checkbox" id="pbCheck" class="danger-cb">
                    Signaler un probl√®me √† Brice
                </label>
                <div id="pbDetails" style="margin-top:4px; display:none;">
                    <input type="text" id="pbTxt" placeholder="Pr√©cisez..." style="width:100%;">
                </div>
            </div>

            <div class="actions">
                <button class="btn ok" id="sendBtn" onclick="sendApp()">Envoyer et Cl√¥turer</button>
                <button class="btn warn" id="skipBtn" onclick="skipApp()">Ignorer</button>
            </div>
            </div>
        </div>
      </div>
    </div>
  </div>

  <div id="modalDetail" class="modalOverlay" style="z-index:20000;">
    <div class="modalCard" style="width:95%; max-width:1600px; height:98vh;">
      <div class="modalHead">
        <span>D√©tail de l'intervention</span>
        <button class="closeBtn" onclick="closeModalDetail()">√ó</button>
      </div>
      <div id="modalDetailBody" class="modalBody" style="display:flex; gap:0;">
        <!-- Contenu inject√© dynamiquement par loadInterDetail -->
      </div>
    </div>
  </div>
  
  <div id="modalList" class="modalOverlay" style="z-index:15000;"><div class="modalCard" style="max-width:800px;height:80vh;"><div class="modalHead"><span id="modalListTitle">Liste des dossiers</span><button class="closeBtn" onclick="closeModal('modalList')">√ó</button></div>
      <div style="padding:15px;border-bottom:1px solid var(--border);display:flex;gap:15px;flex-wrap:wrap;background:rgba(0,0,0,0.3);" id="filterBox">
          <label><input type="checkbox" checked onchange="filterDetails()" value="Bilan OK"> Bilan OK</label>
          <label><input type="checkbox" checked onchange="filterDetails()" value="Pisu OK"> Pisu OK</label>
          <label><input type="checkbox" checked onchange="filterDetails()" value="Erreur Bilan L√©g√®re"> Erreur Bilan L√©g.</label>
          <label><input type="checkbox" checked onchange="filterDetails()" value="Erreur Pisu L√©g√®re"> Erreur Pisu L√©g.</label>
          <label><input type="checkbox" checked onchange="filterDetails()" value="Erreur Grave"> Erreur Grave</label>
      </div>
      <div class="modalBody" id="modalListContent" style="display:block;padding:0;overflow-y:auto;flex-direction:column;"></div>
  </div></div>

  <div class="toast" id="toast"></div>

  <script>
    // === VARIABLES GLOBALES ===
    let currentAppRow = null;
    let isAppSubmitting = false;
    let currentAppRowNumber = null;

    // --- CORE FUNCTIONS ---
    const lFill=document.getElementById("loadFill"), lPct=document.getElementById("loadPct");
    let loadInt;
    function startLoad(){ document.getElementById("loadingBox").style.display="flex"; let w=0; loadInt=setInterval(()=>{ if(w<90)w+=5; lFill.style.width=w+"%"; lPct.textContent=Math.floor(w)+"%"; },100); }
    function stopLoad(){ clearInterval(loadInt); lFill.style.width="100%"; lPct.textContent="100%"; setTimeout(()=>{ document.getElementById("loadingBox").style.display="none"; lFill.style.width="0"; },300); }
    function toast(m){ const t=document.getElementById("toast"); t.textContent=m; t.style.display="block"; setTimeout(()=>t.style.display="none",3000); }
    function goHome(){ document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); document.getElementById('viewDashboard').classList.add('active'); const m=document.querySelector('.main'); if(m){m.style.padding='25px';m.style.overflow='auto';} }
    function setText(id,v){ const e=document.getElementById(id); if(e) e.textContent=(v==null?"-":v); }
    function getTrendHtml(a,b){ const v1=parseFloat(a)||0, v2=parseFloat(b)||0; if(v2===0 && v1>0) return '<span class="trendUp">\u25b2</span>'; if(v1>v2) return '<span class="trendUp">\u25b2</span>'; if(v1<v2) return '<span class="trendDown">\u25bc</span>'; return '<span class="trendEq">=</span>'; }

    function updateCacheDisplay() {
        google.script.run.withSuccessHandler(status => {
            if(status) {
                document.getElementById("cacheTime").textContent = "Mise en cache: " + status;
            }
        }).getCacheStatus();
    }

    // --- INIT ---
    window.onload = () => {
        startLoad();
        google.script.run.withFailureHandler(e => {
            stopLoad();
            toast("Erreur chargement: " + e.message);
            console.error('getStats2026 failed:', e);
        }).withSuccessHandler(d => {
            stopLoad();
            if(d.error){ toast("Erreur: "+d.error); return; }
            setText("cutoffDateBig", d.date);
            setText("cutoffCompPsud", d.date);
            setText("cutoffCompSect", d.date);
            setText("cutoffCompTotal", d.date);
            setText("cutoffCompAst", d.date);
            setText("psud2026", d.psud); setText("total2026", d.total);
            setText("secteur2026", d.sect); setText("hrs2026", d.ast+" h");
            
            document.querySelector("#tableCis tbody").innerHTML = (d.cis||[]).map(x=>`<tr id="cis_${x.name}"><td>${x.name}</td><td class="num">${x.v26}</td><td class="num v25">...</td><td class="num" style="color:gray">${x.v25tot}</td></tr>`).join('');
            document.querySelector("#tableSect tbody").innerHTML = (d.secteurs||[]).map(x=>`<tr id="sect_${x.name}"><td>${x.name}</td><td class="num">${x.v26}</td><td class="num v25">...</td><td class="num" style="color:gray">${x.v25tot}</td></tr>`).join('');
            
            setText("cntAppBadge", d.cntApp||0); setText("cntIspGBadge", d.cntIspG||0); setText("cntIspRBadge", d.cntIspR||0);

            // 2025 (Deferred)
            const l25 = document.getElementById("loadingBox25"), f25=document.getElementById("loadFill25"), p25=document.getElementById("loadPct25");
            l25.style.display="flex"; let w25=0; const i25 = setInterval(()=>{ if(w25<90)w25+=5; f25.style.width=w25+"%"; p25.textContent=w25+"%"; },100);

            google.script.run.withSuccessHandler(d25 => {
                clearInterval(i25); f25.style.width="100%"; p25.textContent="100%"; setTimeout(()=>l25.style.display="none",300);

                document.getElementById("cacheTime").textContent = "Mise en cache: " + (d25.cacheTime || "N/A");
                document.getElementById("psud2025Badge").innerHTML = `${d25.psud} ${getTrendHtml(d.psud, d25.psud)}`;
                document.getElementById("sect2025Badge").innerHTML = `${d25.sect} ${getTrendHtml(d.sect, d25.sect)}`;
                document.getElementById("total2025Badge").innerHTML = `${d25.total} ${getTrendHtml(d.total, d25.total)}`;
                document.getElementById("hrs2025Badge").innerHTML = `${d25.ast} h ${getTrendHtml(d.ast, d25.ast)}`;
                for(let k in d25.cisMap) { const row = document.getElementById("cis_"+k); if(row) row.querySelector(".v25").textContent = d25.cisMap[k]; }
                for(let k in d25.sectMap) { const row = document.getElementById("sect_"+k); if(row) row.querySelector(".v25").textContent = d25.sectMap[k]; }

                // Pr\u00e9charger toutes les donn\u00e9es automatiquement
                google.script.run.preCacheAllData();
                let cacheInt = setInterval(() => {
                    updateCacheDisplay();
                }, 500);
                setTimeout(() => clearInterval(cacheInt), 60000);

            }).getStats2025();

        }).getStats2026();
        
        // Gestion fl\u00e8che scroll
        const checkScroll = () => {
            const scrollArrow = document.getElementById('scrollArrow');
            const mainEl = document.querySelector('.main');
            if (!scrollArrow || !mainEl) return;
            const scrolled = mainEl.scrollTop;
            const windowHeight = mainEl.clientHeight;
            const docHeight = mainEl.scrollHeight;
            const isAtBottom = (scrolled + windowHeight) >= (docHeight - 50);
            
            if (docHeight > windowHeight && !isAtBottom) {
                scrollArrow.style.display = 'flex';
            } else {
                scrollArrow.style.display = 'none';
            }
        };
        
        const mainEl = document.querySelector('.main');
        if(mainEl) {
            mainEl.addEventListener('scroll', checkScroll);
            window.addEventListener('resize', checkScroll);
            setTimeout(() => {
                checkScroll();
                setInterval(checkScroll, 2000);
            }, 2000);
        }
        
        // Auto-format date input
        const dobInput = document.getElementById('dobInput');
        if(dobInput) {
            dobInput.addEventListener('input', function(e){ 
                if(e.inputType!="deleteContentBackward"){ 
                    let v=this.value; 
                    if(v.length==2||v.length==5) this.value=v+'/'; 
                } 
            });
        }
    };

    function askPass(target) {
        const p=prompt("Mot de passe :");
        if(p==="0007"){
            document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
            const mainEl = document.querySelector('.main');
            if(target==='chef') {
                document.getElementById('viewChefferie').classList.add('active');
                if(mainEl) { mainEl.style.padding='0'; mainEl.style.overflow='hidden'; mainEl.scrollTop=0; }
            }
        } else toast("Erreur");
    }

    // === APP VIEW ===
    function openAppView() {
      const pwd = prompt("Mot de passe :");
      if(pwd !== "APP66") { alert("Code incorrect"); return; }
      document.getElementById('viewContainer').style.display='none';
      document.getElementById('appView').classList.add('active');
      loadNext();
    }

    function closeAppView() {
      document.getElementById('appView').classList.remove('active');
      document.getElementById('viewContainer').style.display='grid';
      goHome();
    }

    function setStatus(t){ document.getElementById("statusPill").textContent=t; }
        function extractDriveFileId(u){
            if(!u) return "";
            const s = String(u);
            let m = s.match(/\/file\/d\/([^\/\?]+)/i);
            if(m && m[1]) return m[1];
            m = s.match(/[?&]id=([^&]+)/i);
            if(m && m[1]) return m[1];
            return "";
        }
        function buildPdfEmbed(u){
            const id = extractDriveFileId(u);
            if(!id) return "";
            // Utiliser l'URL de preview directe sans viewer externe
            return "https://drive.google.com/file/d/" + id + "/preview";
        }
        function buildPdfEmbedModal(u){
            const id = extractDriveFileId(u);
            if(!id) return "";
            return "https://drive.google.com/file/d/" + id + "/preview";
        }
    function setButtons(d){ ["sendBtn","skipBtn"].forEach(i=>document.getElementById(i).disabled=d); }

    document.getElementById("pbCheck").addEventListener("change", (e)=>{
       document.getElementById("pbDetails").style.display = e.target.checked ? "block" : "none";
    });

    function loadNext(specificRow){
      if(isAppSubmitting) return;
      setStatus("Recherche..."); setButtons(true);
      
      // Afficher loader
      document.getElementById("loadingBox").style.display="flex";
      let w=0; 
      const loadInt = setInterval(()=>{ 
          if(w<90) w+=5; 
          document.getElementById("loadFill").style.width=w+"%"; 
          document.getElementById("loadPct").textContent=Math.floor(w)+"%"; 
      }, 100);
      
      google.script.run.withSuccessHandler(res=>{
        clearInterval(loadInt);
        document.getElementById("loadFill").style.width="100%";
        document.getElementById("loadPct").textContent="100%";
        setTimeout(()=>document.getElementById("loadingBox").style.display="none", 300);
        
        setButtons(false);
        document.getElementById("remainingPill").textContent = "Reste : "+(res.remaining||0);

        if(res.done){
          setStatus("Termin\u00e9"); 
          toast(res.message);
          document.getElementById("mainForm").innerHTML = `<div style="text-align:center;color:var(--muted);margin-top:50px;">${res.message}</div>`;
          document.getElementById("pdfFrame").src="";
          return;
        }

        currentAppRow = res.rowNumber;
        currentAppRowNumber = res.rowNumber;
        setStatus("Fiche pr\u00eate");
        
        const info = res.info;
        setText("iNum", info.interId);
        setText("iDate", info.date);
        setText("iInf", info.infName);
        setText("iCis", info.cis);
        setText("iMotif", info.motif);
        setText("iEngin", info.engin);

        const pdfUrl = buildPdfEmbed(res.url);
        document.getElementById("pdfFrame").src = pdfUrl; 
        document.getElementById("openPdfLink").href = res.url || "#";
        document.getElementById("pdfPlaceholder").style.display = pdfUrl ? "none" : "block";

        renderForm(res.schema, res.ispList);

      }).withFailureHandler(err=>{ 
        clearInterval(loadInt);
        document.getElementById("loadingBox").style.display="none";
        setStatus("Erreur"); toast(err.message,"err"); setButtons(false); 
      }).getNextCase(specificRow);
    }

    function renderForm(schema, ispList) {
       fillSelect("ispSelect", ispList, schema.ispVal);

       const mkCb = (boxId, items) => {
         const box = document.getElementById(boxId);
         box.innerHTML = "";
         if (!items || !Array.isArray(items)) return;
         
         // Pour biBmBox, cr\u00e9er un layout group\u00e9
         if(boxId === "biBmBox") {
            let currentRow = null;
            let itemsInRow = 0;
            
            items.forEach((item, idx) => {
               // "Absence tra\u00e7abilit\u00e9" seule sur sa ligne
               const isAbsenceTracabilite = item.label.includes("Absence tra\u00e7abilit\u00e9");
               const itemsPerRow = isAbsenceTracabilite ? 1 : 2;
               
               // Cr\u00e9er une nouvelle ligne si n\u00e9cessaire
               if(itemsInRow === 0) {
                  currentRow = document.createElement("div");
                  currentRow.style.display = "grid";
                  currentRow.style.gridTemplateColumns = itemsPerRow === 1 ? "1fr" : "1fr 1fr";
                  currentRow.style.gap = "6px";
                  currentRow.style.marginBottom = "6px";
                  box.appendChild(currentRow);
                  itemsInRow = 0;
               } else if(itemsInRow >= 2) {
                  // Si on a 2 items et qu'on en ajoute un 3e, cr\u00e9er une nouvelle ligne
                  currentRow = document.createElement("div");
                  currentRow.style.display = "grid";
                  currentRow.style.gridTemplateColumns = "1fr 1fr";
                  currentRow.style.gap = "6px";
                  currentRow.style.marginBottom = "6px";
                  box.appendChild(currentRow);
                  itemsInRow = 0;
               }
               
               const lbl = document.createElement("label");
               lbl.className = "cb";
               if(item.color === "ok") {
                 lbl.style.borderColor = "rgba(71,209,140,.3)";
                 lbl.style.color = "var(--ok)";
               } else if(item.color === "orange") {
                 lbl.style.borderColor = "rgba(255,165,0,.3)";
                 lbl.style.color = "#ff8c00";
               }
               lbl.innerHTML = `<input type="checkbox" name="chk_${item.id}" ${item.checked?'checked':''}> ${item.label}`;
               currentRow.appendChild(lbl);
               itemsInRow++;
               
               // Si c'est "Absence tra\u00e7abilit\u00e9", reset pour la prochaine ligne
               if(isAbsenceTracabilite) {
                  itemsInRow = 0;
               }
            });
         } else {
            // Layout standard pour autres
            items.forEach(item => {
               const lbl = document.createElement("label");
               lbl.className = "cb";
               if(item.color === "ok") {
                 lbl.style.borderColor = "rgba(71,209,140,.3)";
                 lbl.style.color = "var(--ok)";
               } else if(item.color === "orange") {
                 lbl.style.borderColor = "rgba(255,165,0,.3)";
                 lbl.style.color = "#ff8c00";
               }
               lbl.innerHTML = `<input type="checkbox" name="chk_${item.colIdx}" data-col="${item.colIdx}" ${item.checked?'checked':''} /> ${item.label}`;
               box.appendChild(lbl);
            });
         }
       };

       mkCb("protoAdultBox", schema.protoAdult || []);
       mkCb("protoPediaBox", schema.protoPedia || []);
       
       const c = schema.criteres;
       fillSelect("selAx", c.ax.opts, c.ax.val); document.getElementById("lblAx").textContent = c.ax.label;
       fillSelect("selAy", c.ay.opts, c.ay.val); document.getElementById("lblAy").textContent = c.ay.label;
       fillSelect("selAz", c.az.opts, c.az.val); document.getElementById("lblAz").textContent = c.az.label;
       fillSelect("selBa", c.ba.opts, c.ba.val); document.getElementById("lblBa").textContent = c.ba.label;
       fillSelect("selBb", c.bb.opts, c.bb.val); document.getElementById("lblBb").textContent = c.bb.label;
       
       document.getElementById("lblBc").textContent = c.bc.label;
       document.getElementById("txtBc").value = c.bc.val;
       
       fillSelect("selBg", c.bg.opts, c.bg.val); document.getElementById("lblBg").textContent = c.bg.label;

       const r = schema.resultats;
       
       document.getElementById("lblBh").textContent = r.bh.label;
       document.getElementById("chkBh").checked = r.bh.checked;

       mkCb("biBmBox", r.checksBiBm);

       document.getElementById("txtBn").value = schema.fieldBn.val;
       document.getElementById("txtBo").value = schema.fieldBo.val;

       const pbCb = document.getElementById("pbCheck");
       pbCb.checked = !!schema.pbCheck;
       document.getElementById("pbTxt").value = schema.pbTxt; 
       document.getElementById("pbDetails").style.display = schema.pbCheck ? "block" : "none";

       // Ajouter logique conditionnelle pour afficher/masquer les motifs
       updateMotifVisibility();
       
       // Ajouter event listeners sur les checkboxes du r\u00e9sultat
       const checkboxes = document.querySelectorAll('#biBmBox input[type="checkbox"]');
       checkboxes.forEach(cb => {
           cb.addEventListener('change', updateMotifVisibility);
       });
    }

    function updateMotifVisibility() {
       // R\u00e9cup\u00e9rer les checkboxes de biBmBox
       const checkboxes = document.querySelectorAll('#biBmBox input[type="checkbox"]');
       let hasBilanIncomplet = false;
       let hasPisuPasOk = false;
       
       checkboxes.forEach(cb => {
           // Chercher le texte du label - peut \u00eatre dans un span ou directement apr\u00e8s l'input
           let labelText = '';
           const parent = cb.closest('label');
           if(parent) {
               labelText = parent.textContent;
           } else if(cb.nextElementSibling) {
               labelText = cb.nextElementSibling.textContent;
           }
           
           labelText = labelText.toLowerCase();
           if(labelText.includes('bilan') && labelText.includes('incomplet')) {
               if(cb.checked) hasBilanIncomplet = true;
           }
           if(labelText.includes('pisu') && labelText.includes('pas ok')) {
               if(cb.checked) hasPisuPasOk = true;
           }
       });
       
       // Afficher/masquer le conteneur des motifs
       const motifContainer = document.getElementById("motifContainer");
       if(hasBilanIncomplet || hasPisuPasOk) {
           motifContainer.style.display = "block";
       } else {
           motifContainer.style.display = "none";
       }
       
       // Afficher/masquer les motifs individuels
       const motifBilanDiv = document.getElementById("motifBilanDiv");
       const motifPisuDiv = document.getElementById("motifPisuDiv");
       if(motifBilanDiv) motifBilanDiv.style.display = hasBilanIncomplet ? "block" : "none";
       if(motifPisuDiv) motifPisuDiv.style.display = hasPisuPasOk ? "block" : "none";
    }

    function fillSelect(id, opts, currentVal) {
       const s = document.getElementById(id);
       s.innerHTML = '<option value="">\u2014</option>';
       if(opts) {
           opts.forEach(o => {
               const op = document.createElement("option");
               op.value = o; op.textContent = o;
               if(String(o) === String(currentVal)) op.selected = true;
               s.appendChild(op);
           });
       }
    }

    function sendApp(){
      if(!currentAppRow){ toast("Erreur: aucune fiche","err"); return; }
      const isp = document.getElementById("ispSelect").value;
      if(!isp) { toast("Veuillez s\u00e9lectionner l'ISP Analyse","err"); return; }

      isAppSubmitting = true;
      setStatus("Enregistrement..."); setButtons(true);

      const checks = {};
      document.querySelectorAll('input[type="checkbox"][name^="chk_"]').forEach(cb => {
         const colIdx = parseInt(cb.getAttribute('data-col'));
         checks[colIdx] = cb.checked;
      });

      const payload = {
         rowNumber: currentAppRowNumber,
         isp: isp,
         checks: checks,
         criteres: {
            ax: document.getElementById("selAx").value,
            ay: document.getElementById("selAy").value,
            az: document.getElementById("selAz").value,
            ba: document.getElementById("selBa").value,
            bb: document.getElementById("selBb").value,
            bc: document.getElementById("txtBc").value
         },
         resultats: {
            bg: document.getElementById("selBg").value,
            bh: document.getElementById("chkBh").checked,
            bi: (document.querySelector('input[name="chk_bi"]') || {}).checked || false,
            bj: (document.querySelector('input[name="chk_bj"]') || {}).checked || false,
            bk: (document.querySelector('input[name="chk_bk"]') || {}).checked || false,
            bl: (document.querySelector('input[name="chk_bl"]') || {}).checked || false,
            bm: (document.querySelector('input[name="chk_bm"]') || {}).checked || false
         },
         txtBn: document.getElementById("txtBn").value,
         txtBo: document.getElementById("txtBo").value,
         pbCheck: document.getElementById("pbCheck").checked,
         pbTxt: document.getElementById("pbTxt").value
      };

      console.log("Sending saveCase payload:", payload);
      google.script.run.withSuccessHandler((res)=>{ 
          console.log("saveCase success:", res);
          isAppSubmitting = false;
          setStatus("Sauvegard\u00e9"); 
          toast("Enregistr\u00e9 et Cl\u00f4tur\u00e9 \u2705"); 
          loadNext(); 
      })
      .withFailureHandler(e=>{ 
          console.error("saveCase error:", e);
          isAppSubmitting = false;
          setStatus("Erreur"); 
          toast("Erreur: " + e.message,"err"); 
          setButtons(false); 
      }).saveCase(payload);
    }

    function skipApp(){ 
        if(!currentAppRow) return; 
        currentAppRow = null;
        loadNext(); 
    }

    // ISP
    let window_currentIspData = {};
    function loginIsp() {
        const m=document.getElementById("matInput").value, d=document.getElementById("dobInput").value;
        if(!m||!d) { toast("Infos manquantes"); return; }
        document.getElementById("ispLoadBox").style.display="inline-block";
        let w=0; const i=setInterval(()=>{ if(w<90) w+=10; document.getElementById("ispFill").style.width=w+"%"; document.getElementById("ispPct").textContent=w+"%"; }, 100);
        google.script.run.withSuccessHandler(res => {
            clearInterval(i); document.getElementById("ispFill").style.width="100%"; document.getElementById("ispPct").textContent="100%";
            setTimeout(()=>document.getElementById("ispLoadBox").style.display="none", 300);
            if(res.error) { toast(res.error); return; }
            document.getElementById("ispLogin").style.display="none";
            document.getElementById("ispData").style.display="block";
            document.getElementById("ispNameDisplay").textContent = res.nom;
            
            setText("ispAst26", Math.ceil(res.astreinte2026)); setText("ispAst25Ytd", Math.ceil(res.astreinte2025_ytd)); setText("ispAst25Tot", res.astreinte2025_tot);
            document.getElementById("ispAstTrend").innerHTML = getTrendHtml(res.astreinte2026, res.astreinte2025_ytd);
            setText("ispGarde26", Math.ceil(res.garde2026)); setText("ispGarde25Ytd", Math.ceil(res.garde2025_ytd)); setText("ispGarde25Tot", res.garde2025_tot);
            document.getElementById("ispGardeTrend").innerHTML = getTrendHtml(res.garde2026, res.garde2025_ytd);
            setText("ispInter26", res.inter2026); setText("ispInter25Ytd", res.inter2025_ytd); setText("ispInter25Tot", res.inter2025_tot);
            document.getElementById("ispInterTrend").innerHTML = getTrendHtml(res.inter2026, res.inter2025_ytd);
            
            setText("ispBilanOk", (res.bilanOkCount||0)); setText("ispPisuOk", (res.pisuOkCount||0));
            setText("ispErrBil", (res.errLegereBilan||[]).length); setText("ispErrPisu", (res.errLegerePisu||[]).length); setText("ispErrLourd", (res.errLourde||[]).length);
            window_currentIspData = res;
        }).getIspStats(m, d);
    }
    function logoutIsp(){ document.getElementById("ispData").style.display="none"; document.getElementById("ispLogin").style.display="flex"; window_currentIspData={}; currentDetailList=[]; }
    
    function refreshIspData() {
        const mat = document.getElementById("matInput").value;
        if(!mat) { toast("Matricule requis"); return; }
        // Fermer le modal s'il est ouvert
        document.getElementById("modalList").style.display = "none";
        currentDetailList = []; // Vider la liste en cache
        google.script.run.withSuccessHandler(() => {
            toast("Cache vid\u00e9 - rechargement...");
            loginIsp();
        }).clearIspCache(mat);
    }

    function openErrorList(type) {
        if(!window_currentIspData || !window_currentIspData.nom) return;
        
        // R\u00e9cup\u00e9rer le matricule depuis les inputs
        const mat = document.getElementById("matInput").value;
        if(!mat) { toast("Matricule requis"); return; }
        
        // Si les donn\u00e9es sont d\u00e9j\u00e0 charg\u00e9es ET le modal est visible, juste mettre \u00e0 jour les checkboxes
        if(currentDetailList && currentDetailList.length > 0 && document.getElementById("modalList").style.display === "flex") {
            const typeMap = {
                'Bilan': 'Bilan OK',
                'Pisu': 'Pisu OK',
                'BilanLeg': 'Erreur Bilan L\u00e9g\u00e8re',
                'PisuLeg': 'Erreur Pisu L\u00e9g\u00e8re',
                'Grave': 'Erreur Grave'
            };
            const filterValue = typeMap[type] || "";
            
            // Cocher seulement le type cliqu\u00e9
            document.querySelectorAll('#filterBox input[type="checkbox"]').forEach(cb => {
                cb.checked = cb.value === filterValue;
            });
            filterDetails();
            return; // Pas besoin de recharger les donn\u00e9es
        }
        
        // Chargement: charger TOUTES les donn\u00e9es fra\u00eeches
        google.script.run.withSuccessHandler(fullList => {
            // Stocker toutes les donn\u00e9es en m\u00e9moire pour filtrage c\u00f4t\u00e9 client
            currentDetailList = fullList;
            
            // Initialiser tous les checkboxes \u00e0 coch\u00e9
            document.querySelectorAll('#filterBox input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            
            document.getElementById("modalListTitle").textContent = `Dossiers de ${window_currentIspData.nom}`;
            filterDetails();
            document.getElementById("modalList").style.display="flex";
        }).getIspDetailsAdmin(mat);
    }

    // ADMIN
    let adminDataCache = [], adminSortDir = -1, adminSortCol = 1;
    function loadAdmin() {
        if(document.getElementById("adminPwd").value!=="0007") { toast("Erreur code"); return; }
        
        document.getElementById("adminLogin").style.display="none";
        document.getElementById("adminLoadBox").style.display="block";
        
        let w=0; 
        const i=setInterval(()=>{ 
            if(w<90) w+=8; 
            document.getElementById("adminFill").style.width=w+"%"; 
            document.getElementById("adminPct").textContent=w+"%"; 
        }, 120);
        
        google.script.run.withSuccessHandler(res => {
            clearInterval(i); 
            document.getElementById("adminFill").style.width="100%"; 
            document.getElementById("adminPct").textContent="100%";
            setTimeout(()=> { 
                document.getElementById("adminLoadBox").style.display="none"; 
                document.getElementById("adminData").style.display="block"; 
            }, 300);
            
            adminDataCache = res.activity.map(a => ({ 0:a.nom, 1:a.interHg26, 2:a.interHg25, 3:a.interG26, 4:a.interG25, 5:a.hAst26, 6:a.hAst25, 7:a.hGarde26, 8:a.hGarde25 }));
            renderAdminTable();
            document.getElementById("adminSollTbody").innerHTML = res.sollicitation.map(s => `<tr><td>${s.nom}</td><td class="num"><b>${s.tx}</b></td></tr>`).join('');
            
            // Remplir tableaux CIS et Secteurs depuis getStats2025() pour avoir les bonnes donn\u00e9es YTD
            google.script.run.withSuccessHandler(stats25 => {
                // R\u00e9cup\u00e9rer les comptages 2025 YTD depuis cisMap et sectMap
                const cisNames = Object.keys(stats25.cisMap || {});
                const sectNames = Object.keys(stats25.sectMap || {});
                
                // R\u00e9cup\u00e9rer aussi les totaux 2026 et 2025 total depuis getStats2026
                google.script.run.withSuccessHandler(stats26 => {
                    // Combiner les donn\u00e9es: cisMap pour 2025 YTD, cis array pour 2026 et 2025 total
                    const cisData = (stats26.cis || []).map(x => ({
                        name: x.name,
                        v26: x.v26,
                        v25ytd: stats25.cisMap[x.name] || 0,
                        v25tot: x.v25tot
                    }));
                    const sectData = (stats26.secteurs || []).map(x => ({
                        name: x.name,
                        v26: x.v26,
                        v25ytd: stats25.sectMap[x.name] || 0,
                        v25tot: x.v25tot
                    }));
                    
                    // Trier par 2026 d\u00e9croissant
                    const cisSorted = cisData.sort((a,b) => b.v26 - a.v26);
                    const sectSorted = sectData.sort((a,b) => b.v26 - a.v26);
                    
                    document.querySelector("#tableAdminCis tbody").innerHTML = cisSorted.map(x => `<tr><td>${x.name}</td><td class="num"><b>${x.v26}</b></td><td class="num" style="color:gray">${x.v25ytd}</td><td class="num" style="color:gray">${x.v25tot}</td></tr>`).join('');
                    document.querySelector("#tableAdminSect tbody").innerHTML = sectSorted.map(x => `<tr><td>${x.name}</td><td class="num"><b>${x.v26}</b></td><td class="num" style="color:gray">${x.v25ytd}</td><td class="num" style="color:gray">${x.v25tot}</td></tr>`).join('');
                }).getStats2026();
            }).getStats2025();
        }).withFailureHandler(e => {
            clearInterval(i);
            toast("Erreur: " + e.message);
            document.getElementById("adminLoadBox").style.display="none";
            document.getElementById("adminLogin").style.display="flex";
        }).getAdminData("0007");
    }
    
    function renderAdminTable() {
        document.getElementById("adminTbody").innerHTML = adminDataCache.map(r => `<tr><td><b>${r[0]}</b></td><td class="num"><b>${r[1]}</b></td><td class="num" style="color:gray">${r[2]}</td><td class="num"><b>${r[3]}</b></td><td class="num" style="color:gray">${r[4]}</td><td class="num"><b>${Math.ceil(r[5])}</b></td><td class="num" style="color:gray">${Math.ceil(r[6])}</td><td class="num"><b>${Math.ceil(r[7])}</b></td><td class="num" style="color:gray">${Math.ceil(r[8])}</td></tr>`).join('');
    }
    
    function sortAdmin(colIdx) {
        if(adminSortCol === colIdx) adminSortDir *= -1; else { adminSortCol = colIdx; adminSortDir = colIdx===0?1:-1; }
        adminDataCache.sort((a,b) => { let v1=a[colIdx], v2=b[colIdx]; if(typeof v1==='string'){v1=v1.toLowerCase();v2=v2.toLowerCase();} if(v1>v2)return adminSortDir; if(v1<v2)return -adminSortDir; return 0; });
        for(let i=0; i<9; i++) document.getElementById("sortA"+i).textContent="\u2195";
        document.getElementById("sortA"+colIdx).textContent = adminSortDir===1 ? "\u25b2" : "\u25bc";
        renderAdminTable();
    }
    
    function filterAdmin() {
        const terms = document.getElementById("adminSearch").value.toLowerCase().split(';').map(t=>t.trim()).filter(t=>t);
        document.querySelectorAll("#adminTbody tr").forEach(r => {
            const txt = r.innerText.toLowerCase();
            r.style.display = (terms.length===0 || terms.some(t => txt.includes(t))) ? "" : "none";
        });
        document.querySelectorAll("#adminSollTbody tr").forEach(r => {
            const txt = r.innerText.toLowerCase();
            r.style.display = (terms.length===0 || terms.some(t => txt.includes(t))) ? "" : "none";
        });
    }

    // === NOUVELLE INTERFACE CHEFFERIE ===
    let currentChefData = null;
    
    function showChefferieMode(mode) {
        // Masquer tous les modes
        document.getElementById('chefModeApp').style.display = 'none';
        document.getElementById('chefModeMed').style.display = 'none';
        document.getElementById('chefModeAction').style.display = 'none';
        document.getElementById('chefModeData').style.display = 'none';
        const mainEl = document.querySelector('.main');
        if(mainEl) mainEl.scrollTop = 0;
        
        if(mode === 'app') {
            document.getElementById('chefModeApp').style.display = 'block';
            loadAppChefferie();
        } else if(mode === 'med') {
            document.getElementById('chefModeMed').style.display = 'block';
            loadMedecinChef();
        } else if(mode === 'action') {
            document.getElementById('chefModeAction').style.display = 'block';
            loadActionChefferie();
        } else if(mode === 'data') {
            document.getElementById('chefModeData').style.display = 'block';
            loadGlobalList();
        }
    }
    
    function loadChefferieCounts() {
        google.script.run.withSuccessHandler(res => {
            if(res) {
                setText("cntIspGBadge", res.isp||0);
                setText("cntIspRBadge", res.med||0);
            }
        }).getChefferieCounts();
    }
    
    function loadAppChefferie() {
        const div = document.getElementById('chefAppContent');
        div.innerHTML = '<div style="text-align:center;padding:40px;color:gray;">Chargement...</div>';
        
        google.script.run.withSuccessHandler(res => {
            if(!res.found) {
                div.innerHTML = `<div style="text-align:center;padding:40px;color:var(--accent3);">${res.message}</div>`;
                return;
            }
            currentChefData = res;
            renderAppChefferie(res);
        }).getNextAppChefferie();
    }
    
    function renderAppChefferie(data) {
        const div = document.getElementById('chefAppContent');
        const info = data.info;
        
        div.innerHTML = `
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; height:calc(100vh - 200px);">
                <!-- PDF \u00e0 gauche -->
                <div style="border:1px solid var(--border); border-radius:12px; overflow:hidden; position:relative;">
                    <iframe src="${(info.pdf||'').replace('/view','/preview')}" style="width:100%; height:100%; border:none; position:absolute; top:0; left:0;"></iframe>
                </div>
                
                <!-- Formulaire \u00e0 droite -->
                <div style="overflow-y:auto; padding:15px;">
                    <div class="panel">
                        <div class="panelHead">Fiche Intervention</div>
                        <div class="panelBody">
                            <div style="margin-bottom:10px;"><strong>ID:</strong> ${info.interId}</div>
                            <div style="margin-bottom:10px;"><strong>Date:</strong> ${info.date}</div>
                            <div style="margin-bottom:10px;"><strong>ISP:</strong> ${info.infName}</div>
                            <div style="margin-bottom:10px;"><strong>Statut:</strong> ${info.status}</div>
                            <div style="margin-bottom:10px;"><strong>Motif:</strong> ${info.motif}</div>
                            <div style="margin-bottom:10px;"><strong>Engin:</strong> ${info.engin}</div>
                        </div>
                    </div>
                    
                    ${info.bilanKo ? `<div class="panel" style="margin-top:15px;">
                        <div class="panelHead">Motif Bilan Incomplet (lecture seule)</div>
                        <div class="panelBody">
                            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:6px; font-size:12px;">${info.motifBilan || 'Aucun motif renseign\u00e9'}</div>
                        </div>
                    </div>` : ''}
                    
                    ${info.pisuKo ? `<div class="panel" style="margin-top:15px;">
                        <div class="panelHead">Motif Pisu Incomplet (lecture seule)</div>
                        <div class="panelBody">
                            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:6px; font-size:12px;">${info.motifPisu || 'Aucun motif renseign\u00e9'}</div>
                        </div>
                    </div>` : ''}
                    
                    <div class="panel" style="margin-top:15px;">
                        <div class="panelHead">C\u00f4ter la fiche</div>
                        <div class="panelBody">
                            <label class="cb" style="background:rgba(71,209,140,.1); border-color:rgba(71,209,140,.3); margin-bottom:8px;">
                                <input type="checkbox" id="chkH" ${data.checks.H?'checked':''}>
                                <span style="color:var(--ok);">\u2713 Passer Bilan en OK</span>
                            </label>
                            <label class="cb" style="background:rgba(71,209,140,.1); border-color:rgba(71,209,140,.3); margin-bottom:8px;">
                                <input type="checkbox" id="chkI" ${data.checks.I?'checked':''}>
                                <span style="color:var(--ok);">\u2713 Passer Pisu en OK</span>
                            </label>
                            <label class="cb" style="background:rgba(255,165,0,.1); border-color:rgba(255,165,0,.3); margin-bottom:8px;">
                                <input type="checkbox" id="chkJ" ${data.checks.J?'checked':''}>
                                <span style="color:orange;">\u26a0 Erreur Bilan L\u00e9g\u00e8re</span>
                            </label>
                            <label class="cb" style="background:rgba(255,165,0,.1); border-color:rgba(255,165,0,.3); margin-bottom:8px;">
                                <input type="checkbox" id="chkK" ${data.checks.K?'checked':''}>
                                <span style="color:orange;">\u26a0 Erreur Pisu L\u00e9g\u00e8re</span>
                            </label>
                            <label class="cb" style="background:rgba(255,107,107,.1); border-color:rgba(255,107,107,.3); margin-bottom:8px;">
                                <input type="checkbox" id="chkL" ${data.checks.L?'checked':''}>
                                <span style="color:var(--danger);">\uD83D\uDEA8 Erreur Grave</span>
                            </label>
                            
                            <div style="margin-top:15px;">
                                <label style="display:block; margin-bottom:5px; font-size:11px; font-weight:bold;">Commentaire Chefferie</label>
                                <textarea id="txtCommentChef" style="width:100%; min-height:80px;">${data.commentChef}</textarea>
                            </div>
                            
                            <div style="margin-top:20px; display:flex; gap:10px;">
                                <button class="btn ok" style="flex:1;" onclick="saveAndNextAppChef()">\uD83D\uDCBE Cl\u00f4turer et Suivant</button>
                                <button class="btn" style="flex:1;" onclick="skipToNextAppChef()">Suivant sans valider</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function saveAndNextAppChef() {
        const form = {
            interId: currentChefData.info.interId,
            rowAlex: currentChefData.rowAlex,
            checks: {
                H: document.getElementById('chkH').checked,
                I: document.getElementById('chkI').checked,
                J: document.getElementById('chkJ').checked,
                K: document.getElementById('chkK').checked,
                L: document.getElementById('chkL').checked
            },
            commentChef: document.getElementById('txtCommentChef').value
        };
        
        document.getElementById('chefAppContent').innerHTML = '<div style="text-align:center;padding:40px;">Enregistrement...</div>';
        
        google.script.run.withSuccessHandler(() => {
            toast("Fiche cl\u00f4tur\u00e9e \u2705");
            loadChefferieCounts(); // Mettre \u00e0 jour les badges
            loadAppChefferie(); // Charger la suivante
        }).withFailureHandler(e => {
            toast("Erreur: " + e.message, "err");
            loadAppChefferie();
        }).saveAppChefferie(form);
    }
    
    function loadMedecinChef() {
        const div = document.getElementById('chefMedContent');
        div.innerHTML = '<div style="text-align:center;padding:40px;color:gray;">Chargement...</div>';
        
        google.script.run.withSuccessHandler(res => {
            if(!res.found) {
                div.innerHTML = `<div style="text-align:center;padding:40px;color:var(--accent3);">${res.message}</div>`;
                return;
            }
            currentChefData = res;
            renderMedecinChef(res);
        }).getNextMedecinChef();
    }
    
    function renderMedecinChef(data) {
        const div = document.getElementById('chefMedContent');
        const info = data.info;
        
        div.innerHTML = `
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; height:calc(100vh - 200px);">
                <!-- PDF \u00e0 gauche -->
                <div style="border:1px solid var(--border); border-radius:12px; overflow:hidden; position:relative;">
                    <iframe src="${(info.pdf||'').replace('/view','/preview')}" style="width:100%; height:100%; border:none; position:absolute; top:0; left:0;"></iframe>
                </div>
                
                <!-- Formulaire \u00e0 droite -->
                <div style="overflow-y:auto; padding:15px;">
                    <div class="panel">
                        <div class="panelHead" style="background:rgba(255,107,107,.2);">\u26a0\ufe0f Erreur Grave</div>
                        <div class="panelBody">
                            <div style="margin-bottom:10px;"><strong>ID:</strong> ${info.interId}</div>
                            <div style="margin-bottom:10px;"><strong>Date:</strong> ${info.date}</div>
                            <div style="margin-bottom:10px;"><strong>ISP:</strong> ${info.infName}</div>
                            <div style="margin-bottom:10px;"><strong>Statut:</strong> ${info.status}</div>
                            <div style="margin-bottom:10px;"><strong>Motif:</strong> ${info.motif}</div>
                            <div style="margin-bottom:10px;"><strong>Engin:</strong> ${info.engin}</div>
                        </div>
                    </div>
                    
                    ${info.commentChef ? `<div class="panel" style="margin-top:15px;">
                        <div class="panelHead">Commentaire Chefferie</div>
                        <div class="panelBody">
                            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:6px; font-size:12px;">${info.commentChef}</div>
                        </div>
                    </div>` : ''}
                    
                    <div class="panel" style="margin-top:15px;">
                        <div class="panelHead">Analyse M\u00e9decin Cheffe</div>
                        <div class="panelBody">
                            <div style="margin-bottom:15px;">
                                <label style="display:block; margin-bottom:5px; font-size:11px; font-weight:bold;">Analyse</label>
                                <textarea id="txtAnalyse" style="width:100%; min-height:100px;" placeholder="Votre analyse de l'erreur grave..."></textarea>
                            </div>
                            
                            <div>
                                <label style="display:block; margin-bottom:5px; font-size:11px; font-weight:bold;">Action Requise</label>
                                <textarea id="txtAction" style="width:100%; min-height:80px;" placeholder="Actions \u00e0 mener..."></textarea>
                            </div>
                            
                            <div style="margin-top:20px;">
                                <button class="btn ok" style="width:100%;" onclick="saveAndNextMedChef()">\uD83D\uDCBE Enregistrer et Suivant</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function saveAndNextMedChef() {
        const form = {
            interId: currentChefData.info.interId,
            analyse: document.getElementById('txtAnalyse').value,
            action: document.getElementById('txtAction').value
        };
        
        document.getElementById('chefMedContent').innerHTML = '<div style="text-align:center;padding:40px;">Enregistrement...</div>';
        
        google.script.run.withSuccessHandler(() => {
            toast("Analyse enregistr\u00e9e \u2705");
            loadChefferieCounts(); // Mettre \u00e0 jour les badges
            loadMedecinChef(); // Charger la suivante
        }).withFailureHandler(e => {
            toast("Erreur: " + e.message, "err");
            loadMedecinChef();
        }).saveMedecinAnalyse(form);
    }

    // === ACTION \u00c0 MENER CHEFFERIE ===
    let currentActionData = null;
    
    function loadActionChefferie() {
        const div = document.getElementById('chefActionContent');
        div.innerHTML = '<div style="text-align:center;padding:40px;color:gray;">Chargement...</div>';
        
        google.script.run.withSuccessHandler(res => {
            if(!res.found) {
                div.innerHTML = `<div style="text-align:center;padding:40px;color:var(--accent3);">${res.message}</div>
                    <div style="text-align:center;margin-top:20px;">
                        <button class="btnGo" onclick="openArchivedActions()">\uD83D\uDCC1 Voir toutes les actions men\u00e9es</button>
                    </div>`;
                return;
            }
            currentActionData = res;
            renderActionChefferie(res);
        }).getNextActionChefferie();
    }
    
    function renderActionChefferie(data) {
        const div = document.getElementById('chefActionContent');
        const info = data.info;
        
        div.innerHTML = `
            <div style="margin-bottom:15px; text-align:right;">
                <button class="btnGo" style="background:#444;border-color:#666;" onclick="openArchivedActions()">\uD83D\uDCC1 Voir toutes les actions men\u00e9es</button>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; height:calc(100vh - 280px);">
                <!-- PDF \u00e0 gauche -->
                <div style="border:1px solid var(--border); border-radius:12px; overflow:hidden; position:relative;">
                    <iframe src="${(info.pdf||'').replace('/view','/preview')}" style="width:100%; height:100%; border:none; position:absolute; top:0; left:0;"></iframe>
                </div>
                
                <!-- Infos + Action \u00e0 droite -->
                <div style="overflow-y:auto; padding:15px;">
                    <div class="panel">
                        <div class="panelHead">Informations Intervention</div>
                        <div class="panelBody">
                            <div style="margin-bottom:10px;"><strong>N\u00b0 Intervention:</strong> ${info.interId}</div>
                            <div style="margin-bottom:10px;"><strong>Date:</strong> ${info.date}</div>
                            <div style="margin-bottom:10px;"><strong>ISP:</strong> ${info.infName}</div>
                            <div style="margin-bottom:10px;"><strong>Astreinte/Garde:</strong> ${info.status}</div>
                            <div style="margin-bottom:10px;"><strong>Motif de d\u00e9part:</strong> ${info.motif}</div>
                            <div style="margin-bottom:10px;"><strong>Engin:</strong> ${info.engin || '-'}</div>
                        </div>
                    </div>
                    
                    ${info.commChef ? `<div class="panel" style="margin-top:15px;">
                        <div class="panelHead" style="background:rgba(79,195,247,.1);">\uD83D\uDCAC Commentaire Chefferie (APP Alex)</div>
                        <div class="panelBody">
                            <div class="static-box">${info.commChef}</div>
                        </div>
                    </div>` : ''}
                    
                    ${info.analyseMed ? `<div class="panel" style="margin-top:15px;">
                        <div class="panelHead" style="background:rgba(255,107,107,.15);">\uD83E\uDE7A Analyse M\u00e9decin (APP Eve)</div>
                        <div class="panelBody">
                            <div class="static-box" style="color:var(--red);">${info.analyseMed}</div>
                        </div>
                    </div>` : ''}
                    
                    ${info.actionRequise ? `<div class="panel" style="margin-top:15px;">
                        <div class="panelHead" style="background:rgba(255,165,0,.15);">\u26a0\ufe0f Action Requise (APP Eve)</div>
                        <div class="panelBody">
                            <div class="static-box" style="color:var(--orange);">${info.actionRequise}</div>
                        </div>
                    </div>` : ''}
                    
                    <div class="panel" style="margin-top:15px;">
                        <div class="panelHead" style="background:rgba(71,209,140,.15);">\u2705 Action faite par Chefferie</div>
                        <div class="panelBody">
                            <textarea id="txtActionFaite" style="width:100%; min-height:100px;" placeholder="D\u00e9crivez l'action men\u00e9e...">${info.actionFaite || ''}</textarea>
                            
                            <div style="margin-top:15px; display:flex; gap:10px;">
                                <button class="btn ok" style="flex:1;" onclick="saveAndNextAction()">\uD83D\uDCBE Cl\u00f4turer et Suivant</button>
                                <button class="btn" style="flex:1;" onclick="skipToNextAction()">Suivant sans valider</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function saveAndNextAction() {
        if(!currentActionData) return;
        const actionText = document.getElementById('txtActionFaite').value;
        if(!actionText.trim()) { toast("D\u00e9crivez l'action men\u00e9e"); return; }
        
        const form = {
            rowEve: currentActionData.rowEve,
            actionFaite: actionText
        };
        
        document.getElementById('chefActionContent').innerHTML = '<div style="text-align:center;padding:40px;">Enregistrement...</div>';
        
        google.script.run.withSuccessHandler(() => {
            toast("Action cl\u00f4tur\u00e9e \u2705");
            loadChefferieCounts();
            loadActionChefferie();
        }).withFailureHandler(e => {
            toast("Erreur: " + e.message);
            loadActionChefferie();
        }).saveActionChefferie(form);
    }
    
    function skipToNextAction() {
        loadActionChefferie();
    }
    
    // === ACTIONS ARCHIV\u00c9ES ===
    function openArchivedActions() {
        startLoad();
        google.script.run.withSuccessHandler(data => {
            stopLoad();
            if(!data || data.length === 0) {
                toast("Aucune action archiv\u00e9e");
                return;
            }
            renderArchivedIspList(data);
            document.getElementById("modalList").style.display = "flex";
        }).withFailureHandler(e => {
            stopLoad();
            toast("Erreur: " + e.message);
        }).getArchivedActions();
    }
    
    let archivedData = [];
    
    function renderArchivedIspList(data) {
        archivedData = data;
        document.getElementById("modalListTitle").textContent = "Actions men\u00e9es \u2014 Par agent";
        const c = document.getElementById("modalListContent");
        // Masquer les filtres checkbox
        document.getElementById("filterBox").style.display = "none";
        c.innerHTML = data.map((isp, idx) => `
            <div class="detail-row" onclick="showArchivedFichesForIsp(${idx})" style="padding:15px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-weight:bold; color:#fff; font-size:14px;">${isp.ispName}</div>
                </div>
                <div style="background:var(--accent3); color:#000; padding:4px 12px; border-radius:8px; font-weight:bold; font-size:13px;">${isp.count} fiche${isp.count>1?'s':''}</div>
            </div>
        `).join('');
    }
    
    function showArchivedFichesForIsp(idx) {
        const isp = archivedData[idx];
        if(!isp) return;
        document.getElementById("modalListTitle").textContent = `Actions men\u00e9es \u2014 ${isp.ispName}`;
        const c = document.getElementById("modalListContent");
        c.innerHTML = `<div style="padding:10px; border-bottom:1px solid var(--border);">
            <button class="btnGo" style="width:auto;background:#444;border-color:#666;" onclick="renderArchivedIspList(archivedData)">\u2190 Retour liste agents</button>
        </div>` + isp.fiches.map((f, fi) => `
            <div class="detail-row" onclick="showArchivedDetail(${idx}, ${fi})" style="padding:12px; cursor:pointer;">
                <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                    <span style="font-weight:bold; color:#39ff14; font-size:13px;">${f.id}</span>
                    <span style="font-size:11px; color:var(--muted);">${f.date || '-'}</span>
                </div>
                <div style="font-size:12px; color:#ccc; margin-bottom:4px;"><b>Motif:</b> ${f.motif || '-'}</div>
                <div style="font-size:10px; color:var(--muted);">${f.status} | Engin: ${f.engin || '-'}</div>
                ${f.actionFaite ? `<div style="font-size:10px; color:var(--ok); margin-top:4px; background:#1a1a1a; padding:4px; border-radius:3px;">\u2705 ${f.actionFaite}</div>` : ''}
            </div>
        `).join('');
    }
    
    function showArchivedDetail(ispIdx, ficheIdx) {
        const f = archivedData[ispIdx].fiches[ficheIdx];
        const fileId = extractDriveFileId(f.pdf || '');
        const pdfSrc = fileId ? "https://drive.google.com/file/d/" + fileId + "/preview" : "";
        
        document.getElementById("modalDetailBody").innerHTML = `
            ${pdfSrc ? `<iframe src="${pdfSrc}" style="flex:2.5; border:0; background:#000; position:static;"></iframe>` : '<div style="flex:2.5;background:#000;display:flex;align-items:center;justify-content:center;color:gray;">PDF indisponible</div>'}
            <div style="flex:1; min-width:350px; background:#1a2245; padding:20px; border-left:1px solid var(--border); overflow-y:auto; display:flex; flex-direction:column; gap:15px;">
                <h4 style="color:var(--accent3);margin:0 0 15px 0;">Informations</h4>
                <div style="display:flex;flex-direction:column;gap:12px;font-size:13px;">
                    <div><span style="color:var(--muted);font-size:11px;">N\u00b0 Intervention</span><br><b style="font-size:15px;color:#fff;">${f.id}</b></div>
                    <div><span style="color:var(--muted);font-size:11px;">Date</span><br><b>${f.date || '-'}</b></div>
                    <div><span style="color:var(--muted);font-size:11px;">Astreinte / Garde</span><br><b>${f.status || '-'}</b></div>
                    <div><span style="color:var(--muted);font-size:11px;">Motif</span><br><b>${f.motif || '-'}</b></div>
                    <div><span style="color:var(--muted);font-size:11px;">Engin</span><br><b>${f.engin || '-'}</b></div>
                </div>
                ${f.commChef ? `<h4 style="color:var(--accent3);margin:15px 0 5px 0;">\uD83D\uDCAC Commentaire Chefferie</h4><div class="static-box">${f.commChef}</div>` : ''}
                ${f.analyseMed ? `<h4 style="color:var(--red);margin:15px 0 5px 0;">\uD83E\uDE7A Analyse M\u00e9decin</h4><div class="static-box" style="color:var(--red);">${f.analyseMed}</div>` : ''}
                ${f.actionRequise ? `<h4 style="color:var(--orange);margin:15px 0 5px 0;">\u26a0\ufe0f Action Requise</h4><div class="static-box" style="color:var(--orange);">${f.actionRequise}</div>` : ''}
                ${f.actionFaite ? `<h4 style="color:var(--ok);margin:15px 0 5px 0;">\u2705 Action Men\u00e9e</h4><div class="static-box" style="color:var(--ok);">${f.actionFaite}</div>` : ''}
                <button class="btnGo" style="width:100%;margin-top:auto;" onclick="closeModalDetail(); document.getElementById('modalList').style.display='flex';">\u2190 Retour</button>
            </div>
        `;
        document.getElementById("modalDetail").style.display = "flex";
    }

    // CHEFFERIE (ANCIENNE - \u00e0 garder pour compatibilit\u00e9)
    let currentSchema = null;
    function hideGlobal() { document.getElementById("globalListArea").style.display="none"; document.getElementById("chefFormArea").style.display="block"; }
    function loadChefCase(mode) {
        const area = (mode==='med_chef') ? 'medFormArea' : 'chefFormArea';
        document.getElementById(area).innerHTML = "<div style='text-align:center;padding:50px;color:gray'>Chargement...</div>";
        google.script.run.withSuccessHandler(res => {
            if(res.done) { document.getElementById(area).innerHTML = `<div style='text-align:center;padding:50px;color:var(--accent3)'>${res.message}</div>`; return; }
            currentSchema = res;
            renderChefForm(res, area);
        }).getChefferieNextCase(mode);
    }
    
    function renderChefForm(s, areaId) {
        const i = s.info;
        const html = `
        <div style="height:100%;">
            <div class="info-banner">
                <div class="info-banner-row"><span>N\u00b0 Inter: <b>${i.interId}</b></span> <span>ISP: <b>${i.infName}</b></span></div>
                <div class="info-banner-row"><span>Motif: <b>${i.motif || '\u2014'}</b></span> <span>${i.date}</span></div>
            </div>
            <div class="chef-layout">
                <div class="chef-pdf"><iframe src="${(i.pdf||'').replace('/view','/preview')}" style="width:100%;height:100%;border:0"></iframe></div>
                <div class="chef-form">
                    ${s.mode==='app_isp' ? `
                       <div><label>Commentaire ISP</label><div class="static-box">${i.commBN||"-"}</div></div>
                       <div><label>Checklist Qualit\u00e9</label><div class="check-list">
                          ${s.checks.map((c,k) => {
                              let cls = ""; if(c.label.includes("OK")) cls="chk-green"; if(c.label.includes("KO")) cls="chk-red";
                              const checked = c.checked ? " checked" : "";
                              return `<div class="check-item ${cls}"><input type="checkbox" id="chk_${k}" name="check_${c.id}"${checked}> ${c.label}</div>`;
                          }).join('')}
                       </div></div>
                       <div><label>Commentaire Chefferie</label><textarea id="chefComm">${s.existingComment||""}</textarea></div>
                       <button class="btnGo" onclick="sendChef()">Valider</button>
                    ` : s.mode==='med_chef' ? `
                       <div><label>Analyse</label><div class="static-box">${i.motif||"-"}</div></div>
                       <div><label>Analyse M\u00e9decin</label><textarea id="medAnalyse"></textarea></div>
                       <div><label>Actions</label><textarea id="medAction"></textarea></div>
                       <button class="btnGo" onclick="sendChef()">Valider</button>
                    ` : `<div>Formulaire non d\u00e9fini</div>`}
                </div>
            </div>
        </div>`;
        document.getElementById(areaId).innerHTML = html;
    }
    
    function sendChef() {
        if(!currentSchema) return;
        const s = currentSchema;
        const payload = { mode:s.mode, info:s.info };
        if(s.mode==='app_isp') {
            payload.comment = document.getElementById("chefComm").value;
            if(!payload.comment) { toast("Commentaire requis"); return; }
            payload.checks = {};
            s.checks.forEach((c,k) => {
                const chk = document.getElementById("chk_"+k);
                if(chk) payload.checks[c.id] = chk.checked;
            });
        } else if(s.mode==='med_chef') {
            payload.analyse = document.getElementById("medAnalyse").value;
            payload.action = document.getElementById("medAction").value;
        }
        const areaId = (s.mode==='med_chef') ? 'medFormArea' : 'chefFormArea';
        document.getElementById(areaId).innerHTML = "<div style='text-align:center;padding:50px'>Enregistrement...</div>";
        google.script.run.withSuccessHandler(() => { toast("Enregistr\u00e9"); loadChefCase(s.mode); }).saveChefferie(payload);
    }

    // LIST & SORT
    let globalList = [], currentDetailList = [], currentDetailIspName = "";
    let sortDir = 1;
    function loadGlobalList() {
        const tbody = document.getElementById("globalTbody");
        if(!tbody) return;
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;color:gray;">Chargement...</td></tr>';
        
        google.script.run.withSuccessHandler(res => {
            globalList = res;
            renderGlobalTable(res);
        }).getAllIspErrorStats();
    }
    
    function renderGlobalTable(data) {
        document.getElementById("globalTbody").innerHTML = data.map(r => `
          <tr onclick="loadIspDetail('${r.mat}', '${r.nom}')"><td><b>${r.nom}</b></td><td class="text-green">${r.bilanOk}</td><td class="text-green">${r.pisuOk}</td><td class="text-orange">${r.errBilL}</td><td class="text-orange">${r.errPisuL}</td><td class="text-red">${r.errGrave}</td></tr>
        `).join('');
    }
    
    function sortGlobal(idx) {
        sortDir *= -1;
        const keys = ['nom', 'bilanOk', 'pisuOk', 'errBilL', 'errPisuL', 'errGrave'];
        const k = keys[idx];
        globalList.sort((a,b) => { if(a[k]>b[k]) return sortDir; if(a[k]<b[k]) return -sortDir; return 0; });
        for(let i=0; i<6; i++) document.getElementById("sortIcon"+i).textContent="\u2195";
        document.getElementById("sortIcon"+idx).textContent = sortDir===1 ? "\u25bc" : "\u25b2";
        renderGlobalTable(globalList);
    }
    
    function loadIspDetail(mat, ispName) {
        currentDetailIspName = ispName || mat;
        startLoad();
        google.script.run.withSuccessHandler(list => {
            stopLoad();
            currentDetailList = list;
            document.getElementById("filterBox").style.display = "flex";
            document.querySelectorAll('#filterBox input[type="checkbox"]').forEach(cb => cb.checked = true);
            document.getElementById("modalListTitle").textContent = `Dossiers de ${ispName || mat}`;
            filterDetails();
            document.getElementById("modalList").style.display="flex";
        }).getIspDetailsAdmin(mat);
    }

    function loadAllGraveErrors() {
        startLoad();
        let allGraveList = [];
        let loaded = 0;
        let totalIsps = globalList.length;

        if(totalIsps === 0) { toast("Aucune donn\u00e9e"); stopLoad(); return; }

        globalList.forEach(isp => {
            google.script.run.withSuccessHandler(list => {
                loaded++;
                const graveErrors = list.filter(x => x.errorType === "Erreur Grave");
                graveErrors.forEach(e => {
                    e.ispName = isp.nom;
                });
                allGraveList = allGraveList.concat(graveErrors);

                if(loaded === totalIsps) {
                    stopLoad();
                    currentDetailList = allGraveList;
                    document.getElementById("filterBox").style.display = "flex";
                    document.querySelectorAll('#filterBox input[type="checkbox"]').forEach(cb => {
                        cb.checked = cb.value === "Erreur Grave";
                    });
                    document.getElementById("modalListTitle").textContent = "Toutes les fiches en erreur grave";
                    filterDetails();
                    document.getElementById("modalList").style.display="flex";
                }
            }).getIspDetailsAdmin(isp.mat);
        });
    }
    
    function loadAllLegereErrors() {
        startLoad();
        let allLegereList = [];
        let loaded = 0;
        let totalIsps = globalList.length;

        if(totalIsps === 0) { toast("Chargez d'abord les donn\u00e9es (Voir Donn\u00e9es APP)"); stopLoad(); return; }

        globalList.forEach(isp => {
            google.script.run.withSuccessHandler(list => {
                loaded++;
                const legereErrors = list.filter(x => x.errorType === "Erreur Bilan L\u00e9g\u00e8re" || x.errorType === "Erreur Pisu L\u00e9g\u00e8re" || (x.types && (x.types.includes("Erreur Bilan L\u00e9g\u00e8re") || x.types.includes("Erreur Pisu L\u00e9g\u00e8re"))));
                legereErrors.forEach(e => { e.ispName = isp.nom; });
                allLegereList = allLegereList.concat(legereErrors);

                if(loaded === totalIsps) {
                    stopLoad();
                    currentDetailList = allLegereList;
                    document.getElementById("filterBox").style.display = "flex";
                    document.querySelectorAll('#filterBox input[type="checkbox"]').forEach(cb => {
                        cb.checked = cb.value === "Erreur Bilan L\u00e9g\u00e8re" || cb.value === "Erreur Pisu L\u00e9g\u00e8re";
                    });
                    document.getElementById("modalListTitle").textContent = "Toutes les fiches en erreur l\u00e9g\u00e8re";
                    filterDetails();
                    document.getElementById("modalList").style.display="flex";
                }
            }).getIspDetailsAdmin(isp.mat);
        });
    }

    function skipToNextAppChef() {
        loadAppChefferie();
    }

    function filterDetails() {
        const filters = Array.from(document.querySelectorAll('input[type=checkbox]:checked')).map(c=>c.value);
        const c = document.getElementById("modalListContent"); 
        c.innerHTML="";
        const filtered = currentDetailList.filter(x => x.types.some(t => filters.includes(t)));
        if(filtered.length===0) c.innerHTML="<div style='padding:20px;text-align:center;color:gray'>Aucun dossier</div>";
        filtered.forEach(x => {
            // Cr\u00e9er les tags pour chaque type (peut \u00eatre "Bilan OK", "Pisu OK", "Erreur Grave", etc.)
            const tagHtml = x.types.map(t => {
                let tagBg = "#47d18c", tagColor = "white";
                if(t.includes("Grave")) {
                    tagBg = "#d32f2f";
                    tagColor = "white";
                } else if(t.includes("L\u00e9g\u00e8re")) {
                    tagBg = "#ff9800";
                    tagColor = "white";
                }
                return `<span style="display:inline-block;padding:3px 8px;border-radius:3px;font-size:10px;font-weight:bold;background:${tagBg};color:${tagColor};margin-left:4px;">${t}</span>`;
            }).join('');
            const ispLabel = x.ispName ? `<div style="font-size:10px;color:var(--accent3);margin-top:4px;">ISP: <b>${x.ispName}</b></div>` : '';
            
            const div = document.createElement('div');
            div.className = 'detail-row';
            div.style.cssText = 'padding:12px;border-bottom:1px solid #333;cursor:pointer;';
            div.addEventListener('click', (e) => { 
                e.preventDefault(); 
                e.stopPropagation(); 
                e.stopImmediatePropagation();
                console.log("Click intercept\u00e9, ouverture popup pour:", x.id);
                loadInterDetail(e, x.id, x.date, x.motif, x.status, x.centre, x.engin);
                return false;
            });
            div.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
                        <div style="flex:1;">
                            <div style="font-weight:bold;color:#39ff14;font-size:13px;">Num\u00e9ro d'intervention: ${x.id}</div>
                            <div style="font-size:10px;color:#aaa;margin-top:3px;">Date: <b>${x.date || '-'}</b></div>
                        </div>
                        <div style="margin-left:10px;">${tagHtml}</div>
                    </div>
                    <div style="font-size:12px;color:#ccc;margin-bottom:6px;"><b>Motif: ${x.motif || '-'}</b></div>
                    <div style="font-size:10px;color:#aaa;margin-bottom:3px;">Type: <b>${x.status || '-'}</b></div>
                    <div style="font-size:10px;color:#aaa;">Engin: <b>${x.engin || '-'}</b></div>
                    ${ispLabel}
                    ${(x.errorType && x.commChef) ? `<div style="font-size:10px;color:var(--accent3);margin-top:4px;background:#1a1a1a;padding:4px;border-radius:3px;">\uD83D\uDCAC Chef: ${x.commChef}</div>` : ''}
                    ${x.commMed ? `<div style="font-size:10px;color:var(--red);margin-top:4px;background:#1a1a1a;padding:4px;border-radius:3px;">\uD83E\uDE7A Med: ${x.commMed}</div>` : ''}
            `;
            c.appendChild(div);
        });
    }
    
    function loadInterDetail(evt, id, date, motif, status, centre, engin) {
        if(evt) { evt.preventDefault(); evt.stopPropagation(); evt.stopImmediatePropagation(); }
        
        const item = currentDetailList.find(x => x.id === id);
        if(!item) return false;
        
        const fileId = extractDriveFileId(item.pdf || '');
        if(!fileId) { toast("PDF indisponible"); return false; }
        
        // Extraire date/heure
        let dateOnly = date || "-", heureOnly = "\u2014";
        if(date && date.includes(' ')) { const p = date.split(' '); dateOnly = p[0]; heureOnly = p[1] || "\u2014"; }
        
        const pdfSrc = "https://drive.google.com/file/d/" + fileId + "/preview";
        const commChefHtml = item.commChef ? item.commChef : "Aucun commentaire.";
        const commMedHtml = item.commMed ? `<h4 style="color:var(--red);margin:15px 0 10px 0;">Analyse M\u00e9decin</h4><div class="static-box" style="color:var(--red);">${item.commMed}</div>` : '';
        
        // Injecter tout le HTML dynamiquement (m\u00eame m\u00e9thode que renderChefForm qui marche)
        document.getElementById("modalDetailBody").innerHTML = `
            <iframe src="${pdfSrc}" style="flex:2.5; border:0; background:#000; position:static;"></iframe>
            <div style="flex:1; min-width:350px; background:#1a2245; padding:20px; border-left:1px solid var(--border); overflow-y:auto; display:flex; flex-direction:column; gap:15px;">
                <h4 style="color:var(--accent3);margin:0 0 15px 0;">Informations</h4>
                <div style="display:flex;flex-direction:column;gap:12px;font-size:13px;">
                    <div><span style="color:var(--muted);font-size:11px;">N\u00b0 Intervention</span><br><b style="font-size:15px;color:#fff;">${id}</b></div>
                    <div><span style="color:var(--muted);font-size:11px;">Date</span><br><b>${dateOnly}</b></div>
                    <div><span style="color:var(--muted);font-size:11px;">Heure</span><br><b>${heureOnly}</b></div>
                    <div><span style="color:var(--muted);font-size:11px;">V\u00e9hicule / Engin</span><br><b>${engin || '-'}</b></div>
                    <div><span style="color:var(--muted);font-size:11px;">Type d'intervention</span><br><b>${status || '-'}</b></div>
                    <div><span style="color:var(--muted);font-size:11px;">Motif d'intervention</span><br><b>${motif || '-'}</b></div>
                </div>
                <h4 style="color:var(--accent3);margin:15px 0 10px 0;">Commentaire Chefferie</h4>
                <div class="static-box">${commChefHtml}</div>
                ${commMedHtml}
                <button class="btnGo" style="width:100%;margin-bottom:8px;" onclick="closeModalDetail(); document.getElementById('modalList').style.display='flex';">\u2190 Retour aux fiches</button>
                <button class="btnGo" style="width:100%;" onclick="closeModalDetail()">Fermer</button>
            </div>
        `;
        
        document.getElementById("modalDetail").style.display = "flex";
        return false;
    }
    
    function closeModalDetail() {
        document.getElementById("modalDetailBody").innerHTML = "";
        document.getElementById("modalDetail").style.display = "none";
    }
    
    function closeModal(id){ document.getElementById(id).style.display="none"; }
  </script>
</body>
</html>
