<!doctype html>
<!-- Version: v1.22 | 2026-01-29 -->
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script>const SCRIPT_URL = "<?= scriptUrl ?>";</script>
  <style>
    :root{ --bg0:#0b0f1f; --bg1:#0f1430; --text:#eaf0ff; --muted:#a9b5db; --border:rgba(255,255,255,.08); --accent3:#4fc3f7; --ok:#47d18c; --radius:18px; --red:#ff4d4d; --orange:#ffa500; --accent:#6ea8fe; --danger:#ff6b6b; --selectBg:#0e1730; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: ui-sans-serif, system-ui, sans-serif; color:var(--text); background:linear-gradient(180deg, var(--bg0), var(--bg1)); min-height:100vh; font-size:13px; }
    
    .neo-loader-box { position:fixed; top:20px; left:50%; transform:translateX(-50%); width:400px; padding:10px; background:rgba(0,0,0,0.9); border:1px solid var(--accent3); border-radius:4px; z-index:100000; box-shadow:0 0 15px rgba(57,255,20,0.3); display:none; flex-direction:column; gap:5px; }
    .neo-text { color:var(--accent3); font-family:monospace; font-weight:bold; font-size:12px; text-transform:uppercase; display:flex; justify-content:space-between; }
    .neo-track { width:100%; height:10px; background:#111; border:1px solid #333; border-radius:2px; overflow:hidden; }
    .neo-fill { height:100%; background: repeating-linear-gradient(45deg, var(--accent3), var(--accent3) 10px, #2ebf11 10px, #2ebf11 20px); width:0%; transition:width 0.2s linear; box-shadow:0 0 10px var(--accent3); }

    .app{ display:grid; grid-template-columns: 260px 1fr; min-height:100vh; }
    .sidebar{ position:sticky; top:0; height:100vh; padding:20px 15px; border-right:1px solid var(--border); background:rgba(18,26,59,.65); backdrop-filter:blur(10px); display:flex; flex-direction:column; overflow-y:auto; }
    .sideTop{ display:flex; gap:12px; align-items:center; margin-bottom:30px; }
    .sideLogo{ width:50px; height:50px; border-radius:12px; overflow:hidden; border:1px solid var(--border); }
    .sideLogo img{ width:100%; height:100%; object-fit:cover; }
    .sideTitle{ line-height:1.2; } .sideTitle b{ color:#fff; font-size:14px; }
    .sideBtns{ display:flex; flex-direction:column; gap:10px; }
    .sideBtn{ width:100%; text-align:left; background:rgba(255,255,255,.03); border:1px solid var(--border); color:var(--text); padding:12px; border-radius:12px; cursor:pointer; font-weight:600; display:flex; justify-content:space-between; align-items:center; transition:0.2s; }
    .sideBtn:hover{ background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.3); }
    .sideBtn.primary{ background:rgba(57,255,20,0.05); border-color:rgba(57,255,20,0.3); color:#fff; }
    .badgeBtn { background:var(--ok); color:#000; padding:2px 6px; border-radius:6px; font-size:11px; font-weight:bold; }
    .badgeBtn.red { background:var(--red); color:#fff; }

    .main{ padding:25px; overflow-y:auto; height:100vh; }
    .view { display:none; animation:fadeIn 0.3s; }
    .view.active { display:block; }
    #viewChefferie.active { display:flex !important; flex-direction:column; height:100vh; overflow:hidden; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(5px);} to{opacity:1;transform:translateY(0);} }

    .topbar{ border-bottom:1px solid var(--border); padding-bottom:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; }
    .topbar h1 { margin:2px 0; font-size:18px; }
    .topbar p { margin:2px 0; font-size:12px; }
    .periodHero{ background:rgba(255,255,255,0.02); border:1px solid var(--border); padding:15px; border-radius:12px; text-align:center; margin-bottom:20px; }
    .kpiGrid{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-bottom:20px; }
    .panel{ background:rgba(18,26,59,.8); border:1px solid var(--border); border-radius:16px; overflow:hidden; margin-bottom:20px; }
    .panelHead{ background:rgba(0,0,0,0.2); padding:12px 15px; font-weight:bold; border-bottom:1px solid var(--border); font-size:13px; display:flex; justify-content:space-between; position:sticky; top:0; z-index:5; }
    .panelBody{ padding:15px; }
    .badge{ background:rgba(255,255,255,0.1); padding:3px 8px; border-radius:6px; font-size:12px; border:1px solid rgba(255,255,255,0.1); margin-left:15px; }
    
    table{ width:100%; border-collapse:collapse; font-size:11px; }
    thead{ position:sticky; top:0; z-index:10; background:#131b3a; }
    th{ text-align:left; color:var(--muted); padding:6px; border-bottom:1px solid var(--border); font-size:10px; text-transform:uppercase; cursor:pointer; user-select:none; background:#131b3a; }
    td{ padding:4px 6px; border-bottom:1px solid rgba(255,255,255,0.03); }
    tr:hover td{ background:rgba(255,255,255,0.03); cursor:pointer; }
    .num{ text-align:right; font-family:monospace; }
    
    .btnGo{ background:var(--accent3); color:#000; font-weight:bold; border:1px solid rgba(79,195,247,0.5); padding:8px 16px; border-radius:8px; cursor:pointer; transition:0.2s; box-shadow:0 0 12px rgba(79,195,247,0.3); }
    .btnGo:hover{ background:#5dd5ff; box-shadow:0 0 18px rgba(79,195,247,0.5); }
    .inp{ background:rgba(0,0,0,0.3); border:1px solid var(--border); color:#fff; padding:8px; border-radius:8px; outline:none; }
    .inp:focus{ border-color:var(--accent3); }
    
    .mini-load-box { display:none; width:150px; padding:5px; background:rgba(0,0,0,0.9); border:1px solid var(--accent3); border-radius:4px; margin-left:15px; }
    .mini-load-track { width:100%; height:6px; background:#111; border-radius:2px; overflow:hidden; }
    .mini-load-fill { width:0%; height:100%; background:var(--accent3); transition:width 0.2s; }
    .mini-load-text { font-size:10px; color:var(--accent3); text-align:center; font-family:monospace; margin-bottom:2px; }

    .adminSplit { display:flex; gap:20px; align-items:flex-start; }
    .adminLeft { flex:0 0 60%; }
    .adminRight { flex:1; }
    .admin-scroll { max-height:400px; overflow:auto; border:1px solid var(--border); border-radius:10px; }

    .btn-row { display:flex; gap:15px; margin-bottom:20px; position:sticky; top:35px; z-index:10; background:rgba(11,15,31,0.95); padding:15px 0; border-bottom:1px solid var(--border); }
    .c-btn { flex:1; padding:15px; background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:12px; color:#fff; cursor:pointer; text-align:left; transition:0.2s; }
    .c-btn:hover { background:rgba(255,255,255,.08); border-color:var(--accent3); }
    .c-btn h3 { margin:0 0 5px 0; font-size:14px; display:flex; justify-content:space-between; }
    .c-btn p { margin:0; font-size:11px; color:var(--muted); }

    .chef-layout { display:flex; gap:20px; height:85vh; }
    .chef-pdf { flex:2; background:#000; border-radius:12px; border:1px solid var(--border); overflow:hidden; }
    .chef-form { flex:1; background:rgba(0,0,0,0.2); padding:20px; border-radius:12px; border:1px solid var(--border); overflow-y:auto; display:flex; flex-direction:column; gap:15px; }

    .info-banner { background:rgba(57,255,20,0.05); border:1px solid var(--accent3); padding:10px; border-radius:8px; margin-bottom:10px; display:flex; flex-direction:column; gap:8px; font-weight:bold; font-size:12px; }
    .info-banner-row { display:flex; justify-content:space-between; flex-wrap:wrap; }
    
    .check-list { display:flex; flex-direction:column; gap:8px; background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; }
    .check-item { display:flex; align-items:center; gap:8px; }
    .chk-green { color:var(--ok); font-weight:bold; }
    .chk-orange { color:var(--orange); font-weight:bold; }
    .chk-red { color:var(--red); font-weight:bold; }

    textarea { width:100%; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:#fff; padding:10px; border-radius:6px; resize:vertical; min-height:60px; }
    .static-box { background:rgba(0,0,0,0.4); padding:10px; border-radius:6px; color:#ddd; font-size:12px; border:1px solid var(--border); }

    .modalOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(3px); }
    .modalCard { width:90%; max-width:1600px; height:98vh; background:#121a3b; border:1px solid var(--border); border-radius:20px; display:flex; flex-direction:column; overflow:hidden; }
    .modalHead { padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; font-weight:bold; font-size:16px; }
    .closeBtn { background:none; border:none; color:#fff; font-size:24px; cursor:pointer; }
    
    .modalBody { display:flex; flex:1; overflow:hidden; }
    
    #modalPdf { flex:1; border:0; background:#000; }
    #modalPdfInfo { flex:0 0 300px; background:#1a2245; padding:20px; border-left:1px solid var(--border); overflow-y:auto; display:flex; flex-direction:column; gap:15px; }
    
    .detail-row { padding:12px; border-bottom:1px solid rgba(255,255,255,0.05); cursor:pointer; }
    .detail-row:hover { background:rgba(255,255,255,0.05); }
    .tag { padding:2px 6px; border-radius:4px; font-size:10px; margin-right:5px; border:1px solid transparent; }
    .tag.ok { color:var(--ok); border-color:var(--ok); }
    .tag.warn { color:var(--orange); border-color:var(--orange); }
    .tag.err { color:var(--red); border-color:var(--red); }
    
    .toast { position:fixed; bottom:20px; right:20px; background:#111; border:1px solid var(--border); padding:15px; border-radius:10px; z-index:99999; display:none; }
    .trendUp{ color:#39ff14; } .trendDown{ color:#ff4d4d; } .trendEq{ color:gray; }
    .text-green { color:var(--ok); font-weight:bold; } .text-orange { color:var(--orange); font-weight:bold; } .text-red { color:var(--red); font-weight:bold; }
    
    .table-title { background:rgba(0,0,0,0.2); padding:12px 15px; font-weight:bold; border-bottom:1px solid var(--border); font-size:13px; }

    .panelScrollWrapper { max-height:300px; overflow:auto; position:relative; }

    /* === STYLES APP === */
    header{ padding:8px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px; background: rgba(16,26,51,.8); backdrop-filter: blur(10px); border-bottom:1px solid var(--border); height: 50px; flex-shrink:0; }
    .brand{ display:flex; align-items:center; gap:10px; }
    .logo{ width:28px;height:28px;border-radius:8px; background: linear-gradient(135deg, rgba(110,168,254,.9), rgba(71,209,140,.85)); box-shadow: 0 18px 50px rgba(0,0,0,.35); cursor:pointer; }
    h1{ font-size:16px; margin:0; font-weight:700; } 
    .rightHead{ display:flex; align-items:center; gap:8px; }
    .pill{ font-size:11px; padding:4px 10px; border-radius: 999px; border:1px solid var(--border); color:var(--muted); background: rgba(255,255,255,.03); white-space:nowrap; }
    .btnTop{ border:1px solid var(--border); background: rgba(255,255,255,.03); color: var(--text); padding:6px 10px; border-radius: 999px; cursor:pointer; font-weight:600; font-size:11px; transition: background .2s; }
    .btnTop:hover{ background: rgba(255,255,255,.08); }

    .wrap{ padding:10px; max-width: 100%; margin:0 auto; height: calc(100vh - 50px); display:flex; gap:10px; }
    .leftCol { flex: 2.5; display:flex; flex-direction:column; gap:10px; height:100%; min-width:0; }
    .rightCol { flex: 2.2; display:flex; flex-direction:column; height:100%; min-width:500px; }

    .card{ background: linear-gradient(180deg, rgba(16,26,51,.95), rgba(15,24,48,.95)); border:1px solid var(--border); border-radius: var(--radius); box-shadow: 0 18px 50px rgba(0,0,0,.35); overflow:hidden; display:flex; flex-direction:column; flex:1; }
    .cardHead{ padding:8px 12px; border-bottom:1px solid var(--border); background: rgba(255,255,255,.02); flex-shrink:0; }
    
    .interInfos { display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; font-size: 11px; }
    .interItem { display:flex; flex-direction:column; }
    .interLabel { color: var(--muted); font-size:9px; text-transform:uppercase; letter-spacing:0.5px; }
    .interVal { font-weight:600; color:#fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size:11px; }
    .interVal.highlight { color: var(--accent); }

    .pdfBox{ flex:1; background: rgba(0,0,0,.2); position:relative; overflow:hidden; }
    iframe{ width:100%; height:100%; border:0; position:absolute; top:0; left:0; }

    .form{ padding:10px; display:flex; flex-direction:column; gap:8px; overflow-y:auto; flex:1; }
    .form::-webkit-scrollbar { width: 5px; }
    .form::-webkit-scrollbar-track { background: transparent; }
    .form::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    
    label{ font-size:10px; color:var(--muted); display:block; margin-bottom:2px; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .group{ padding:8px; border-radius: 10px; border:1px solid var(--border); background: rgba(255,255,255,.02); }
    .groupTitle { font-size:11px; font-weight:800; color:var(--accent); margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px; border-bottom:1px solid rgba(255,255,255,.05); padding-bottom:2px; }

    select, input[type="text"], textarea { padding:4px 6px; border-radius: 6px; border:1px solid var(--border); background: var(--selectBg); color: var(--text); outline:none; width:100%; font-family:inherit; font-size:11px; transition: border-color .2s; }
    select:focus, input:focus, textarea:focus { border-color: var(--accent); }
    textarea { resize: vertical; min-height: 30px; }

    .cb{ display:flex; align-items:flex-start; gap:4px; padding:3px 5px; border-radius: 4px; border:1px solid rgba(255,255,255,.05); background: rgba(255,255,255,.01); cursor:pointer; user-select:none; font-size:10px; transition: background .2s; line-height:1.1; }
    .cb:hover { background: rgba(255,255,255,.05); }
    .cb.red { border-color: rgba(255,107,107,.3); color: var(--danger); }
    
    input[type="checkbox"]{ width:12px;height:12px; accent-color: var(--accent); cursor:pointer; flex-shrink:0; margin-top:1px; }
    input[type="checkbox"].danger-cb { accent-color: var(--danger); }

    .actions{ margin-top:auto; padding-top:6px; display:flex; gap:8px; flex-shrink:0; }
    .btn{ border:1px solid var(--border); background: rgba(255,255,255,.03); color: var(--text); padding:8px; border-radius: 8px; cursor:pointer; font-weight:700; flex:1; font-size:12px; }
    .btn.ok{ border-color: rgba(71,209,140,.45); background: linear-gradient(135deg, rgba(71,209,140,.25), rgba(71,209,140,.10)); color: #8affc1; }
    .btn.warn{ border-color: rgba(255,107,107,.35); background: linear-gradient(135deg, rgba(255,107,107,.16), rgba(255,107,107,.06)); }

    .grid-checks { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 4px; }
    .grid-selects { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .row2Items { display: grid; grid-template-columns: 2fr 1fr; gap:6px; margin-top:6px; }

    .appContainer { display:none; }
    .appContainer.active { display:flex; flex-direction:column; height:100%; }
    
    /* Flèche scroll clignotante */
    .scroll-arrow { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); width:40px; height:40px; background:linear-gradient(135deg, rgba(110,168,254,.2), rgba(71,209,140,.2)); border:2px solid var(--accent3); border-radius:50%; display:none; align-items:center; justify-content:center; font-size:20px; color:var(--accent3); cursor:pointer; animation:pulse 2s infinite; box-shadow:0 0 20px rgba(79,195,247,0.4); z-index:5000; }
    @keyframes pulse { 0%, 100% { opacity:1; transform:translateX(-50%) scale(1); } 50% { opacity:0.7; transform:translateX(-50%) scale(1.1); } }
    .scroll-arrow:hover { background:linear-gradient(135deg, rgba(110,168,254,.4), rgba(71,209,140,.4)); }
  </style>
</head>
<body>
  <div id="loadingBox" class="neo-loader-box">
    <div class="neo-text"><span>Chargement...</span><span id="loadPct">0%</span></div>
    <div class="neo-track"><div id="loadFill" class="neo-fill"></div></div>
  </div>

  <div id="loadingBox25" class="neo-loader-box">
    <div class="neo-text"><span>Chargement 2025...</span><span id="loadPct25">0%</span></div>
    <div class="neo-track"><div id="loadFill25" class="neo-fill"></div></div>
  </div>

  <!-- Flèche de scroll -->
  <div class="scroll-arrow" id="scrollArrow" onclick="document.querySelector('.main').scrollTo({top: document.querySelector('.main').scrollHeight, behavior: 'smooth'});">↓</div>

  <!-- VUE DASHBOARD -->
  <div class="app" id="viewContainer">
    <aside class="sidebar">
      <div class="sideTop">
        <div class="sideLogo"><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTytvs_50DuR6nodg_2fA5DzNfpdDSR1s_YaQ&s"></div>
        <div class="sideTitle">
            <b>Sdis 66 - SDS</b>
            <span style="display:block;margin-top:2px;">Outil de données<br>opérationnelles</span>
            <div id="cacheTime" style="font-size:10px;color:gray;margin-top:5px;"></div>
        </div>
      </div>
      <div class="sideBtns">
        <button class="sideBtn primary" id="btnAppAccess" onclick="openAppView()"><span>Accès APP</span><span class="badgeBtn" id="cntAppBadge">...</span></button>
        <button class="sideBtn" onclick="askPass('chef')"><span>Accès chefferie ISP</span><span style="display:flex;align-items:center;gap:4px;"><span class="badgeBtn" id="cntIspGBadge">...</span><span style="color:var(--muted);">/</span><span class="badgeBtn red" id="cntIspRBadge">...</span></span></button>
        <button class="sideBtn" onclick="askPass('med')"><span>Accès médecin cheffe</span><span class="badgeBtn" id="cntMedBadge">...</span></button>
      </div>
    </aside>

    <main class="main">
      
      <div id="viewDashboard" class="view active">
        <div class="topbar">
            <div><h1>Synthèse</h1><p style="color:var(--muted)">Activité opérationnelle 2026 — comparaison à date de la période 2025</p></div>
        </div>
        
        <div class="periodHero">Les données sont comparées du <b style="color:#fff;font-size:16px;">01/01/2026</b> au <b style="color:#fff;font-size:16px;"><span id="cutoffDateBig">...</span></b></div>

        <div class="kpiGrid">
           <div class="panel"><div class="panelBody">
              <div style="font-size:11px;color:var(--muted)">Interventions — Garde PSud</div><div style="font-size:32px;font-weight:900" id="psud2026">...</div>
              <div class="kpiBottom"><span style="color:var(--muted);font-size:11px">Total 2025:</span><span class="badge" id="psud2025Badge">...</span></div>
              <div style="font-size:9px;color:var(--muted);margin-top:4px;">Comparaison du 1er janvier au <span id="cutoffCompPsud">...</span></div>
           </div></div>
           <div class="panel"><div class="panelBody">
              <div style="font-size:11px;color:var(--muted)">Interventions — Secteur</div><div style="font-size:32px;font-weight:900" id="secteur2026">...</div>
              <div class="kpiBottom"><span style="color:var(--muted);font-size:11px">Total 2025:</span><span class="badge" id="sect2025Badge">...</span></div>
              <div style="font-size:9px;color:var(--muted);margin-top:4px;">Comparaison du 1er janvier au <span id="cutoffCompSect">...</span></div>
           </div></div>
           <div class="panel"><div class="panelBody">
              <div style="font-size:11px;color:var(--muted)">Total interventions SDS</div><div style="font-size:32px;font-weight:900" id="total2026">...</div>
              <div class="kpiBottom"><span style="color:var(--muted);font-size:11px">Total 2025:</span><span class="badge" id="total2025Badge">...</span></div>
              <div style="font-size:9px;color:var(--muted);margin-top:4px;">Comparaison du 1er janvier au <span id="cutoffCompTotal">...</span></div>
           </div></div>
        </div>

        <div class="panel" style="margin-bottom:20px;"><div class="panelBody" style="display:flex;align-items:center;gap:40px;">
            <div><div style="font-size:11px;color:var(--muted)">Astreintes / Dispo 2026</div><div style="font-size:24px;font-weight:bold" id="hrs2026">...</div><div style="font-size:9px;color:var(--muted);margin-top:4px;">Comparaison du 1er janvier au <span id="cutoffCompAst">...</span></div></div>
            <div><div style="font-size:11px;color:var(--muted)">Total 2025</div><div class="badge" id="hrs2025Badge">...</div></div>
        </div></div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
            <div class="panel"><div class="panelHead">Sorties par CIS</div><div class="panelScrollWrapper"><table id="tableCis"><thead><tr><th>CIS</th><th class="num">2026</th><th class="num">2025 (Date)</th><th class="num">2025 (Total)</th></tr></thead><tbody></tbody></table></div></div>
            <div class="panel"><div class="panelHead">Sorties par Secteur</div><div class="panelScrollWrapper"><table id="tableSect"><thead><tr><th>Secteur</th><th class="num">2026</th><th class="num">2025 (Date)</th><th class="num">2025 (Total)</th></tr></thead><tbody></tbody></table></div></div>
        </div>

        <div class="panel" style="margin-bottom:20px;">
            <div class="panelHead">Données par ISP</div>
            <div class="panelBody">
                <div id="ispLogin" style="display:flex;gap:10px;align-items:center;">
                    <input type="text" id="matInput" class="inp" placeholder="Matricule" style="width:120px;">
                    <input type="text" id="dobInput" class="inp" placeholder="JJ/MM/AAAA" style="width:140px;">
                    <button class="btnGo" style="width:auto;margin:0" onclick="loginIsp()">Voir mes données</button>
                    <div id="ispLoadBox" class="mini-load-box">
                       <div class="mini-load-text"><span id="ispPct">0</span>%</div>
                       <div class="mini-load-track"><div id="ispFill" class="mini-load-fill"></div></div>
                    </div>
                </div>
                <div id="ispData" style="display:none;margin-top:15px;">
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;">
                        <div>
                            <h4 style="color:var(--accent3);margin:0 0 5px 0">Temps (Agent: <span id="ispNameDisplay">—</span>)</h4>
                            <div style="font-size:12px;"><b>Astreinte 2026:</b> <span id="ispAst26"></span>h <span id="ispAstTrend"></span></div>
                            <div style="font-size:11px;color:var(--muted)">Comparatif 2025 à date: <span id="ispAst25Ytd"></span>h | Total 2025: <span id="ispAst25Tot"></span>h</div>
                            <hr style="border:0;border-top:1px solid #333;margin:5px 0">
                            <div style="font-size:12px;"><b>Garde 2026:</b> <span id="ispGarde26"></span>h <span id="ispGardeTrend"></span></div>
                            <div style="font-size:11px;color:var(--muted)">Comparatif 2025 à date: <span id="ispGarde25Ytd"></span>h | Total 2025: <span id="ispGarde25Tot"></span>h</div>
                        </div>
                        <div>
                            <h4 style="color:var(--accent3);margin:0 0 5px 0">Nbr Inters (Hors Garde)</h4>
                            <div style="font-size:12px;"><b>2026:</b> <span id="ispInter26"></span> <span id="ispInterTrend"></span></div>
                            <div style="font-size:11px;color:var(--muted)">Comparatif 2025 à date: <span id="ispInter25Ytd"></span> | Total 2025: <span id="ispInter25Tot"></span></div>
                        </div>
                        <div>
                            <h4 style="color:var(--accent3);margin:0 0 5px 0">Etude qualitative des BPV</h4>
                            <div style="font-size:12px;cursor:pointer;text-decoration:underline;" class="text-green" onclick="openErrorList('OK')">Bilan OK: <b id="ispOk"></b></div>
                            
                            <div style="margin-top:8px;cursor:pointer;text-decoration:underline;" class="text-orange" onclick="openErrorList('Bilan')">Erreur Bilan Légère: <span id="ispErrBil"></span></div>
                            <div style="cursor:pointer;text-decoration:underline;" class="text-orange" onclick="openErrorList('Pisu')">Erreur Pisu Légère: <span id="ispErrPisu"></span></div>
                            
                            <div style="margin-top:8px;cursor:pointer;text-decoration:underline;" class="text-red" onclick="openErrorList('Lourde')">Erreur Grave: <span id="ispErrLourd"></span></div>
                        </div>
                    </div>
                    <button class="btnGo" style="width:auto;margin-top:15px;background:#333;color:#fff" onclick="logoutIsp()">Déconnexion</button>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panelHead">Administration (à date)</div>
            <div class="panelBody">
                <div id="adminLogin" style="display:flex;gap:10px;align-items:center;">
                    <input type="password" id="adminPwd" class="inp" placeholder="Code...">
                    <button class="btnGo" style="width:auto;margin:0" onclick="loadAdmin()">Valider</button>
                    <div id="adminLoadBox" class="mini-load-box">
                       <div class="mini-load-text"><span id="adminPct">0</span>%</div>
                       <div class="mini-load-track"><div id="adminFill" class="mini-load-fill"></div></div>
                    </div>
                </div>
                <div id="adminData" style="display:none;margin-top:10px;">
                    <input type="text" id="adminSearch" class="inp" placeholder="Filtrer (séparer par ;)" style="width:100%;margin-bottom:10px;" onkeyup="filterAdmin()">
                    
                    <div class="adminSplit">
                        <div class="adminLeft">
                            <div class="table-title">Données par ISP</div>
                            <div class="admin-scroll">
                                <table id="adminTable">
                                    <thead><tr>
                                        <th onclick="sortAdmin(0)">Nom <span id="sortA0">↕</span></th>
                                        <th onclick="sortAdmin(1)" class="num">Inter<br>Hors Garde<br>26 <span id="sortA1">▼</span></th>
                                        <th onclick="sortAdmin(2)" class="num" style="color:var(--muted)">Inter<br>Hors Garde<br>25 <span id="sortA2">↕</span></th>
                                        <th onclick="sortAdmin(3)" class="num">Inter<br>En Garde<br>26 <span id="sortA3">↕</span></th>
                                        <th onclick="sortAdmin(4)" class="num" style="color:var(--muted)">Inter<br>En Garde<br>25 <span id="sortA4">↕</span></th>
                                        <th onclick="sortAdmin(5)" class="num">Astreinte<br>26 <span id="sortA5">↕</span></th>
                                        <th onclick="sortAdmin(6)" class="num" style="color:var(--muted)">Astreinte<br>25 <span id="sortA6">↕</span></th>
                                        <th onclick="sortAdmin(7)" class="num">Garde<br>26 <span id="sortA7">↕</span></th>
                                        <th onclick="sortAdmin(8)" class="num" style="color:var(--muted)">Garde<br>25 <span id="sortA8">↕</span></th>
                                    </tr></thead>
                                    <tbody id="adminTbody"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="adminRight">
                            <div class="table-title">Taux sollicitation</div>
                            <div class="admin-scroll">
                                <table><thead><tr><th>Nom</th><th>Taux</th></tr></thead><tbody id="adminSollTbody"></tbody></table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fenêtres CIS et Secteurs après -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px;">
                        <div class="panel"><div class="panelHead">Interventions par CIS (décroissant)</div><div class="panelScrollWrapper" style="max-height:250px;"><table id="tableAdminCis"><thead><tr><th>CIS</th><th class="num">2026</th><th class="num">2025 (Date)</th><th class="num">2025 (Total)</th></tr></thead><tbody></tbody></table></div></div>
                        <div class="panel"><div class="panelHead">Interventions par Secteur (décroissant)</div><div class="panelScrollWrapper" style="max-height:250px;"><table id="tableAdminSect"><thead><tr><th>Secteur</th><th class="num">2026</th><th class="num">2025 (Date)</th><th class="num">2025 (Total)</th></tr></thead><tbody></tbody></table></div></div>
                    </div>
                </div>
                </div>
            </div>
        </div>
      </div>

      <div id="viewChefferie" class="view">
          <div class="topbar" style="flex-shrink:0;"><button class="btnGo" style="width:auto;margin:0" onclick="goHome()">← Retour Dashboard</button><h1 style="display:inline-block;margin-left:15px;">Espace Chefferie ISP</h1></div>
          
          <div class="btn-row" style="flex-shrink:0;">
              <button class="c-btn" onclick="loadChefCase('app_isp');hideGlobal()">
                  <h3>Faire APP Chefferie <span class="badgeBtn" id="btnBadgeIspG">0</span></h3>
                  <p>Côter les BPV après passage ISP d'analyse</p>
              </button>
              <button class="c-btn" onclick="loadChefCase('med_chef');hideGlobal()">
                  <h3>Analyse médecin cheffe <span class="badgeBtn red" id="btnBadgeIspR">0</span></h3>
                  <p>Analyser les erreurs graves et proposer des actions</p>
              </button>
              <button class="c-btn" onclick="loadGlobalList()">
                  <h3>Voir données APP</h3>
                  <p>Voir le récap' des résultats et les BPV de chaque ISP</p>
              </button>
          </div>

          <div style="overflow-y:auto; flex:1; padding:20px;">
              <div id="chefFormArea" style="display:block;"></div>
              
              <div id="globalListArea" style="display:none;">
                  <div class="panel">
                      <div class="panelBody" style="max-height:none;overflow:visible;">
                          <div style="display:flex;gap:15px;align-items:center;padding:10px;background:rgba(255,255,255,0.05);margin-bottom:10px;border-radius:8px;font-size:11px;">
                              <div style="flex:0 0 auto;">Cliquez sur un ISP pour voir ses fiches.</div>
                              <button class="btnGo" style="width:auto;padding:6px 12px;font-size:11px;" onclick="loadAllGraveErrors()">Voir toutes les fiches</button>
                          </div>
                          <table id="globalTable">
                              <thead><tr>
                                  <th onclick="sortGlobal(0)">Nom ISP <span id="sortIcon0">↕</span></th>
                                  <th onclick="sortGlobal(1)">Bilan OK <span id="sortIcon1">↕</span></th>
                                  <th onclick="sortGlobal(2)">Pisu OK <span id="sortIcon2">↕</span></th>
                                  <th onclick="sortGlobal(3)">Erreur Bilan Lég. <span id="sortIcon3">↕</span></th>
                                  <th onclick="sortGlobal(4)">Erreur Pisu Lég. <span id="sortIcon4">↕</span></th>
                                  <th onclick="sortGlobal(5)">Erreur Grave <span id="sortIcon5">↕</span></th>
                              </tr></thead>
                              <tbody id="globalTbody"></tbody>
                          </table>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <div id="viewMedecin" class="view">
          <div class="topbar"><button class="btnGo" style="width:auto;margin:0" onclick="goHome()">← Retour Dashboard</button><h1 style="display:inline-block;margin-left:15px;">Espace Médecin Cheffe</h1></div>
          <div id="medFormArea" style="height:85vh;margin-top:20px;"></div>
      </div>
    </main>
  </div>

  <!-- VUE APP -->
  <div class="appContainer" id="appView">
    <header>
      <div class="brand">
        <div class="logo" title="Retour accueil" onclick="closeAppView()"></div>
        <h1>APP par ISP</h1>
      </div>
      <div class="rightHead">
        <div class="pill" id="statusPill">Chargement…</div>
        <button class="btnTop" onclick="loadNext(currentAppRow)">Recharger</button>
        <button class="btnTop" onclick="closeAppView()">Accueil</button>
      </div>
    </header>

    <div class="wrap">
      <div class="leftCol">
        <div class="card">
            <div class="cardHead">
            <div class="interInfos">
                <div class="interItem"><span class="interLabel">Intervention</span><span class="interVal" id="iNum">—</span></div>
                <div class="interItem"><span class="interLabel">Date</span><span class="interVal" id="iDate">—</span></div>
                <div class="interItem"><span class="interLabel">Infirmier</span><span class="interVal highlight" id="iInf">—</span></div>
                <div class="interItem"><span class="interLabel">Centre</span><span class="interVal" id="iCis">—</span></div>
                <div class="interItem"><span class="interLabel">Motif</span><span class="interVal" id="iMotif">—</span></div>
                <div class="interItem"><span class="interLabel">Engin</span><span class="interVal" id="iEngin">—</span></div>
            </div>
            </div>
            <div class="pdfBox">
            <iframe id="pdfFrame" src=""></iframe>
            <div id="pdfPlaceholder" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:var(--muted);">Chargement PDF...</div>
            </div>
            <div style="padding:4px; text-align:center; border-top:1px solid var(--border); background:rgba(0,0,0,0.3); font-size:10px;">
            <a id="openPdfLink" href="#" target="_blank" style="color:var(--accent); text-decoration:none;">Ouvrir dans Drive ↗</a> 
            <span class="pill" id="remainingPill" style="margin-left:10px; font-size:9px; padding:2px 6px;">Reste : —</span>
            </div>
        </div>
      </div>

      <div class="rightCol">
        <div class="card">
            <div class="form" id="mainForm">
            
            <div class="group" style="padding:6px;">
                <div style="display:flex;align-items:center;gap:10px;">
                    <label style="margin:0;">ISP Analyse :</label>
                    <select id="ispSelect" style="flex:1;"><option value="">Chargement...</option></select>
                </div>
            </div>

            <div class="group">
                <div class="groupTitle">Protocoles</div>
                <div style="margin-bottom:2px;font-size:10px;color:var(--muted);font-weight:700;">Adultes</div>
                <div class="grid-checks" id="protoAdultBox"></div>
                <div style="margin:6px 0 2px;font-size:10px;color:var(--muted);font-weight:700;border-top:1px solid rgba(255,255,255,.05);padding-top:4px;">Pédiatriques</div>
                <div class="grid-checks" id="protoPediaBox"></div>
            </div>

            <div class="group">
                <div class="groupTitle">Critères</div>
                <div class="grid-selects">
                    <div><label id="lblAx">AKIM</label><select id="selAx"></select></div>
                    <div><label id="lblAy">SMUR</label><select id="selAy"></select></div>
                    <div><label id="lblAz">CCMU</label><select id="selAz"></select></div>
                    <div><label id="lblBa">DEVENIR</label><select id="selBa"></select></div>
                </div>
                <div class="row2Items">
                    <div><label id="lblBb">SOUSAN</label><select id="selBb"></select></div>
                    <div><label id="lblBc">NB VICTIMES</label><input type="text" id="txtBc"></div>
                </div>
                <div style="margin-top:8px;"><label id="lblBg">Examen clinique</label><select id="selBg"></select></div>
            </div>

            <div class="group">
                <div class="groupTitle">Résultat</div>
                <div style="margin-bottom:8px;">
                    <label class="cb"><input type="checkbox" id="chkBh"> <span id="lblBh">Absence / erreur commande PUI</span></label>
                </div>
                <div id="biBmBox" style="display:grid; grid-template-columns: 1fr 1fr; gap:6px; word-wrap:break-word; word-break:break-word;"></div>
            </div>

            <div class="group" id="motifContainer" style="display:none;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px;">
                    <div id="motifBilanDiv"><label>Motif bilan incomplet</label><textarea id="txtBn"></textarea></div>
                    <div id="motifPisuDiv"><label>Motif pisu pas ok</label><textarea id="txtBo"></textarea></div>
                </div>
            </div>

            <div class="group" style="border-color: rgba(255,107,107,.3); padding:4px;">
                <label class="cb red" style="margin:0;">
                    <input type="checkbox" id="pbCheck" class="danger-cb">
                    Signaler un problème à Brice
                </label>
                <div id="pbDetails" style="margin-top:4px; display:none;">
                    <input type="text" id="pbTxt" placeholder="Précisez..." style="width:100%;">
                </div>
            </div>

            <div class="actions">
                <button class="btn ok" id="sendBtn" onclick="sendApp()">Envoyer et Clôturer</button>
                <button class="btn warn" id="skipBtn" onclick="skipApp()">Ignorer</button>
            </div>
            </div>
        </div>
      </div>
    </div>
  </div>

  <div id="modalDetail" class="modalOverlay" style="z-index:20000;">
    <div class="modalCard" style="width:95%; max-width:1600px; height:98vh;">
      <div class="modalHead">
        <span>Détail de l'intervention</span>
        <button class="closeBtn" onclick="closeModal('modalDetail')">×</button>
      </div>
      <div class="modalBody" style="display:flex; gap:0;">
        <iframe id="modalPdf" style="flex:2.5; border:0; background:#000;"></iframe>
        <div id="modalPdfInfo" style="flex:1; min-width:350px; background:#1a2245; padding:20px; border-left:1px solid var(--border); overflow-y:auto; display:flex; flex-direction:column; gap:15px;">
          <h4 style="color:var(--accent3);margin:0 0 15px 0;">Informations</h4>
          <div style="display:flex;flex-direction:column;gap:12px;font-size:13px;">
            <div><span style="color:var(--muted);font-size:11px;">N° Intervention</span><br><b id="detailId" style="font-size:15px;color:#fff;"></b></div>
            <div><span style="color:var(--muted);font-size:11px;">Date</span><br><b id="detailDate"></b></div>
            <div><span style="color:var(--muted);font-size:11px;">Statut</span><br><b id="detailCentre"></b></div>
            <div><span style="color:var(--muted);font-size:11px;">Motif d'intervention</span><br><b id="detailMotif"></b></div>
            <div><span style="color:var(--muted);font-size:11px;">Engin</span><br><b id="detailEngin"></b></div>
          </div>
          <h4 style="color:var(--accent3);margin:15px 0 10px 0;">Commentaire Chefferie</h4>
          <div id="commChef" class="static-box"></div>
          <div id="blockMed" style="display:none;">
            <h4 style="color:var(--red);margin:15px 0 10px 0;">Analyse Médecin</h4>
            <div id="commMed" class="static-box" style="color:var(--red);"></div>
          </div>
          <button class="btnGo" style="margin-top:auto;width:100%;" onclick="closeModal('modalDetail')">Fermer</button>
        </div>
      </div>
    </div>
  </div>
  
  <div id="modalList" class="modalOverlay" style="z-index:15000;"><div class="modalCard" style="max-width:800px;height:80vh;"><div class="modalHead"><span id="modalListTitle">Liste des dossiers</span><button class="closeBtn" onclick="closeModal('modalList')">×</button></div>
      <div style="padding:15px;border-bottom:1px solid var(--border);display:flex;gap:15px;flex-wrap:wrap;background:rgba(0,0,0,0.3);" id="filterBox">
          <label><input type="checkbox" checked onchange="filterDetails()" value="Bilan OK"> Bilan OK</label>
          <label><input type="checkbox" checked onchange="filterDetails()" value="Pisu OK"> Pisu OK</label>
          <label><input type="checkbox" checked onchange="filterDetails()" value="Erreur Bilan Légère"> Erreur Bilan Lég.</label>
          <label><input type="checkbox" checked onchange="filterDetails()" value="Erreur Pisu Légère"> Erreur Pisu Lég.</label>
          <label><input type="checkbox" checked onchange="filterDetails()" value="Erreur Grave"> Erreur Grave</label>
      </div>
      <div class="modalBody" id="modalListContent" style="display:block;padding:0;overflow-y:auto;flex-direction:column;"></div>
  </div></div>

  <div class="toast" id="toast"></div>

  <script>
    // === VARIABLES GLOBALES ===
    let currentAppRow = null;
    let isAppSubmitting = false;
    let currentAppRowNumber = null;

    // --- CORE FUNCTIONS ---
    const lFill=document.getElementById("loadFill"), lPct=document.getElementById("loadPct");
    let loadInt;
    function startLoad(){ document.getElementById("loadingBox").style.display="flex"; let w=0; loadInt=setInterval(()=>{ if(w<90)w+=5; lFill.style.width=w+"%"; lPct.textContent=Math.floor(w)+"%"; },100); }
    function stopLoad(){ clearInterval(loadInt); lFill.style.width="100%"; lPct.textContent="100%"; setTimeout(()=>{ document.getElementById("loadingBox").style.display="none"; lFill.style.width="0"; },300); }
    function toast(m){ const t=document.getElementById("toast"); t.textContent=m; t.style.display="block"; setTimeout(()=>t.style.display="none",3000); }
    function goHome(){ document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); document.getElementById('viewDashboard').classList.add('active'); }
    function setText(id,v){ const e=document.getElementById(id); if(e) e.textContent=(v==null?"-":v); }
    function getTrendHtml(a,b){ const v1=parseFloat(a)||0, v2=parseFloat(b)||0; if(v2===0 && v1>0) return '<span class="trendUp">▲</span>'; if(v1>v2) return '<span class="trendUp">▲</span>'; if(v1<v2) return '<span class="trendDown">▼</span>'; return '<span class="trendEq">=</span>'; }
    document.getElementById('dobInput').addEventListener('input', function(e){ if(e.inputType!="deleteContentBackward"){ let v=this.value; if(v.length==2||v.length==5) this.value=v+'/'; } });

    function updateCacheDisplay() {
        google.script.run.withSuccessHandler(status => {
            if(status) {
                document.getElementById("cacheTime").textContent = "Mise en cache: " + status;
            }
        }).getCacheStatus();
    }

    // --- INIT ---
    window.onload = () => {
        startLoad();
        google.script.run.withSuccessHandler(d => {
            stopLoad();
            if(d.error){ toast("Erreur: "+d.error); return; }
            setText("cutoffDateBig", d.date);
            setText("cutoffCompPsud", d.date);
            setText("cutoffCompSect", d.date);
            setText("cutoffCompTotal", d.date);
            setText("cutoffCompAst", d.date);
            setText("psud2026", d.psud); setText("total2026", d.total);
            setText("secteur2026", d.sect); setText("hrs2026", d.ast+" h");
            
            document.querySelector("#tableCis tbody").innerHTML = (d.cis||[]).map(x=>`<tr id="cis_${x.name}"><td>${x.name}</td><td class="num">${x.v26}</td><td class="num v25">...</td><td class="num" style="color:gray">${x.v25tot}</td></tr>`).join('');
            document.querySelector("#tableSect tbody").innerHTML = (d.secteurs||[]).map(x=>`<tr id="sect_${x.name}"><td>${x.name}</td><td class="num">${x.v26}</td><td class="num v25">...</td><td class="num" style="color:gray">${x.v25tot}</td></tr>`).join('');
            
            setText("cntAppBadge", d.cntApp||0); setText("cntIspGBadge", d.cntIspG||0); setText("cntIspRBadge", d.cntIspR||0); setText("cntMedBadge", d.cntMed||0);
            setText("btnBadgeIspG", d.cntIspG||0); setText("btnBadgeIspR", d.cntIspR||0);

            // 2025 (Deferred)
            const l25 = document.getElementById("loadingBox25"), f25=document.getElementById("loadFill25"), p25=document.getElementById("loadPct25");
            l25.style.display="flex"; let w25=0; const i25 = setInterval(()=>{ if(w25<90)w25+=5; f25.style.width=w25+"%"; p25.textContent=w25+"%"; },100);

            google.script.run.withSuccessHandler(d25 => {
                clearInterval(i25); f25.style.width="100%"; p25.textContent="100%"; setTimeout(()=>l25.style.display="none",300);

                document.getElementById("cacheTime").textContent = "Mise en cache: " + (d25.cacheTime || "N/A");
                document.getElementById("psud2025Badge").innerHTML = `${d25.psud} ${getTrendHtml(d.psud, d25.psud)}`;
                document.getElementById("sect2025Badge").innerHTML = `${d25.sect} ${getTrendHtml(d.sect, d25.sect)}`;
                document.getElementById("total2025Badge").innerHTML = `${d25.total} ${getTrendHtml(d.total, d25.total)}`;
                document.getElementById("hrs2025Badge").innerHTML = `${d25.ast} h ${getTrendHtml(d.ast, d25.ast)}`;
                for(let k in d25.cisMap) { const row = document.getElementById("cis_"+k); if(row) row.querySelector(".v25").textContent = d25.cisMap[k]; }
                for(let k in d25.sectMap) { const row = document.getElementById("sect_"+k); if(row) row.querySelector(".v25").textContent = d25.sectMap[k]; }

                google.script.run.preCacheAllData();
                let cacheInt = setInterval(() => {
                    updateCacheDisplay();
                }, 500);
                setTimeout(() => clearInterval(cacheInt), 60000);

            }).getStats2025();

        }).getStats2026();
        
        // Gestion flèche scroll
        const checkScroll = () => {
            const scrollArrow = document.getElementById('scrollArrow');
            const mainEl = document.querySelector('.main');
            if (!scrollArrow || !mainEl) return;
            const scrolled = mainEl.scrollTop;
            const windowHeight = mainEl.clientHeight;
            const docHeight = mainEl.scrollHeight;
            const isAtBottom = (scrolled + windowHeight) >= (docHeight - 50);
            
            if (docHeight > windowHeight && !isAtBottom) {
                scrollArrow.style.display = 'flex';
            } else {
                scrollArrow.style.display = 'none';
            }
        };
        
        const mainEl = document.querySelector('.main');
        if(mainEl) {
            mainEl.addEventListener('scroll', checkScroll);
            window.addEventListener('resize', checkScroll);
            setTimeout(() => {
                checkScroll();
                setInterval(checkScroll, 2000);
            }, 2000);
        }
    };

    function askPass(target) {
        const p=prompt("Mot de passe :");
        if(p==="0007"){
            document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
            if(target==='chef') document.getElementById('viewChefferie').classList.add('active');
            if(target==='med') { document.getElementById('viewMedecin').classList.add('active'); loadChefCase('med_chef'); }
        } else toast("Erreur");
    }

    // === APP VIEW ===
    function openAppView() {
      const pwd = prompt("Mot de passe :");
      if(pwd !== "APP66") { alert("Code incorrect"); return; }
      document.getElementById('viewContainer').style.display='none';
      document.getElementById('appView').classList.add('active');
      loadNext();
    }

    function closeAppView() {
      document.getElementById('appView').classList.remove('active');
      document.getElementById('viewContainer').style.display='grid';
      goHome();
    }

    function setStatus(t){ document.getElementById("statusPill").textContent=t; }
    function extractDriveFileId(u){ if(!u)return ""; const m=String(u).match(/\/file\/d\/([^\/\?]+)/i); return (m&&m[1])?m[1]:""; }
    function buildPdfEmbed(u){ const id=extractDriveFileId(u); return id ? "https://drive.google.com/file/d/"+id+"/preview" : ""; }
    function setButtons(d){ ["sendBtn","skipBtn"].forEach(i=>document.getElementById(i).disabled=d); }

    document.getElementById("pbCheck").addEventListener("change", (e)=>{
       document.getElementById("pbDetails").style.display = e.target.checked ? "block" : "none";
    });

    function loadNext(specificRow){
      if(isAppSubmitting) return;
      setStatus("Recherche..."); setButtons(true);
      
      // Afficher loader
      document.getElementById("loadingBox").style.display="flex";
      let w=0; 
      const loadInt = setInterval(()=>{ 
          if(w<90) w+=5; 
          document.getElementById("loadFill").style.width=w+"%"; 
          document.getElementById("loadPct").textContent=Math.floor(w)+"%"; 
      }, 100);
      
      google.script.run.withSuccessHandler(res=>{
        clearInterval(loadInt);
        document.getElementById("loadFill").style.width="100%";
        document.getElementById("loadPct").textContent="100%";
        setTimeout(()=>document.getElementById("loadingBox").style.display="none", 300);
        
        setButtons(false);
        document.getElementById("remainingPill").textContent = "Reste : "+(res.remaining||0);

        if(res.done){
          setStatus("Terminé"); 
          toast(res.message);
          document.getElementById("mainForm").innerHTML = `<div style="text-align:center;color:var(--muted);margin-top:50px;">${res.message}</div>`;
          document.getElementById("pdfFrame").src="";
          return;
        }

        currentAppRow = res.rowNumber;
        currentAppRowNumber = res.rowNumber;
        setStatus("Fiche prête");
        
        const info = res.info;
        setText("iNum", info.interId);
        setText("iDate", info.date);
        setText("iInf", info.infName);
        setText("iCis", info.cis);
        setText("iMotif", info.motif);
        setText("iEngin", info.engin);

        const pdfUrl = buildPdfEmbed(res.url);
        document.getElementById("pdfFrame").src = pdfUrl; 
        document.getElementById("openPdfLink").href = res.url || "#";
        document.getElementById("pdfPlaceholder").style.display = pdfUrl ? "none" : "block";

        renderForm(res.schema, res.ispList);

      }).withFailureHandler(err=>{ 
        clearInterval(loadInt);
        document.getElementById("loadingBox").style.display="none";
        setStatus("Erreur"); toast(err.message,"err"); setButtons(false); 
      }).getNextCase(specificRow);
    }

    function renderForm(schema, ispList) {
       fillSelect("ispSelect", ispList, schema.ispVal);

       const mkCb = (boxId, items) => {
         const box = document.getElementById(boxId);
         box.innerHTML = "";
         if (!items || !Array.isArray(items)) return;
         items.forEach(item => {
            const lbl = document.createElement("label");
            lbl.className = "cb";
            if(item.color === "ok") {
              lbl.style.borderColor = "rgba(71,209,140,.3)";
              lbl.style.color = "var(--ok)";
            } else if(item.color === "orange") {
              lbl.style.borderColor = "rgba(255,165,0,.3)";
              lbl.style.color = "#ff8c00";
            }
            lbl.innerHTML = `<input type="checkbox" name="chk_${item.id}" ${item.checked?'checked':''}> ${item.label}`;
            box.appendChild(lbl);
         });
       };

       mkCb("protoAdultBox", schema.protoAdult || []);
       mkCb("protoPediaBox", schema.protoPedia || []);
       
       const c = schema.criteres;
       fillSelect("selAx", c.ax.opts, c.ax.val); document.getElementById("lblAx").textContent = c.ax.label;
       fillSelect("selAy", c.ay.opts, c.ay.val); document.getElementById("lblAy").textContent = c.ay.label;
       fillSelect("selAz", c.az.opts, c.az.val); document.getElementById("lblAz").textContent = c.az.label;
       fillSelect("selBa", c.ba.opts, c.ba.val); document.getElementById("lblBa").textContent = c.ba.label;
       fillSelect("selBb", c.bb.opts, c.bb.val); document.getElementById("lblBb").textContent = c.bb.label;
       
       document.getElementById("lblBc").textContent = c.bc.label;
       document.getElementById("txtBc").value = c.bc.val;
       
       fillSelect("selBg", c.bg.opts, c.bg.val); document.getElementById("lblBg").textContent = c.bg.label;

       const r = schema.resultats;
       
       document.getElementById("lblBh").textContent = r.bh.label;
       document.getElementById("chkBh").checked = r.bh.checked;

       mkCb("biBmBox", r.checksBiBm);

       document.getElementById("txtBn").value = schema.fieldBn.val;
       document.getElementById("txtBo").value = schema.fieldBo.val;

       const pbCb = document.getElementById("pbCheck");
       pbCb.checked = !!schema.pbCheck;
       document.getElementById("pbTxt").value = schema.pbTxt; 
       document.getElementById("pbDetails").style.display = schema.pbCheck ? "block" : "none";

       // Ajouter logique conditionnelle pour afficher/masquer les motifs
       updateMotifVisibility();
       
       // Ajouter event listeners sur les checkboxes du résultat
       const checkboxes = document.querySelectorAll('#biBmBox input[type="checkbox"]');
       checkboxes.forEach(cb => {
           cb.addEventListener('change', updateMotifVisibility);
       });
    }

    function updateMotifVisibility() {
       // Récupérer les checkboxes de biBmBox
       const checkboxes = document.querySelectorAll('#biBmBox input[type="checkbox"]');
       let hasBilanIncomplet = false;
       let hasPisuPasOk = false;
       
       checkboxes.forEach(cb => {
           const label = cb.nextElementSibling ? cb.nextElementSibling.textContent : '';
           if(label && label.toLowerCase().includes('bilan')) {
               if(cb.checked) hasBilanIncomplet = true;
           }
           if(label && label.toLowerCase().includes('pisu')) {
               if(cb.checked) hasPisuPasOk = true;
           }
       });
       
       // Afficher/masquer le conteneur des motifs
       const motifContainer = document.getElementById("motifContainer");
       if(hasBilanIncomplet || hasPisuPasOk) {
           motifContainer.style.display = "block";
       } else {
           motifContainer.style.display = "none";
       }
       
       // Afficher/masquer les motifs individuels
       const motifBilanDiv = document.getElementById("motifBilanDiv");
       const motifPisuDiv = document.getElementById("motifPisuDiv");
       if(motifBilanDiv) motifBilanDiv.style.display = hasBilanIncomplet ? "block" : "none";
       if(motifPisuDiv) motifPisuDiv.style.display = hasPisuPasOk ? "block" : "none";
    }

    function fillSelect(id, opts, currentVal) {
       const s = document.getElementById(id);
       s.innerHTML = '<option value="">—</option>';
       if(opts) {
           opts.forEach(o => {
               const op = document.createElement("option");
               op.value = o; op.textContent = o;
               if(String(o) === String(currentVal)) op.selected = true;
               s.appendChild(op);
           });
       }
    }

    function sendApp(){
      if(!currentAppRow){ toast("Erreur: aucune fiche","err"); return; }
      const isp = document.getElementById("ispSelect").value;
      if(!isp) { toast("Veuillez sélectionner l'ISP Analyse","err"); return; }

      isAppSubmitting = true;
      setStatus("Enregistrement..."); setButtons(true);

      const checks = {};
      document.querySelectorAll('input[type="checkbox"][name^="chk_"]').forEach(cb => {
         const id = cb.name.split('_')[1];
         checks[id] = cb.checked;
      });

      const payload = {
         rowNumber: currentAppRowNumber,
         isp: isp,
         checks: checks,
         criteres: {
            ax: document.getElementById("selAx").value,
            ay: document.getElementById("selAy").value,
            az: document.getElementById("selAz").value,
            ba: document.getElementById("selBa").value,
            bb: document.getElementById("selBb").value,
            bc: document.getElementById("txtBc").value
         },
         resultats: {
            bg: document.getElementById("selBg").value,
            bh: document.getElementById("chkBh").checked
         },
         txtBn: document.getElementById("txtBn").value,
         txtBo: document.getElementById("txtBo").value,
         pbCheck: document.getElementById("pbCheck").checked,
         pbTxt: document.getElementById("pbTxt").value
      };

      google.script.run.withSuccessHandler(()=>{ 
          isAppSubmitting = false;
          setStatus("Sauvegardé"); 
          toast("Enregistré et Clôturé ✅"); 
          loadNext(); 
      })
      .withFailureHandler(e=>{ 
          isAppSubmitting = false;
          setStatus("Erreur"); 
          toast(e.message,"err"); 
          setButtons(false); 
      }).saveCase(payload);
    }

    function skipApp(){ 
        if(!currentAppRow) return; 
        currentAppRow = null;
        loadNext(); 
    }

    // ISP
    let window_currentIspData = {};
    function loginIsp() {
        const m=document.getElementById("matInput").value, d=document.getElementById("dobInput").value;
        if(!m||!d) { toast("Infos manquantes"); return; }
        document.getElementById("ispLoadBox").style.display="inline-block";
        let w=0; const i=setInterval(()=>{ if(w<90) w+=10; document.getElementById("ispFill").style.width=w+"%"; document.getElementById("ispPct").textContent=w+"%"; }, 100);
        google.script.run.withSuccessHandler(res => {
            clearInterval(i); document.getElementById("ispFill").style.width="100%"; document.getElementById("ispPct").textContent="100%";
            setTimeout(()=>document.getElementById("ispLoadBox").style.display="none", 300);
            if(res.error) { toast(res.error); return; }
            document.getElementById("ispLogin").style.display="none";
            document.getElementById("ispData").style.display="block";
            document.getElementById("ispNameDisplay").textContent = res.nom;
            
            setText("ispAst26", Math.ceil(res.astreinte2026)); setText("ispAst25Ytd", Math.ceil(res.astreinte2025_ytd)); setText("ispAst25Tot", res.astreinte2025_tot);
            document.getElementById("ispAstTrend").innerHTML = getTrendHtml(res.astreinte2026, res.astreinte2025_ytd);
            setText("ispGarde26", Math.ceil(res.garde2026)); setText("ispGarde25Ytd", Math.ceil(res.garde2025_ytd)); setText("ispGarde25Tot", res.garde2025_tot);
            document.getElementById("ispGardeTrend").innerHTML = getTrendHtml(res.garde2026, res.garde2025_ytd);
            setText("ispInter26", res.inter2026); setText("ispInter25Ytd", res.inter2025_ytd); setText("ispInter25Tot", res.inter2025_tot);
            document.getElementById("ispInterTrend").innerHTML = getTrendHtml(res.inter2026, res.inter2025_ytd);
            
            setText("ispOk", (res.okList||[]).length);
            setText("ispErrBil", (res.errLegereBilan||[]).length); setText("ispErrPisu", (res.errLegerePisu||[]).length); setText("ispErrLourd", (res.errLourde||[]).length);
            window_currentIspData = res;
        }).getIspStats(m, d);
    }
    function logoutIsp(){ document.getElementById("ispData").style.display="none"; document.getElementById("ispLogin").style.display="flex"; window_currentIspData={}; }

    function openErrorList(type) {
        if(!window_currentIspData || !window_currentIspData.nom) return;
        let list = [];
        let filterValue = "";
        
        if(type==='OK') { list = window_currentIspData.okList || []; filterValue = "Bilan OK"; }
        else if(type==='Bilan') { list = window_currentIspData.errLegereBilan || []; filterValue = "Erreur Bilan Légère"; }
        else if(type==='Pisu') { list = window_currentIspData.errLegerePisu || []; filterValue = "Erreur Pisu Légère"; }
        else { list = window_currentIspData.errLourde || []; filterValue = "Erreur Grave"; }
        
        // Remplir currentDetailList et initialiser les checkboxes
        currentDetailList = list;
        document.querySelectorAll('#filterBox input[type="checkbox"]').forEach(cb => {
            cb.checked = cb.value === filterValue;
        });
        
        document.getElementById("modalListTitle").textContent = `Dossiers de ${window_currentIspData.nom}`;
        filterDetails();
        document.getElementById("modalList").style.display="flex";
    }

    // ADMIN
    let adminDataCache = [], adminSortDir = -1, adminSortCol = 1;
    function loadAdmin() {
        if(document.getElementById("adminPwd").value!=="0007") { toast("Erreur code"); return; }
        
        document.getElementById("adminLogin").style.display="none";
        document.getElementById("adminLoadBox").style.display="inline-block";
        
        let w=0; 
        const i=setInterval(()=>{ 
            if(w<90) w+=8; 
            document.getElementById("adminFill").style.width=w+"%"; 
            document.getElementById("adminPct").textContent=w+"%"; 
        }, 120);
        
        google.script.run.withSuccessHandler(res => {
            clearInterval(i); 
            document.getElementById("adminFill").style.width="100%"; 
            document.getElementById("adminPct").textContent="100%";
            setTimeout(()=> { 
                document.getElementById("adminLoadBox").style.display="none"; 
                document.getElementById("adminData").style.display="block"; 
            }, 300);
            
            adminDataCache = res.activity.map(a => ({ 0:a.nom, 1:a.interHg26, 2:a.interHg25, 3:a.interG26, 4:a.interG25, 5:a.hAst26, 6:a.hAst25, 7:a.hGarde26, 8:a.hGarde25 }));
            renderAdminTable();
            document.getElementById("adminSollTbody").innerHTML = res.sollicitation.map(s => `<tr><td>${s.nom}</td><td class="num"><b>${s.tx}</b></td></tr>`).join('');
            
            // Remplir tableaux CIS et Secteurs depuis getStats2025() pour avoir les bonnes données YTD
            google.script.run.withSuccessHandler(stats25 => {
                // Récupérer les comptages 2025 YTD depuis cisMap et sectMap
                const cisNames = Object.keys(stats25.cisMap || {});
                const sectNames = Object.keys(stats25.sectMap || {});
                
                // Récupérer aussi les totaux 2026 et 2025 total depuis getStats2026
                google.script.run.withSuccessHandler(stats26 => {
                    // Combiner les données: cisMap pour 2025 YTD, cis array pour 2026 et 2025 total
                    const cisData = (stats26.cis || []).map(x => ({
                        name: x.name,
                        v26: x.v26,
                        v25ytd: stats25.cisMap[x.name] || 0,
                        v25tot: x.v25tot
                    }));
                    const sectData = (stats26.secteurs || []).map(x => ({
                        name: x.name,
                        v26: x.v26,
                        v25ytd: stats25.sectMap[x.name] || 0,
                        v25tot: x.v25tot
                    }));
                    
                    // Trier par 2026 décroissant
                    const cisSorted = cisData.sort((a,b) => b.v26 - a.v26);
                    const sectSorted = sectData.sort((a,b) => b.v26 - a.v26);
                    
                    document.querySelector("#tableAdminCis tbody").innerHTML = cisSorted.map(x => `<tr><td>${x.name}</td><td class="num"><b>${x.v26}</b></td><td class="num" style="color:gray">${x.v25ytd}</td><td class="num" style="color:gray">${x.v25tot}</td></tr>`).join('');
                    document.querySelector("#tableAdminSect tbody").innerHTML = sectSorted.map(x => `<tr><td>${x.name}</td><td class="num"><b>${x.v26}</b></td><td class="num" style="color:gray">${x.v25ytd}</td><td class="num" style="color:gray">${x.v25tot}</td></tr>`).join('');
                }).getStats2026();
            }).getStats2025();
        }).withFailureHandler(e => {
            clearInterval(i);
            toast("Erreur: " + e.message);
            document.getElementById("adminLoadBox").style.display="none";
            document.getElementById("adminLogin").style.display="flex";
        }).getAdminData("0007");
    }
    
    function renderAdminTable() {
        document.getElementById("adminTbody").innerHTML = adminDataCache.map(r => `<tr><td><b>${r[0]}</b></td><td class="num"><b>${r[1]}</b></td><td class="num" style="color:gray">${r[2]}</td><td class="num"><b>${r[3]}</b></td><td class="num" style="color:gray">${r[4]}</td><td class="num"><b>${Math.ceil(r[5])}</b></td><td class="num" style="color:gray">${Math.ceil(r[6])}</td><td class="num"><b>${Math.ceil(r[7])}</b></td><td class="num" style="color:gray">${Math.ceil(r[8])}</td></tr>`).join('');
    }
    
    function sortAdmin(colIdx) {
        if(adminSortCol === colIdx) adminSortDir *= -1; else { adminSortCol = colIdx; adminSortDir = colIdx===0?1:-1; }
        adminDataCache.sort((a,b) => { let v1=a[colIdx], v2=b[colIdx]; if(typeof v1==='string'){v1=v1.toLowerCase();v2=v2.toLowerCase();} if(v1>v2)return adminSortDir; if(v1<v2)return -adminSortDir; return 0; });
        for(let i=0; i<9; i++) document.getElementById("sortA"+i).textContent="↕";
        document.getElementById("sortA"+colIdx).textContent = adminSortDir===1 ? "▲" : "▼";
        renderAdminTable();
    }
    
    function filterAdmin() {
        const terms = document.getElementById("adminSearch").value.toLowerCase().split(';').map(t=>t.trim()).filter(t=>t);
        document.querySelectorAll("#adminTbody tr").forEach(r => {
            const txt = r.innerText.toLowerCase();
            r.style.display = (terms.length===0 || terms.some(t => txt.includes(t))) ? "" : "none";
        });
        document.querySelectorAll("#adminSollTbody tr").forEach(r => {
            const txt = r.innerText.toLowerCase();
            r.style.display = (terms.length===0 || terms.some(t => txt.includes(t))) ? "" : "none";
        });
    }

    // CHEFFERIE
    let currentSchema = null;
    function hideGlobal() { document.getElementById("globalListArea").style.display="none"; document.getElementById("chefFormArea").style.display="block"; }
    function loadChefCase(mode) {
        const area = (mode==='med_chef') ? 'medFormArea' : 'chefFormArea';
        document.getElementById(area).innerHTML = "<div style='text-align:center;padding:50px;color:gray'>Chargement...</div>";
        google.script.run.withSuccessHandler(res => {
            if(res.done) { document.getElementById(area).innerHTML = `<div style='text-align:center;padding:50px;color:var(--accent3)'>${res.message}</div>`; return; }
            currentSchema = res;
            renderChefForm(res, area);
        }).getChefferieNextCase(mode);
    }
    
    function renderChefForm(s, areaId) {
        const i = s.info;
        const html = `
        <div style="height:100%;">
            <div class="info-banner">
                <div class="info-banner-row"><span>N° Inter: <b>${i.interId}</b></span> <span>ISP: <b>${i.infName}</b></span></div>
                <div class="info-banner-row"><span>Motif: <b>${i.motif || '—'}</b></span> <span>${i.date}</span></div>
            </div>
            <div class="chef-layout">
                <div class="chef-pdf"><iframe src="${(i.pdf||'').replace('/view','/preview')}" style="width:100%;height:100%;border:0"></iframe></div>
                <div class="chef-form">
                    ${s.mode==='app_isp' ? `
                       <div><label>Commentaire ISP</label><div class="static-box">${i.commBN||"-"}</div></div>
                       <div><label>Checklist Qualité</label><div class="check-list">
                          ${s.checks.map((c,k) => {
                              let cls = ""; if(c.label.includes("OK")) cls="chk-green"; if(c.label.includes("KO")) cls="chk-red";
                              return `<div class="check-item ${cls}"><input type="checkbox" id="chk_${k}" name="check_${c.id}"> ${c.label}</div>`;
                          }).join('')}
                       </div></div>
                       <div><label>Commentaire Chefferie</label><textarea id="chefComm"></textarea></div>
                       <button class="btnGo" onclick="sendChef()">Valider</button>
                    ` : s.mode==='med_chef' ? `
                       <div><label>Analyse</label><div class="static-box">${i.motif||"-"}</div></div>
                       <div><label>Analyse Médecin</label><textarea id="medAnalyse"></textarea></div>
                       <div><label>Actions</label><textarea id="medAction"></textarea></div>
                       <button class="btnGo" onclick="sendChef()">Valider</button>
                    ` : `<div>Formulaire non défini</div>`}
                </div>
            </div>
        </div>`;
        document.getElementById(areaId).innerHTML = html;
    }
    
    function sendChef() {
        if(!currentSchema) return;
        const s = currentSchema;
        const payload = { mode:s.mode, info:s.info };
        if(s.mode==='app_isp') {
            payload.comment = document.getElementById("chefComm").value;
            if(!payload.comment) { toast("Commentaire requis"); return; }
            payload.checks = {};
            s.checks.forEach((c,k) => {
                const chk = document.getElementById("chk_"+k);
                if(chk) payload.checks[c.id] = chk.checked;
            });
        } else if(s.mode==='med_chef') {
            payload.analyse = document.getElementById("medAnalyse").value;
            payload.action = document.getElementById("medAction").value;
        }
        const areaId = (s.mode==='med_chef') ? 'medFormArea' : 'chefFormArea';
        document.getElementById(areaId).innerHTML = "<div style='text-align:center;padding:50px'>Enregistrement...</div>";
        google.script.run.withSuccessHandler(() => { toast("Enregistré"); loadChefCase(s.mode); }).saveChefferie(payload);
    }

    // LIST & SORT
    let globalList = [], currentDetailList = [], currentDetailIspName = "";
    let sortDir = 1;
    function loadGlobalList() {
        document.getElementById("chefFormArea").style.display="none";
        document.getElementById("globalListArea").style.display="block";
        startLoad();
        google.script.run.withSuccessHandler(res => {
            stopLoad();
            globalList = res;
            renderGlobalTable(res);
        }).getAllIspErrorStats();
    }
    
    function renderGlobalTable(data) {
        document.getElementById("globalTbody").innerHTML = data.map(r => `
          <tr onclick="loadIspDetail('${r.mat}', '${r.nom}')"><td><b>${r.nom}</b></td><td class="text-green">${r.bilanOk}</td><td class="text-green">${r.pisuOk}</td><td class="text-orange">${r.errBilL}</td><td class="text-orange">${r.errPisuL}</td><td class="text-red">${r.errGrave}</td></tr>
        `).join('');
    }
    
    function sortGlobal(idx) {
        sortDir *= -1;
        const keys = ['nom', 'bilanOk', 'pisuOk', 'errBilL', 'errPisuL', 'errGrave'];
        const k = keys[idx];
        globalList.sort((a,b) => { if(a[k]>b[k]) return sortDir; if(a[k]<b[k]) return -sortDir; return 0; });
        for(let i=0; i<6; i++) document.getElementById("sortIcon"+i).textContent="↕";
        document.getElementById("sortIcon"+idx).textContent = sortDir===1 ? "▼" : "▲";
        renderGlobalTable(globalList);
    }
    
    function loadIspDetail(mat, ispName) {
        currentDetailIspName = ispName || mat;
        startLoad();
        google.script.run.withSuccessHandler(list => {
            stopLoad();
            currentDetailList = list;
            document.querySelectorAll('#filterBox input[type="checkbox"]').forEach(cb => cb.checked = true);
            document.getElementById("modalListTitle").textContent = `Dossiers de ${ispName || mat}`;
            filterDetails();
            document.getElementById("modalList").style.display="flex";
        }).getIspDetailsAdmin(mat);
    }

    function loadAllGraveErrors() {
        startLoad();
        let allGraveList = [];
        let loaded = 0;
        let totalIsps = globalList.length;

        if(totalIsps === 0) { toast("Aucune donnée"); stopLoad(); return; }

        globalList.forEach(isp => {
            google.script.run.withSuccessHandler(list => {
                loaded++;
                const graveErrors = list.filter(x => x.errorType === "Erreur Grave");
                graveErrors.forEach(e => {
                    e.ispName = isp.nom;
                });
                allGraveList = allGraveList.concat(graveErrors);

                if(loaded === totalIsps) {
                    stopLoad();
                    currentDetailList = allGraveList;
                    document.querySelectorAll('#filterBox input[type="checkbox"]').forEach(cb => {
                        cb.checked = cb.value === "Erreur Grave";
                    });
                    document.getElementById("modalListTitle").textContent = "Toutes les fiches en erreur grave";
                    filterDetails();
                    document.getElementById("modalList").style.display="flex";
                }
            }).getIspDetailsAdmin(isp.mat);
        });
    }
    
    function filterDetails() {
        const filters = Array.from(document.querySelectorAll('input[type=checkbox]:checked')).map(c=>c.value);
        const c = document.getElementById("modalListContent"); 
        c.innerHTML="";
        const filtered = currentDetailList.filter(x => x.types.some(t => filters.includes(t)));
        if(filtered.length===0) c.innerHTML="<div style='padding:20px;text-align:center;color:gray'>Aucun dossier</div>";
        filtered.forEach(x => {
            // Créer les tags pour chaque type (peut être "Bilan OK", "Pisu OK", "Erreur Grave", etc.)
            const tagHtml = x.types.map(t => {
                let tagBg = "#47d18c", tagColor = "white";
                if(t.includes("Grave")) {
                    tagBg = "#d32f2f";
                    tagColor = "white";
                } else if(t.includes("Légère")) {
                    tagBg = "#ff9800";
                    tagColor = "white";
                }
                return `<span style="display:inline-block;padding:3px 8px;border-radius:3px;font-size:10px;font-weight:bold;background:${tagBg};color:${tagColor};margin-left:4px;">${t}</span>`;
            }).join('');
            const ispLabel = x.ispName ? `<div style="font-size:10px;color:var(--accent3);margin-top:4px;">ISP: <b>${x.ispName}</b></div>` : '';
            c.innerHTML += `
                <div class="detail-row" onclick="loadInterDetail('${x.id}', '${x.date || ''}', '${(x.motif || '').replace(/'/g, "\\'")}', '${x.status || ''}', '${x.centre || ''}', '${x.engin || ''}')" style="padding:12px;border-bottom:1px solid #333;cursor:pointer;">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
                        <div style="flex:1;">
                            <div style="font-weight:bold;color:#39ff14;font-size:13px;">Numéro d'intervention: ${x.id}</div>
                            <div style="font-size:10px;color:#aaa;margin-top:3px;">${x.date || '-'}</div>
                        </div>
                        <div style="margin-left:10px;">${tagHtml}</div>
                    </div>
                    <div style="font-size:12px;color:#ccc;margin-bottom:6px;"><b>${x.motif || '-'}</b></div>
                    <div style="font-size:10px;color:#888;">${x.status || '-'}</div>
                    <div style="font-size:10px;color:#888;">Engin: ${x.engin || '-'}</div>
                    ${ispLabel}
                    ${x.commChef ? `<div style="font-size:10px;color:var(--accent3);margin-top:4px;">Chef: ${x.commChef}</div>` : ''}
                    ${x.commMed ? `<div style="font-size:10px;color:var(--red);">Med: ${x.commMed}</div>` : ''}
                </div>
            `;
        });
    }
    
    function loadInterDetail(id, date, motif, status, centre, engin) {
        startLoad();
        google.script.run.withSuccessHandler(res => {
            stopLoad();
            document.getElementById("modalPdf").src = (res.pdfUrl||'').replace('/view','/preview');
            setText("detailId", id);
            setText("detailDate", date || "-");
            setText("detailCentre", status || "-");
            setText("detailMotif", motif || "-");
            setText("detailEngin", engin || res.engin || "-");
            document.getElementById("commChef").textContent = res.commentChefferie||"Aucun commentaire.";
            const m = document.getElementById("blockMed");
            if(res.analyseMed) { m.style.display="block"; document.getElementById("commMed").textContent=res.analyseMed; } else m.style.display="none";
            document.getElementById("modalDetail").style.display="flex";
        }).getInterventionDetails(id);
    }
    
    function closeModal(id){ document.getElementById(id).style.display="none"; }
  </script>
</body>
</html>
